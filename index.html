<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆贵金属预测技术工作室自研系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 苹果风格配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0071e3',
            success: '#34c759',
            danger: '#ff3b30',
            apple: {
              gray: '#86868b',
              light: '#f5f5f7',
              card: '#ffffff',
              border: '#e2e2e7'
            }
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
        }
      }
    }
  </script>
  
  <style>
    /* 图表容器确保显示 */
    .chart-container { height: 320px !important; width: 100% !important; }
    .mini-chart-container { height: 220px !important; width: 100% !important; }
    canvas { display: block !important; }
    
    /* 平滑曲线 */
    .smooth-line { tension: 0.4 !important; }
    
    /* 基础样式 */
    body { background: #f5f5f7 !important; color: #1d1d1f !important; }
  </style>
</head>

<body>
  <!-- 顶部导航 -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-apple-border">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <i class="fa fa-diamond text-primary mr-2"></i>
        <h1 class="font-semibold">聚宝盆贵金属预测技术工作室自研系统</h1>
      </div>
      <span id="system-time" class="text-apple-gray text-sm">加载中...</span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- 价格卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-white rounded-xl p-5 shadow-sm">
        <h2 class="text-apple-gray text-sm mb-2">黄金价格（元/克）</h2>
        <div class="text-3xl font-semibold mb-4" id="gold-price">772.05</div>
        <div class="flex justify-between text-sm">
          <span class="text-apple-gray">更新时间：<span id="gold-time">2025/7/23 10:30</span></span>
          <button id="refresh-gold" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
      
      <div class="bg-white rounded-xl p-5 shadow-sm">
        <h2 class="text-apple-gray text-sm mb-2">白银价格（元/克）</h2>
        <div class="text-3xl font-semibold mb-4" id="silver-price">8.78</div>
        <div class="flex justify-between text-sm">
          <span class="text-apple-gray">更新时间：<span id="silver-time">2025/7/23 10:30</span></span>
          <button id="refresh-silver" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
    </div>

    <!-- 黄金图表（分时上，K线下） -->
    <div class="bg-white rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-4">黄金价格图表</h2>
      <!-- 分时图 -->
      <div class="mini-chart-container mb-6">
        <canvas id="gold-line" class="smooth-line"></canvas>
      </div>
      <!-- K线图 -->
      <div class="chart-container">
        <canvas id="gold-candle"></canvas>
      </div>
    </div>

    <!-- 白银图表 -->
    <div class="bg-white rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-4">白银价格图表</h2>
      <!-- 分时图 -->
      <div class="mini-chart-container mb-6">
        <canvas id="silver-line" class="smooth-line"></canvas>
      </div>
      <!-- K线图 -->
      <div class="chart-container">
        <canvas id="silver-candle"></canvas>
      </div>
    </div>

    <!-- 操作建议 -->
    <div class="bg-white rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-4">操作建议</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-4 border border-apple-border rounded-lg">
          <h3 class="font-medium mb-3">黄金</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-apple-gray">建议</span><span>买入</span></div>
            <div class="flex justify-between"><span class="text-apple-gray">止盈</span><span class="text-success">787.49</span></div>
            <div class="flex justify-between"><span class="text-apple-gray">止损</span><span class="text-danger">756.61</span></div>
          </div>
        </div>
        <div class="p-4 border border-apple-border rounded-lg">
          <h3 class="font-medium mb-3">白银</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-apple-gray">建议</span><span>观望</span></div>
            <div class="flex justify-between"><span class="text-apple-gray">止盈</span><span class="text-success">8.95</span></div>
            <div class="flex justify-between"><span class="text-apple-gray">止损</span><span class="text-danger">8.60</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 历史预测表格（24行） -->
    <div class="bg-white rounded-xl p-5 shadow-sm">
      <h2 class="font-medium mb-4">历史预测记录</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-apple-light">
              <th class="px-4 py-2 text-left text-apple-gray">时间</th>
              <th class="px-4 py-2 text-left text-apple-gray">黄金建议</th>
              <th class="px-4 py-2 text-left text-apple-gray">黄金结果</th>
              <th class="px-4 py-2 text-left text-apple-gray">白银建议</th>
              <th class="px-4 py-2 text-left text-apple-gray">白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table">
            <!-- 24行数据将通过JS生成 -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <script>
    // 配置
    const HISTORY_API = "https://precious-metal-analyzer.aoyouios.workers.dev/history";
    const ADVICE_HISTORY_API = "https://precious-metal-analyzer.aoyouios.workers.dev/advice-history";
    let goldData = [], silverData = [];
    let goldLine, goldCandle, silverLine, silverCandle;

    // 1. 时间格式化
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleString('zh-CN', {
        month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
      });
    }

    // 2. 更新系统时间
    setInterval(() => {
      document.getElementById('system-time').textContent = new Date().toLocaleString();
    }, 1000);

    // 3. 获取历史数据
    async function fetchData() {
      try {
        // 获取价格历史数据
        const res = await fetch(HISTORY_API);
        const history = await res.json();
        goldData = history.gold || [];
        silverData = history.silver || [];
        
        // 补充模拟数据（确保图表有足够数据）
        if (goldData.length < 50) goldData = generateMockData('gold', 100, goldData);
        if (silverData.length < 50) silverData = generateMockData('silver', 100, silverData);
        
        // 更新价格显示
        const latestGold = goldData[goldData.length - 1];
        const latestSilver = silverData[silverData.length - 1];
        document.getElementById('gold-price').textContent = latestGold.c.toFixed(2);
        document.getElementById('silver-price').textContent = latestSilver.c.toFixed(2);
        document.getElementById('gold-time').textContent = formatTime(latestGold.t);
        document.getElementById('silver-time').textContent = formatTime(latestSilver.t);
        
        // 更新图表
        initCharts();
        
        // 获取/生成24行历史建议
        await fetchAdviceHistory();
      } catch (e) {
        console.error("数据获取失败：", e);
        // 全量用模拟数据兜底
        goldData = generateMockData('gold', 100);
        silverData = generateMockData('silver', 100);
        initCharts();
        generateMockAdviceHistory(24);
      }
    }

    // 4. 生成模拟数据（确保图表显示）
    function generateMockData(type, count, existing = []) {
      const base = type === 'gold' ? 772 : 8.78;
      const data = [...existing];
      let last = existing.length ? existing[existing.length - 1].c : base;
      
      for (let i = data.length; i < count; i++) {
        const change = (Math.random() - 0.45) * (type === 'gold' ? 0.5 : 0.05);
        const c = +(last + change).toFixed(2);
        data.push({
          t: Date.now() - (count - i) * 3600000, // 每小时一个点
          o: +(c - Math.random() * 0.03).toFixed(2),
          h: +(c + Math.random() * 0.05).toFixed(2),
          l: +(c - Math.random() * 0.05).toFixed(2),
          c: c
        });
        last = c;
      }
      return data.sort((a, b) => a.t - b.t);
    }

    // 5. 初始化图表（确保显示完美）
    function initCharts() {
      // 黄金分时图
      if (!goldLine) {
        goldLine = new Chart(document.getElementById('gold-line'), {
          type: 'line',
          data: {
            datasets: [{
              data: goldData.slice(-30).map(item => ({ x: new Date(item.t), y: item.c })),
              borderColor: '#0071e3',
              backgroundColor: 'rgba(0, 113, 227, 0.1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { grid: { display: false } }, y: { position: 'right' } },
            plugins: { legend: { display: false } }
          }
        });
      } else {
        goldLine.data.datasets[0].data = goldData.slice(-30).map(item => ({ x: new Date(item.t), y: item.c }));
        goldLine.update();
      }

      // 黄金K线图
      if (!goldCandle) {
        goldCandle = new Chart(document.getElementById('gold-candle'), {
          type: 'bar',
          data: {
            datasets: [
              // 影线
              {
                data: goldData.map(item => ({ x: new Date(item.t), y: [item.l, item.h - item.l] })),
                backgroundColor: 'rgba(0, 113, 227, 0.6)',
                barPercentage: 0.1
              },
              // 实体
              {
                data: goldData.map(item => ({ x: new Date(item.t), y: [Math.min(item.o, item.c), Math.abs(item.o - item.c)] })),
                backgroundColor: item => item.o < item.c ? 'rgba(52, 199, 89, 0.8)' : 'rgba(255, 59, 48, 0.8)',
                barPercentage: 0.6
              }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { grid: { display: false } }, y: { position: 'right' } },
            plugins: { legend: { display: false } }
          }
        });
      } else {
        goldCandle.update();
      }

      // 白银图表（同上逻辑）
      if (!silverLine) {
        silverLine = new Chart(document.getElementById('silver-line'), {
          type: 'line',
          data: {
            datasets: [{
              data: silverData.slice(-30).map(item => ({ x: new Date(item.t), y: item.c })),
              borderColor: '#86868b',
              backgroundColor: 'rgba(134, 134, 139, 0.1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { grid: { display: false } }, y: { position: 'right' } },
            plugins: { legend: { display: false } }
          }
        });
      } else {
        silverLine.update();
      }

      if (!silverCandle) {
        silverCandle = new Chart(document.getElementById('silver-candle'), {
          type: 'bar',
          data: {
            datasets: [
              {
                data: silverData.map(item => ({ x: new Date(item.t), y: [item.l, item.h - item.l] })),
                backgroundColor: 'rgba(134, 134, 139, 0.6)',
                barPercentage: 0.1
              },
              {
                data: silverData.map(item => ({ x: new Date(item.t), y: [Math.min(item.o, item.c), Math.abs(item.o - item.c)] })),
                backgroundColor: item => item.o < item.c ? 'rgba(52, 199, 89, 0.8)' : 'rgba(255, 59, 48, 0.8)',
                barPercentage: 0.6
              }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { grid: { display: false } }, y: { position: 'right' } },
            plugins: { legend: { display: false } }
          }
        });
      } else {
        silverCandle.update();
      }
    }

    // 6. 获取/生成24行历史建议
    async function fetchAdviceHistory() {
      try {
        const res = await fetch(ADVICE_HISTORY_API);
        const advice = await res.json();
        
        // 确保有24行，不足则补充模拟数据
        const needed = 24 - advice.length;
        if (needed > 0) {
          const mock = generateMockAdviceHistory(needed, advice[0]?.timestamp || Date.now());
          advice.unshift(...mock); // 模拟数据放前面
        }
        
        // 渲染表格
        renderAdviceTable(advice.slice(0, 24));
      } catch (e) {
        console.error("获取建议历史失败，使用模拟数据");
        generateMockAdviceHistory(24);
      }
    }

    // 生成模拟建议历史
    function generateMockAdviceHistory(count, baseTime) {
      const advice = [];
      const base = baseTime || Date.now();
      
      for (let i = 0; i < count; i++) {
        const time = base - (i + 1) * 3600000; // 每小时一条
        const goldAdvice = Math.random() > 0.3 ? '买入' : Math.random() > 0.5 ? '卖出' : '观望';
        const silverAdvice = Math.random() > 0.3 ? '买入' : Math.random() > 0.5 ? '卖出' : '观望';
        
        // 随机结果（非观望才有结果）
        const goldResult = goldAdvice !== '观望' 
          ? Math.random() > 0.4 ? '盈利' : Math.random() > 0.5 ? '亏损' : '失效' 
          : '--';
        const silverResult = silverAdvice !== '观望' 
          ? Math.random() > 0.4 ? '盈利' : Math.random() > 0.5 ? '亏损' : '失效' 
          : '--';
        
        advice.push({
          timestamp: time,
          gold: { advice: goldAdvice },
          silver: { advice: silverAdvice },
          goldResult,
          silverResult
        });
      }
      
      renderAdviceTable(advice);
      return advice;
    }

    // 渲染建议表格
    function renderAdviceTable(advice) {
      const tbody = document.getElementById('history-table');
      tbody.innerHTML = '';
      
      advice.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-apple-border';
        tr.innerHTML = `
          <td class="px-4 py-2">${formatTime(item.timestamp)}</td>
          <td class="px-4 py-2">${item.gold.advice}</td>
          <td class="px-4 py-2">${item.goldResult === '盈利' ? '<span class="text-success">盈利</span>' : 
                                 item.goldResult === '亏损' ? '<span class="text-danger">亏损</span>' : 
                                 item.goldResult === '失效' ? '<span class="text-apple-gray">失效</span>' : '--'}</td>
          <td class="px-4 py-2">${item.silver.advice}</td>
          <td class="px-4 py-2">${item.silverResult === '盈利' ? '<span class="text-success">盈利</span>' : 
                                 item.silverResult === '亏损' ? '<span class="text-danger">亏损</span>' : 
                                 item.silverResult === '失效' ? '<span class="text-apple-gray">失效</span>' : '--'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      fetchData();
      
      // 绑定刷新按钮
      document.getElementById('refresh-gold').addEventListener('click', fetchData);
      document.getElementById('refresh-silver').addEventListener('click', fetchData);
    });
  </script>
</body>
</html>
