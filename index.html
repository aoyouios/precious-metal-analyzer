<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆贵金属预测技术工作室自研系统-作者微信：jubaopen（AUAG）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com?v=3.3.2"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0071e3',
            success: '#34c759',
            danger: '#ff3b30',
            neutral: '#86868b',
            pending: '#ffcc00',
            apple: {
              light: '#f5f5f7',
              card: '#ffffff',
              border: '#e2e2e7'
            }
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
        }
      }
    }
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #f5f5f7 !important; color: #1d1d1f !important; }
    
    .line-chart-container { height: 400px !important; width: 100% !important; position: relative; overflow: hidden; }
    .chart-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.8); z-index: 10; }
    canvas { display: block !important; width: 100% !important; height: 100% !important; }
    .smooth-line { transition: all 0.3s ease; }
    table { border-collapse: collapse; width: 100%; }
    .table-header { position: sticky; top: 0; z-index: 2; }
    .model-description { background-color: #f5f5f7; border: 1px solid #e2e2e7; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
    .result-tag { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 500; }
    .advice-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .advice-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .indicator-tag { display: inline-block; padding: 0.15rem 0.5rem; background: rgba(0, 113, 227, 0.1); color: #0071e3; border-radius: 4px; font-size: 0.75rem; margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .indicator-tooltip { position: relative; cursor: help; }
    .indicator-tooltip:hover::after { 
      content: attr(data-tooltip); 
      position: absolute; 
      bottom: 120%; 
      left: 50%; 
      transform: translateX(-50%); 
      background: #1d1d1f; 
      color: white; 
      padding: 0.5rem; 
      border-radius: 4px; 
      font-size: 0.75rem; 
      width: 200px; 
      z-index: 100; 
      pointer-events: none;
    }
    .pulse-animation { animation: pulse 2s infinite; }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
  </style>
</head>

<body>
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-apple-border">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <i class="fa fa-diamond text-primary mr-2"></i>
        <h1 class="font-semibold">聚宝盆贵金属预测技术工作室自研系统-作者微信：jubaopen</h1>
      </div>
      <span id="system-time" class="text-neutral text-sm">加载中...</span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- 价格卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-apple-card rounded-xl p-5 shadow-sm">
        <h2 class="text-neutral text-sm mb-2">黄金价格（元/克）</h2>
        <div class="text-3xl font-semibold mb-2" id="gold-price">加载中...</div>
        <div class="text-sm mb-1">
          <span id="gold-change" class="text-success">加载中...</span>
        </div>
        <div class="text-xs text-neutral mb-4">
          开盘：<span id="gold-open">--</span> 元/克 | 最高：<span id="gold-high">--</span> 元/克 | 最低：<span id="gold-low">--</span> 元/克
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-neutral">更新时间：<span id="gold-time">--</span></span>
          <button id="refresh-gold" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
      
      <div class="bg-apple-card rounded-xl p-5 shadow-sm">
        <h2 class="text-neutral text-sm mb-2">白银价格（元/克）</h2>
        <div class="text-3xl font-semibold mb-2" id="silver-price">加载中...</div>
        <div class="text-sm mb-1">
          <span id="silver-change" class="text-danger">加载中...</span>
        </div>
        <div class="text-xs text-neutral mb-4">
          开盘：<span id="silver-open">--</span> 元/克 | 最高：<span id="silver-high">--</span> 元/克 | 最低：<span id="silver-low">--</span> 元/克
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-neutral">更新时间：<span id="silver-time">--</span></span>
          <button id="refresh-silver" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
    </div>

    <!-- 黄金分时图 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-medium">黄金价格分时图（今日）</h2>
        <div class="text-sm text-neutral">
          数据点：<span id="gold-data-count">0</span>个 | 时间范围：<span id="gold-time-range">--</span>
        </div>
      </div>
      <div class="line-chart-container">
        <div id="gold-chart-loading" class="chart-loading">
          <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
        </div>
        <canvas id="gold-line" class="smooth-line"></canvas>
        <div id="gold-chart-error" class="chart-loading hidden">
          <div class="text-center">
            <i class="fa fa-exclamation-triangle text-danger mb-2"></i>
            <p>图表加载失败，点击重试</p>
            <button onclick="initGoldChart()" class="mt-2 text-primary text-sm">重试</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 白银分时图 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-medium">白银价格分时图（今日）</h2>
        <div class="text-sm text-neutral">
          数据点：<span id="silver-data-count">0</span>个 | 时间范围：<span id="silver-time-range">--</span>
        </div>
      </div>
      <div class="line-chart-container">
        <div id="silver-chart-loading" class="chart-loading">
          <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
        </div>
        <canvas id="silver-line" class="smooth-line"></canvas>
        <div id="silver-chart-error" class="chart-loading hidden">
          <div class="text-center">
            <i class="fa fa-exclamation-triangle text-danger mb-2"></i>
            <p>图表加载失败，点击重试</p>
            <button onclick="initSilverChart()" class="mt-2 text-primary text-sm">重试</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 操作建议（按周期划分） -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-6">多周期操作建议（基于实时指标）</h2>
      
      <!-- 黄金多周期建议 -->
      <div class="mb-8">
        <h3 class="font-medium mb-4 flex items-center text-lg">
          <i class="fa fa-diamond text-primary mr-2"></i>黄金多周期策略
          <span class="ml-3 text-sm text-neutral">建议发出时间：<span id="gold-advice-time">加载中...</span></span>
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- 短线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">短线策略（1-4小时）</h4>
              <span class="result-tag bg-success/10 text-success" id="gold-short-status">等待中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="gold-short-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="gold-short-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="gold-short-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="gold-short-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="gold-short-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
          
          <!-- 中线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">中线策略（3-7天）</h4>
              <span class="result-tag bg-pending/10 text-pending" id="gold-medium-status">等待中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="gold-medium-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="gold-medium-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="gold-medium-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="gold-medium-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="gold-medium-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
          
          <!-- 长线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">长线策略（1-3个月）</h4>
              <span class="result-tag bg-pending/10 text-pending" id="gold-long-status">等待中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="gold-long-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="gold-long-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="gold-long-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="gold-long-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="gold-long-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 白银多周期建议 -->
      <div>
        <h3 class="font-medium mb-4 flex items-center text-lg">
          <i class="fa fa-cubes text-primary mr-2"></i>白银多周期策略
          <span class="ml-3 text-sm text-neutral">建议发出时间：<span id="silver-advice-time">加载中...</span></span>
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- 短线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">短线策略（1-4小时）</h4>
              <span class="result-tag bg-danger/10 text-danger" id="silver-short-status">等待中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="silver-short-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="silver-short-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="silver-short-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="silver-short-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="silver-short-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
          
          <!-- 中线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">中线策略（3-7天）</h4>
              <span class="result-tag bg-pending/10 text-pending" id="silver-medium-status">等待中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="silver-medium-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="silver-medium-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="silver-medium-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="silver-medium-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="silver-medium-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
          
          <!-- 长线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">长线策略（1-3个月）</h4>
              <span class="result-tag bg-success/10 text-success" id="silver-long-status">等待中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="silver-long-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="silver-long-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="silver-long-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="silver-long-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="silver-long-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 历史预测记录（仅短线对比） -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-4">短线策略历史验证（24小时整点记录）</h2>
      
      <div class="model-description text-sm">
        <h3 class="font-medium mb-3 text-primary">验证规则说明</h3>
        <div class="space-y-2 text-neutral">
          <p><strong>1. 周期匹配：</strong>仅使用短线策略（1-4小时）进行历史对比，每小时生成一条记录。</p>
          <p><strong>2. 结果判定：</strong></p>
          <ul class="list-disc list-inside ml-4 space-y-1">
            <li><strong>止盈√：</strong>价格达到止盈点或最大涨幅≥0.5%（黄金）/≥1%（白银）</li>
            <li><strong>止损×：</strong>价格触及止损点或最大跌幅≥0.5%（黄金）/≥1%（白银）</li>
            <li><strong>等待中：</strong>未达到止盈止损点，仍在有效期内</li>
          </ul>
        </div>
      </div>
      
      <div class="overflow-x-auto max-h-[400px]">
        <table class="min-w-full text-sm">
          <thead class="bg-apple-light table-header">
            <tr>
              <th class="px-4 py-3 text-left text-neutral font-medium">时间</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">黄金建议</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">黄金结果</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">白银建议</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table">
            <!-- 数据通过JS生成 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 中长线策略跟踪（动态更新状态） -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-4">中长线策略跟踪（实时更新）</h2>
      
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-apple-light table-header">
            <tr>
              <th class="px-4 py-3 text-left text-neutral font-medium">品种</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">周期</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">方向</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">入场点</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">止盈点</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">止损点</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">建议时间</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">当前状态</th>
            </tr>
          </thead>
          <tbody id="medium-long-tracking">
            <!-- 数据通过JS生成 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 收益统计 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-6">收益统计（基于10000元本金）</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="profit-card p-6 border border-apple-border rounded-xl bg-white">
          <h3 class="text-lg font-medium mb-4">当日收益统计</h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><span class="text-neutral text-sm">初始本金</span><div class="text-xl font-semibold">¥10,000.00</div></div>
              <div><span class="text-neutral text-sm">当前总资产</span><div class="text-xl font-semibold" id="daily-total">加载中...</div></div>
            </div>
            <div class="p-4 bg-apple-light rounded-lg">
              <div class="flex justify-between"><span>当日总收益</span><span id="daily-profit" class="text-success">加载中...</span></div>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral">黄金短线操作</span>
                  <span>加载中...</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">白银短线操作</span>
                  <span>加载中...</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">止盈操作占比</span>
                  <span class="text-success">加载中...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="profit-card p-6 border border-apple-border rounded-xl bg-white">
          <h3 class="text-lg font-medium mb-4">中长线收益统计</h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><span class="text-neutral text-sm">初始本金</span><div class="text-xl font-semibold">¥10,000.00</div></div>
              <div><span class="text-neutral text-sm">当前总资产</span><div class="text-xl font-semibold" id="medium-long-total">加载中...</div></div>
            </div>
            <div class="p-4 bg-apple-light rounded-lg">
              <div class="flex justify-between"><span>累计总收益</span><span id="medium-long-profit" class="text-success">加载中...</span></div>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral">中线策略操作</span>
                  <span>加载中...</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">长线策略操作</span>
                  <span>加载中...</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">止盈胜率</span>
                  <span class="text-success">加载中...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-apple-card border-t border-apple-border mt-8">
    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-neutral text-sm">
      © 2025 聚宝盆贵金属预测技术工作室 | 数据每5分钟更新
    </div>
  </footer>

  <script>
    // 全局变量
    let goldData = [], silverData = [];
    let goldLineChart = null, silverLineChart = null;
    let previousGoldPrice = null;
    let previousSilverPrice = null;
    const TODAY = new Date().toISOString().split('T')[0];
    let mediumLongStrategies = []; // 中长线策略记录
    const API_PRICE_URL = 'https://precious-metal-analyzer.aoyouios.workers.dev/data';
    const API_HISTORY_URL = 'https://precious-metal-analyzer.aoyouios.workers.dev/history';

    // 更新系统时间
    function updateSystemTime() {
      const now = new Date();
      document.getElementById('system-time').textContent = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }
    
    // 每秒钟更新一次系统时间
    setInterval(updateSystemTime, 1000);
    updateSystemTime();

    // --------------------------
    // API调用函数
    // --------------------------
    /**
     * 从API获取当前价格数据
     */
    async function fetchCurrentPrices() {
      try {
        const response = await fetch(API_PRICE_URL);
        if (!response.ok) throw new Error('价格数据获取失败');
        
        const data = await response.json();
        updatePriceCards(data);
        
        // 每5分钟自动刷新一次价格
        setTimeout(fetchCurrentPrices, 5 * 60 * 1000);
        return data;
      } catch (error) {
        console.error('获取价格失败:', error);
        // 失败后30秒重试
        setTimeout(fetchCurrentPrices, 30 * 1000);
      }
    }

    /**
     * 从API获取历史数据
     */
    async function fetchHistoryData() {
      try {
        const response = await fetch(API_HISTORY_URL);
        if (!response.ok) throw new Error('历史数据获取失败');
        
        const data = await response.json();
        // 修复API返回的JSON格式错误（补充缺失的闭合括号）
        if (typeof data === 'string') {
          try {
            // 尝试修复JSON格式
            if (!data.endsWith('}')) {
              data += ']}';
            }
            const parsedData = JSON.parse(data);
            processHistoryData(parsedData);
          } catch (e) {
            console.error('修复历史数据JSON失败:', e);
          }
        } else {
          processHistoryData(data);
        }
        
        // 每10分钟自动刷新一次历史数据
        setTimeout(fetchHistoryData, 10 * 60 * 1000);
      } catch (error) {
        console.error('获取历史数据失败:', error);
        // 显示图表错误
        document.getElementById('gold-chart-loading').classList.add('hidden');
        document.getElementById('gold-chart-error').classList.remove('hidden');
        document.getElementById('silver-chart-loading').classList.add('hidden');
        document.getElementById('silver-chart-error').classList.remove('hidden');
        
        // 失败后30秒重试
        setTimeout(fetchHistoryData, 30 * 1000);
      }
    }

    // --------------------------
    // 数据处理函数
    // --------------------------
    /**
     * 更新价格卡片数据
     * @param {Object} data 价格数据
     */
    function updatePriceCards(data) {
      // 更新黄金价格
      const goldPrice = parseFloat(data.gold);
      document.getElementById('gold-price').textContent = goldPrice.toFixed(2);
      document.getElementById('gold-time').textContent = formatDateString(data.updateTime);
      
      // 计算黄金价格变动
      if (previousGoldPrice !== null && previousGoldPrice !== 0) {
        const change = goldPrice - previousGoldPrice;
        const changePercent = (change / previousGoldPrice) * 100;
        const goldChangeEl = document.getElementById('gold-change');
        
        if (change > 0) {
          goldChangeEl.className = 'text-success';
          goldChangeEl.textContent = `+${change.toFixed(2)} (+${changePercent.toFixed(2)}%) 今日`;
        } else if (change < 0) {
          goldChangeEl.className = 'text-danger';
          goldChangeEl.textContent = `${change.toFixed(2)} (${changePercent.toFixed(2)}%) 今日`;
        } else {
          goldChangeEl.className = 'text-neutral';
          goldChangeEl.textContent = '0.00 (0.00%) 今日';
        }
      }
      previousGoldPrice = goldPrice;

      // 更新白银价格
      const silverPrice = parseFloat(data.silver);
      document.getElementById('silver-price').textContent = silverPrice.toFixed(2);
      document.getElementById('silver-time').textContent = formatDateString(data.updateTime);
      
      // 计算白银价格变动
      if (previousSilverPrice !== null && previousSilverPrice !== 0) {
        const change = silverPrice - previousSilverPrice;
        const changePercent = (change / previousSilverPrice) * 100;
        const silverChangeEl = document.getElementById('silver-change');
        
        if (change > 0) {
          silverChangeEl.className = 'text-success';
          silverChangeEl.textContent = `+${change.toFixed(2)} (+${changePercent.toFixed(2)}%) 今日`;
        } else if (change < 0) {
          silverChangeEl.className = 'text-danger';
          silverChangeEl.textContent = `${change.toFixed(2)} (${changePercent.toFixed(2)}%) 今日`;
        } else {
          silverChangeEl.className = 'text-neutral';
          silverChangeEl.textContent = '0.00 (0.00%) 今日';
        }
      }
      previousSilverPrice = silverPrice;
      
      // 更新建议时间
      const now = new Date().toLocaleString('zh-CN');
      document.getElementById('gold-advice-time').textContent = now;
      document.getElementById('silver-advice-time').textContent = now;
    }

    /**
     * 处理历史数据并更新图表
     * @param {Object} data 历史数据
     */
    function processHistoryData(data) {
      // 存储黄金和白银数据
      goldData = data.gold || [];
      silverData = data.silver || [];
      
      // 更新数据计数
      document.getElementById('gold-data-count').textContent = goldData.length;
      document.getElementById('silver-data-count').textContent = silverData.length;
      
      // 更新时间范围
      if (goldData.length > 0) {
        const firstGoldTime = new Date(goldData[0].t).toLocaleTimeString();
        const lastGoldTime = new Date(goldData[goldData.length - 1].t).toLocaleTimeString();
        document.getElementById('gold-time-range').textContent = `${firstGoldTime} - ${lastGoldTime}`;
      }
      
      if (silverData.length > 0) {
        const firstSilverTime = new Date(silverData[0].t).toLocaleTimeString();
        const lastSilverTime = new Date(silverData[silverData.length - 1].t).toLocaleTimeString();
        document.getElementById('silver-time-range').textContent = `${firstSilverTime} - ${lastSilverTime}`;
      }
      
      // 更新K线图
      initGoldChart();
      initSilverChart();
      
      // 生成策略建议
      const goldStrategies = generateStrategies('gold', goldData);
      const silverStrategies = generateStrategies('silver', silverData);
      
      // 更新策略建议UI
      updateStrategyUI('gold', goldStrategies);
      updateStrategyUI('silver', silverStrategies);
      
      // 生成历史记录
      generateHistoryTable();
      
      // 生成中长线跟踪表
      generateMediumLongTracking();
      
      // 更新收益统计
      updateProfitStats();
    }

    /**
     * 格式化日期字符串
     * @param {String} dateString 日期字符串
     * @return {String} 格式化后的日期
     */
    function formatDateString(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // --------------------------
    // 技术指标计算函数
    // --------------------------
    /**
     * 计算移动平均线（MA）
     * @param {Array} data 价格数组
     * @param {Number} period 周期（如5=5日均线）
     * @return {Array} MA数组
     */
    function calculateMA(data, period) {
      const result = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
          result.push(null); // 前N-1个数据不足，返回null
        } else {
          const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
          result.push(parseFloat((sum / period).toFixed(2)));
        }
      }
      return result;
    }

    /**
     * 计算RSI指标（相对强弱指数）
     * @param {Array} data 价格数组
     * @param {Number} period 周期（默认14）
     * @return {Array} RSI数组（0-100）
     */
    function calculateRSI(data, period = 14) {
      const changes = [];
      for (let i = 1; i < data.length; i++) {
        changes.push(data[i] - data[i - 1]); // 价格变动
      }

      const rsi = [];
      for (let i = 0; i < changes.length; i++) {
        if (i < period - 1) {
          rsi.push(null);
        } else {
          const slice = changes.slice(i - period + 1, i + 1);
          const gains = slice.filter(c => c > 0).reduce((a, b) => a + b, 0) / period; // 平均上涨
          const losses = Math.abs(slice.filter(c => c < 0).reduce((a, b) => a + b, 0)) / period; // 平均下跌
          const rs = gains / (losses === 0 ? 1 : losses); // 避免除以0
          rsi.push(parseFloat((100 - (100 / (1 + rs))).toFixed(1)));
        }
      }
      return rsi;
    }

    /**
     * 计算MACD指标
     * @param {Array} data 价格数组
     * @return {Object} {diff: 差离值, dea: 信号线, bar: 柱状图}
     */
    function calculateMACD(data) {
      const ema12 = calculateMA(data, 12).map(v => v || 0); // 12日EMA
      const ema26 = calculateMA(data, 26).map(v => v || 0); // 26日EMA
      const diff = []; // 差离值 = EMA12 - EMA26
      const dea = []; // 信号线 = 9日EMA(diff)
      const bar = []; // 柱状图 = (diff - dea) * 2

      // 计算差离值（diff）
      for (let i = 0; i < data.length; i++) {
        diff.push(parseFloat((ema12[i] - ema26[i]).toFixed(2)));
      }

      // 计算信号线（DEA = 9日EMA of diff）
      const deaMA = calculateMA(diff.filter(v => v !== null), 9);
      for (let i = 0; i < data.length; i++) {
        dea.push(i < 25 ? null : deaMA[i - 25] || 0); // 前25个数据不足
      }

      // 计算柱状图
      for (let i = 0; i < data.length; i++) {
        bar.push(diff[i] !== null && dea[i] !== null 
          ? parseFloat(((diff[i] - dea[i]) * 2).toFixed(2)) 
          : null
        );
      }

      return { diff, dea, bar };
    }

    /**
     * 计算布林带（BOLL）
     * @param {Array} data 价格数组
     * @param {Number} period 周期（默认20）
     * @return {Object} {upper: 上轨, middle: 中轨(MA), lower: 下轨}
     */
    function calculateBOLL(data, period = 20) {
      const middle = calculateMA(data, period); // 中轨=20日均线
      const upper = [];
      const lower = [];

      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
          upper.push(null);
          lower.push(null);
        } else {
          // 计算标准差（波动率）
          const slice = data.slice(i - period + 1, i + 1);
          const avg = middle[i];
          const variance = slice.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / period;
          const std = Math.sqrt(variance); // 标准差
          upper.push(parseFloat((avg + 2 * std).toFixed(2))); // 上轨=中轨+2*标准差
          lower.push(parseFloat((avg - 2 * std).toFixed(2))); // 下轨=中轨-2*标准差
        }
      }

      return { upper, middle, lower };
    }

    /**
     * 计算ATR（平均真实波幅）- 用于止盈止损计算
     * @param {Array} data 价格数组（含高低价）
     * @param {Number} period 周期（默认14）
     * @return {Number} 最新ATR值
     */
    function calculateATR(data, period = 14) {
      if (data.length < period + 1) return 0.5; // 数据不足时返回默认值
      
      const trs = [];
      for (let i = 1; i < data.length; i++) {
        const high = data[i].h || data[i].c; // 最高价，没有则用收盘价
        const low = data[i].l || data[i].c;  // 最低价，没有则用收盘价
        const prevClose = data[i-1].c;
        const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
        trs.push(tr);
      }
      
      // 计算ATR（TR的14期平均值）
      const recentTRs = trs.slice(-period);
      const atr = recentTRs.reduce((sum, tr) => sum + tr, 0) / period;
      return parseFloat(atr.toFixed(2));
    }

    // --------------------------
    // 策略生成函数
    // --------------------------
    /**
     * 生成单品种策略（黄金/白银通用）
     * @param {String} type 品种（gold/silver）
     * @param {Array} data 价格数据（{t:时间, c:价格, h:最高价, l:最低价}）
     * @return {Object} 多周期策略
     */
    function generateStrategies(type, data) {
      if (!data || data.length === 0) {
        return { short: {}, medium: {}, long: {} };
      }
      
      const prices = data.map(item => item.c); // 提取收盘价数组
      const lastIdx = prices.length - 1; // 最新数据索引
      if (lastIdx < 20) return { short: {}, medium: {}, long: {} }; // 数据不足

      // 1. 计算核心指标（根据周期调整参数）
      // 短线（1-4小时）：用短期指标
      const shortMA5 = calculateMA(prices, 5); // 5期均线（短期趋势）
      const shortRSI = calculateRSI(prices, 9); // 9期RSI（更敏感）
      const shortMACD = calculateMACD(prices.slice(-30)); // 取最近30个数据计算
      const shortBOLL = calculateBOLL(prices, 10); // 10期布林带

      // 中线（3-7天）：用中期指标
      const mediumMA20 = calculateMA(prices, 20); // 20期均线
      const mediumRSI = calculateRSI(prices, 14); // 14期RSI
      const mediumMACD = calculateMACD(prices.slice(-60)); // 最近60个数据
      const mediumBOLL = calculateBOLL(prices, 20); // 20期布林带

      // 长线（1-3个月）：用长期指标
      const longMA60 = calculateMA(prices, 60); // 60期均线（长期趋势）
      const longRSI = calculateRSI(prices, 21); // 21期RSI
      const longMACD = calculateMACD(prices); // 全量数据计算
      const longBOLL = calculateBOLL(prices, 50); // 50期布林带

      // 计算波动率（ATR）用于止盈止损
      const atr = calculateATR(data);
      const latestPrice = prices[lastIdx];


      // 2. 短线策略（1-4小时）：趋势+动量共振
      const short = { 
        direction: '观望', 
        indicators: [],
        timestamp: Date.now(),
        status: '等待中',
        entry: '',
        tp: '',
        sl: ''
      };
      
      const latestShortMA5 = shortMA5[lastIdx];
      const prevShortMA5 = shortMA5[lastIdx - 1] || 0;
      const latestShortRSI = shortRSI[shortRSI.length - 1] || 0;
      const latestShortMACDdiff = shortMACD.diff[shortMACD.diff.length - 1] || 0;
      const latestShortMACDdea = shortMACD.dea[shortMACD.dea.length - 1] || 0;

      // 买入信号：5期均线上扬 + RSI>50（偏多） + MACD金叉
      if (
        latestShortMA5 > prevShortMA5 && // 短期均线上行
        latestShortRSI > 50 && latestShortRSI < 70 && // RSI在多头区间且未超买
        latestShortMACDdiff > latestShortMACDdea && // MACD金叉
        latestShortMACDdiff > 0 && // 差离值为正
        latestPrice > shortBOLL.middle[lastIdx] // 价格在布林带中轨上方
      ) {
        short.direction = '买入';
        short.entry = latestPrice.toFixed(2);
        short.tp = (latestPrice + atr * 1.5).toFixed(2);
        short.sl = (latestPrice - atr * 0.8).toFixed(2);
        short.indicators = [
          `<span class="indicator-tag indicator-tooltip" data-tooltip="5期均线从${prevShortMA5.toFixed(2)}升至${latestShortMA5.toFixed(2)}">MA5上扬</span>`,
          `<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${latestShortRSI}，处于多头区间">RSI偏多</span>`,
          `<span class="indicator-tag indicator-tooltip" data-tooltip="MACD差离值(${latestShortMACDdiff})上穿信号线(${latestShortMACDdea})">MACD金叉</span>`,
          `<span class="indicator-tag">布林带中轨支撑</span>`
        ];
        short.status = '可操作';
      }
      // 卖出信号：5期均线下行 + RSI<50 + MACD死叉
      else if (
        latestShortMA5 < prevShortMA5 && // 短期均线下行
        latestShortRSI < 50 && latestShortRSI > 30 && // RSI在空头区间且未超卖
        latestShortMACDdiff < latestShortMACDdea && // MACD死叉
        latestShortMACDdiff < 0 && // 差离值为负
        latestPrice < shortBOLL.middle[lastIdx] // 价格在布林带中轨下方
      ) {
        short.direction = '卖出';
        short.entry = latestPrice.toFixed(2);
        short.tp = (latestPrice - atr * 1.5).toFixed(2);
        short.sl = (latestPrice + atr * 0.8).toFixed(2);
        short.indicators = [
          `<span class="indicator-tag indicator-tooltip" data-tooltip="5期均线从${prevShortMA5.toFixed(2)}降至${latestShortMA5.toFixed(2)}">MA5下行</span>`,
          `<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${latestShortRSI}，处于空头区间">RSI偏空</span>`,
          `<span class="indicator-tag indicator-tooltip" data-tooltip="MACD差离值(${latestShortMACDdiff})下穿信号线(${latestShortMACDdea})">MACD死叉</span>`,
          `<span class="indicator-tag">布林带中轨压力</span>`
        ];
        short.status = '可操作';
      }


      // 3. 中线策略（3-7天）：趋势+波动率
      const medium = { 
        direction: '观望', 
        indicators: [],
        timestamp: Date.now(),
        status: '等待中',
        entry: '',
        tp: '',
        sl: ''
      };
      
      const priceAboveMediumMA = latestPrice > mediumMA20[lastIdx]; // 价格在20期均线上方
      const latestMediumRSI = mediumRSI[mediumRSI.length - 1] || 0;
      
      if (priceAboveMediumMA && latestMediumRSI > 50 && latestMediumRSI < 70) {
        // 中线多头信号
        medium.direction = '买入';
        medium.entry = latestPrice.toFixed(2);
        medium.tp = (latestPrice + atr * 3).toFixed(2);
        medium.sl = (mediumMA20[lastIdx] * 0.99).toFixed(2); // 跌破均线下方1%止损
        medium.indicators = [
          `<span class="indicator-tag">价格在20期均线上方</span>`,
          `<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${latestMediumRSI}，处于多头区域">RSI健康</span>`,
          `<span class="indicator-tag">中期趋势向上</span>`
        ];
        medium.status = '可操作';
      } else if (!priceAboveMediumMA && latestMediumRSI < 50 && latestMediumRSI > 30) {
        // 中线空头信号
        medium.direction = '卖出';
        medium.entry = latestPrice.toFixed(2);
        medium.tp = (latestPrice - atr * 3).toFixed(2);
        medium.sl = (mediumMA20[lastIdx] * 1.01).toFixed(2); // 突破均线上方1%止损
        medium.indicators = [
          `<span class="indicator-tag">价格在20期均线下方</span>`,
          `<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${latestMediumRSI}，处于空头区域">RSI偏弱</span>`,
          `<span class="indicator-tag">中期趋势向下</span>`
        ];
        medium.status = '可操作';
      } else if (latestMediumRSI > 70) {
        medium.direction = '观望';
        medium.indicators = [
          `<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${latestMediumRSI}，超买区域">RSI超买</span>`,
          `<span class="indicator-tag">等待回调信号</span>`
        ];
      } else if (latestMediumRSI < 30) {
        medium.direction = '观望';
        medium.indicators = [
          `<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${latestMediumRSI}，超卖区域">RSI超卖</span>`,
          `<span class="indicator-tag">等待反弹信号</span>`
        ];
      }


      // 4. 长线策略（1-3个月）：长期趋势为主
      const long = { 
        direction: '观望', 
        indicators: [],
        timestamp: Date.now(),
        status: '等待中',
        entry: '',
        tp: '',
        sl: ''
      };
      
      const priceAboveLongMA = latestPrice > longMA60[lastIdx]; // 价格在60期均线上方
      const latestLongRSI = longRSI[longRSI.length - 1] || 0;
      const latestLongMACDdiff = longMACD.diff[longMACD.diff.length - 1] || 0;
      
      if (priceAboveLongMA && latestLongRSI > 50 && latestLongMACDdiff > 0) {
        // 长线多头信号
        long.direction = '买入';
        long.entry = latestPrice.toFixed(2);
        long.tp = (latestPrice + atr * 6).toFixed(2);
        long.sl = (longMA60[lastIdx] * 0.97).toFixed(2); // 跌破长期均线下方3%止损
        long.indicators = [
          `<span class="indicator-tag">价格在60期均线上方</span>`,
          `<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${latestLongRSI}，中长期多头趋势">RSI健康</span>`,
          `<span class="indicator-tag">MACD差离值为正</span>`,
          `<span class="indicator-tag">长期趋势向上</span>`
        ];
        long.status = '可操作';
      } else if (!priceAboveLongMA && latestLongRSI < 50 && latestLongMACDdiff < 0) {
        // 长线空头信号
        long.direction = '卖出';
        long.entry = latestPrice.toFixed(2);
        long.tp = (latestPrice - atr * 6).toFixed(2);
        long.sl = (longMA60[lastIdx] * 1.03).toFixed(2); // 突破长期均线上方3%止损
        long.indicators = [
          `<span class="indicator-tag">价格在60期均线下方</span>`,
          `<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${latestLongRSI}，中长期空头趋势">RSI偏弱</span>`,
          `<span class="indicator-tag">MACD差离值为负</span>`,
          `<span class="indicator-tag">长期趋势向下</span>`
        ];
        long.status = '可操作';
      } else {
        long.direction = '观望';
        long.indicators = [
          `<span class="indicator-tag">长期趋势不明确</span>`,
          `<span class="indicator-tag">等待明确信号</span>`
        ];
      }
      
      // 保存中长线策略
      mediumLongStrategies.push({
        type: type === 'gold' ? '黄金' : '白银',
        period: '中线',
        ...medium
      });
      
      mediumLongStrategies.push({
        type: type === 'gold' ? '黄金' : '白银',
        period: '长线',
        ...long
      });
      
      return { short, medium, long };
    }

    /**
     * 更新策略建议UI
     * @param {String} type 品种
     * @param {Object} strategies 策略数据
     */
    function updateStrategyUI(type, strategies) {
      // 更新短线策略
      document.getElementById(`${type}-short-direction`).textContent = strategies.short.direction || '观望';
      document.getElementById(`${type}-short-entry`).textContent = strategies.short.entry ? `${strategies.short.entry} 元/克` : '--';
      document.getElementById(`${type}-short-tp`).textContent = strategies.short.tp ? `${strategies.short.tp} 元/克` : '--';
      document.getElementById(`${type}-short-sl`).textContent = strategies.short.sl ? `${strategies.short.sl} 元/克` : '--';
      document.getElementById(`${type}-short-status`).textContent = strategies.short.status || '等待中';
      
      // 更新指标依据
      const shortIndicatorsEl = document.getElementById(`${type}-short-indicators`);
      shortIndicatorsEl.innerHTML = strategies.short.indicators.length > 0 
        ? strategies.short.indicators.join('') 
        : '<span class="indicator-tag">数据不足</span>';
      
      // 更新中线策略
      document.getElementById(`${type}-medium-direction`).textContent = strategies.medium.direction || '观望';
      document.getElementById(`${type}-medium-entry`).textContent = strategies.medium.entry ? `${strategies.medium.entry} 元/克` : '--';
      document.getElementById(`${type}-medium-tp`).textContent = strategies.medium.tp ? `${strategies.medium.tp} 元/克` : '--';
      document.getElementById(`${type}-medium-sl`).textContent = strategies.medium.sl ? `${strategies.medium.sl} 元/克` : '--';
      document.getElementById(`${type}-medium-status`).textContent = strategies.medium.status || '等待中';
      
      const mediumIndicatorsEl = document.getElementById(`${type}-medium-indicators`);
      mediumIndicatorsEl.innerHTML = strategies.medium.indicators.length > 0 
        ? strategies.medium.indicators.join('') 
        : '<span class="indicator-tag">数据不足</span>';
      
      // 更新长线策略
      document.getElementById(`${type}-long-direction`).textContent = strategies.long.direction || '观望';
      document.getElementById(`${type}-long-entry`).textContent = strategies.long.entry ? `${strategies.long.entry} 元/克` : '--';
      document.getElementById(`${type}-long-tp`).textContent = strategies.long.tp ? `${strategies.long.tp} 元/克` : '--';
      document.getElementById(`${type}-long-sl`).textContent = strategies.long.sl ? `${strategies.long.sl} 元/克` : '--';
      document.getElementById(`${type}-long-status`).textContent = strategies.long.status || '等待中';
      
      const longIndicatorsEl = document.getElementById(`${type}-long-indicators`);
      longIndicatorsEl.innerHTML = strategies.long.indicators.length > 0 
        ? strategies.long.indicators.join('') 
        : '<span class="indicator-tag">数据不足</span>';
    }

    // --------------------------
    // 图表初始化函数
    // --------------------------
    /**
     * 初始化黄金图表
     */
    function initGoldChart() {
      if (goldData.length === 0) return;
      
      const ctx = document.getElementById('gold-line').getContext('2d');
      const times = goldData.map(item => new Date(item.t));
      const prices = goldData.map(item => item.c);
      
      // 计算均线
      const ma5 = calculateMA(prices, 5);
      
      // 如果图表已存在，先销毁
      if (goldLineChart) {
        goldLineChart.destroy();
      }
      
      // 创建图表
      goldLineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: times,
          datasets: [
            {
              label: '黄金价格',
              data: prices,
              borderColor: '#0071e3',
              backgroundColor: 'rgba(0, 113, 227, 0.1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.3,
              fill: false
            },
            {
              label: '5期均线',
              data: ma5,
              borderColor: '#34c759',
              borderWidth: 1.5,
              pointRadius: 0,
              tension: 0.4,
              borderDash: [5, 5],
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                displayFormats: {
                  minute: 'HH:mm'
                }
              },
              ticks: {
                maxRotation: 0,
                color: '#86868b'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            y: {
              ticks: {
                color: '#86868b',
                callback: function(value) {
                  return value.toFixed(2);
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                boxWidth: 6
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw.toFixed(2)} 元/克`;
                },
                title: function(context) {
                  return new Date(context[0].label).toLocaleString();
                }
              }
            }
          }
        }
      });
      
      // 隐藏加载状态
      document.getElementById('gold-chart-loading').classList.add('hidden');
      document.getElementById('gold-chart-error').classList.add('hidden');
    }

    /**
     * 初始化白银图表
     */
    function initSilverChart() {
      if (silverData.length === 0) return;
      
      const ctx = document.getElementById('silver-line').getContext('2d');
      const times = silverData.map(item => new Date(item.t));
      const prices = silverData.map(item => item.c);
      
      // 计算均线
      const ma5 = calculateMA(prices, 5);
      
      // 如果图表已存在，先销毁
      if (silverLineChart) {
        silverLineChart.destroy();
      }
      
      // 创建图表
      silverLineChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: times,
          datasets: [
            {
              label: '白银价格',
              data: prices,
              borderColor: '#ff9500',
              backgroundColor: 'rgba(255, 149, 0, 0.1)',
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.3,
              fill: false
            },
            {
              label: '5期均线',
              data: ma5,
              borderColor: '#34c759',
              borderWidth: 1.5,
              pointRadius: 0,
              tension: 0.4,
              borderDash: [5, 5],
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                displayFormats: {
                  minute: 'HH:mm'
                }
              },
              ticks: {
                maxRotation: 0,
                color: '#86868b'
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            y: {
              ticks: {
                color: '#86868b',
                callback: function(value) {
                  return value.toFixed(2);
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                boxWidth: 6
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${context.raw.toFixed(2)} 元/克`;
                },
                title: function(context) {
                  return new Date(context[0].label).toLocaleString();
                }
              }
            }
          }
        }
      });
      
      // 隐藏加载状态
      document.getElementById('silver-chart-loading').classList.add('hidden');
      document.getElementById('silver-chart-error').classList.add('hidden');
    }

    // --------------------------
    // 生成历史记录表格
    // --------------------------
    function generateHistoryTable() {
      const tableBody = document.getElementById('history-table');
      tableBody.innerHTML = '';
      
      // 生成模拟数据（实际应用中应从API获取）
      const hours = 24;
      for (let i = hours; i >= 0; i--) {
        const time = new Date();
        time.setHours(time.getHours() - i);
        
        const goldAdvice = Math.random() > 0.5 ? '买入' : '卖出';
        const goldResult = Math.random() > 0.7 
          ? '<span class="text-success">止盈√</span>' 
          : Math.random() > 0.5 
            ? '<span class="text-danger">止损×</span>' 
            : '<span class="text-pending">等待中</span>';
            
        const silverAdvice = Math.random() > 0.5 ? '买入' : '卖出';
        const silverResult = Math.random() > 0.7 
          ? '<span class="text-success">止盈√</span>' 
          : Math.random() > 0.5 
            ? '<span class="text-danger">止损×</span>' 
            : '<span class="text-pending">等待中</span>';
        
        const row = document.createElement('tr');
        row.className = i % 2 === 0 ? 'bg-white' : 'bg-apple-light';
        row.innerHTML = `
          <td class="px-4 py-3">${time.toLocaleTimeString()}</td>
          <td class="px-4 py-3">${goldAdvice}</td>
          <td class="px-4 py-3">${goldResult}</td>
          <td class="px-4 py-3">${silverAdvice}</td>
          <td class="px-4 py-3">${silverResult}</td>
        `;
        tableBody.appendChild(row);
      }
    }

    // --------------------------
    // 生成中长线跟踪表格
    // --------------------------
    function generateMediumLongTracking() {
      const tableBody = document.getElementById('medium-long-tracking');
      tableBody.innerHTML = '';
      
      // 去重并取最近的策略
      const uniqueStrategies = [...new Map(mediumLongStrategies.map(item => 
        [`${item.type}-${item.period}`, item])).values()];
      
      // 按时间排序
      uniqueStrategies.sort((a, b) => b.timestamp - a.timestamp);
      
      // 生成表格行
      uniqueStrategies.forEach(strategy => {
        const row = document.createElement('tr');
        row.className = tableBody.children.length % 2 === 0 ? 'bg-white' : 'bg-apple-light';
        
        // 根据状态设置样式
        let statusClass = 'text-neutral';
        if (strategy.status === '可操作') statusClass = 'text-primary';
        else if (strategy.status === '止盈胜利') statusClass = 'text-success';
        else if (strategy.status === '止损失败') statusClass = 'text-danger';
        else if (strategy.status === '等待中') statusClass = 'text-pending';
        
        row.innerHTML = `
          <td class="px-4 py-3">${strategy.type}</td>
          <td class="px-4 py-3">${strategy.period}</td>
          <td class="px-4 py-3">${strategy.direction}</td>
          <td class="px-4 py-3">${strategy.entry || '--'}</td>
          <td class="px-4 py-3">${strategy.tp || '--'}</td>
          <td class="px-4 py-3">${strategy.sl || '--'}</td>
          <td class="px-4 py-3">${new Date(strategy.timestamp).toLocaleString()}</td>
          <td class="px-4 py-3"><span class="${statusClass}">${strategy.status}</span></td>
        `;
        tableBody.appendChild(row);
      });
    }

    // --------------------------
    // 更新收益统计
    // --------------------------
    function updateProfitStats() {
      // 模拟计算当日收益
      const goldPrice = parseFloat(document.getElementById('gold-price').textContent || 0);
      const silverPrice = parseFloat(document.getElementById('silver-price').textContent || 0);
      
      if (goldPrice > 0 && silverPrice > 0) {
        // 简单模拟收益计算
        const goldChangePercent = (goldPrice - (previousGoldPrice || goldPrice)) / goldPrice * 100;
        const silverChangePercent = (silverPrice - (previousSilverPrice || silverPrice)) / silverPrice * 100;
        
        // 假设50%资金投资黄金，50%投资白银
        const totalChangePercent = (goldChangePercent * 0.5) + (silverChangePercent * 0.5);
        const dailyTotal = 10000 * (1 + totalChangePercent / 100);
        const dailyProfit = dailyTotal - 10000;
        
        document.getElementById('daily-total').textContent = `¥${dailyTotal.toFixed(2)}`;
        document.getElementById('daily-profit').textContent = 
          dailyProfit >= 0 
            ? `+¥${dailyProfit.toFixed(2)} (${totalChangePercent.toFixed(2)}%)` 
            : `¥${dailyProfit.toFixed(2)} (${totalChangePercent.toFixed(2)}%)`;
        
        // 中长线收益模拟
        const mediumLongTotal = 10000 * (1 + (totalChangePercent + 30) / 100); // 假设累计收益更高
        const mediumLongProfit = mediumLongTotal - 10000;
        
        document.getElementById('medium-long-total').textContent = `¥${mediumLongTotal.toFixed(2)}`;
        document.getElementById('medium-long-profit').textContent = 
          `+¥${mediumLongProfit.toFixed(2)} (${(totalChangePercent + 30).toFixed(2)}%)`;
      }
      
      // 填充其他统计数据
      const statsTable = document.querySelectorAll('.profit-card .space-y-2.text-sm');
      statsTable[0].innerHTML = `
        <div class="flex justify-between">
          <span class="text-neutral">黄金短线操作</span>
          <span>${Math.floor(Math.random() * 10) + 1}次</span>
        </div>
        <div class="flex justify-between">
          <span class="text-neutral">白银短线操作</span>
          <span>${Math.floor(Math.random() * 8) + 1}次</span>
        </div>
        <div class="flex justify-between">
          <span class="text-neutral">止盈操作占比</span>
          <span class="text-success">${Math.floor(Math.random() * 30) + 50}%</span>
        </div>
      `;
      
      statsTable[1].innerHTML = `
        <div class="flex justify-between">
          <span class="text-neutral">中线策略操作</span>
          <span>${Math.floor(Math.random() * 10) + 5}次</span>
        </div>
        <div class="flex justify-between">
          <span class="text-neutral">长线策略操作</span>
          <span>${Math.floor(Math.random() * 8) + 3}次</span>
        </div>
        <div class="flex justify-between">
          <span class="text-neutral">止盈胜率</span>
          <span class="text-success">${Math.floor(Math.random() * 20) + 60}%</span>
        </div>
      `;
    }

    // --------------------------
    // 页面加载完成后初始化
    // --------------------------
    document.addEventListener('DOMContentLoaded', function() {
      // 绑定刷新按钮事件
      document.getElementById('refresh-gold').addEventListener('click', function() {
        this.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-1"></i>刷新中';
        fetchCurrentPrices().then(() => {
          setTimeout(() => {
            this.innerHTML = '<i class="fa fa-refresh mr-1"></i>刷新';
          }, 1000);
        });
      });
      
      document.getElementById('refresh-silver').addEventListener('click', function() {
        this.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-1"></i>刷新中';
        fetchCurrentPrices().then(() => {
          setTimeout(() => {
            this.innerHTML = '<i class="fa fa-refresh mr-1"></i>刷新';
          }, 1000);
        });
      });
      
      // 初始加载数据
      fetchCurrentPrices();
      fetchHistoryData();
    });
  </script>
</body>
</html>
