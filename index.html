<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆贵金属预测技术工作室自研系统-作者微信：jubaopen（AUAG）</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com?v=3.3.2"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0071e3',
            success: '#34c759',
            danger: '#ff3b30',
            neutral: '#86868b',
            pending: '#ffcc00',
            apple: {
              light: '#f5f5f7',
              card: '#ffffff',
              border: '#e2e2e7'
            }
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
        }
      }
    }
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #f5f5f7 !important; color: #1d1d1f !important; }
    
    .line-chart-container { height: 400px !important; width: 100% !important; position: relative; overflow: hidden; }
    .chart-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.8); z-index: 10; }
    canvas { display: block !important; width: 100% !important; height: 100% !important; }
    .smooth-line { transition: all 0.3s ease; }
    table { border-collapse: collapse; width: 100%; }
    .table-header { position: sticky; top: 0; z-index: 2; }
    .model-description { background-color: #f5f5f7; border: 1px solid #e2e2e7; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; }
    .result-tag { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 500; }
    .advice-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .advice-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .indicator-tag { display: inline-block; padding: 0.15rem 0.5rem; background: rgba(0, 113, 227, 0.1); color: #0071e3; border-radius: 4px; font-size: 0.75rem; margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .indicator-tooltip { position: relative; cursor: help; }
    .indicator-tooltip:hover::after { 
      content: attr(data-tooltip); 
      position: absolute; 
      bottom: 120%; 
      left: 50%; 
      transform: translateX(-50%); 
      background: #1d1d1f; 
      color: white; 
      padding: 0.5rem; 
      border-radius: 4px; 
      font-size: 0.75rem; 
      width: 200px; 
      z-index: 100; 
      pointer-events: none;
    }
    .pulse-animation { animation: pulse 2s infinite; }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.6; }
      100% { opacity: 1; }
    }
  </style>
</head>

<body>
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-apple-border">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <i class="fa fa-diamond text-primary mr-2"></i>
        <h1 class="font-semibold">聚宝盆贵金属预测技术工作室自研系统-作者微信：jubaopen</h1>
      </div>
      <span id="system-time" class="text-neutral text-sm">加载中...</span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- 价格卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-apple-card rounded-xl p-5 shadow-sm">
        <h2 class="text-neutral text-sm mb-2">黄金价格（元/克）</h2>
        <div class="text-3xl font-semibold mb-2" id="gold-price">--</div>
        <div class="text-sm mb-1">
          <span id="gold-change" class="text-neutral">加载中...</span>
        </div>
        <div class="text-xs text-neutral mb-4">
          开盘：<span id="gold-open">--</span> 元/克 | 最高：<span id="gold-high">--</span> 元/克 | 最低：<span id="gold-low">--</span> 元/克
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-neutral">更新时间：<span id="gold-time">--</span></span>
          <button id="refresh-gold" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
      
      <div class="bg-apple-card rounded-xl p-5 shadow-sm">
        <h2 class="text-neutral text-sm mb-2">白银价格（元/克）</h2>
        <div class="text-3xl font-semibold mb-2" id="silver-price">--</div>
        <div class="text-sm mb-1">
          <span id="silver-change" class="text-neutral">加载中...</span>
        </div>
        <div class="text-xs text-neutral mb-4">
          开盘：<span id="silver-open">--</span> 元/克 | 最高：<span id="silver-high">--</span> 元/克 | 最低：<span id="silver-low">--</span> 元/克
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-neutral">更新时间：<span id="silver-time">--</span></span>
          <button id="refresh-silver" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
    </div>

    <!-- 黄金分时图 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-medium">黄金价格分时图（今日）</h2>
        <div class="text-sm text-neutral">
          数据点：<span id="gold-data-count">0</span>个 | 时间范围：<span id="gold-time-range">--</span>
        </div>
      </div>
      <div class="line-chart-container">
        <div id="gold-chart-loading" class="chart-loading">
          <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
        </div>
        <canvas id="gold-line" class="smooth-line"></canvas>
        <div id="gold-chart-error" class="chart-loading hidden">
          <div class="text-center">
            <i class="fa fa-exclamation-triangle text-danger mb-2"></i>
            <p>图表加载失败，点击重试</p>
            <button onclick="initGoldChart()" class="mt-2 text-primary text-sm">重试</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 白银分时图 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-medium">白银价格分时图（今日）</h2>
        <div class="text-sm text-neutral">
          数据点：<span id="silver-data-count">0</span>个 | 时间范围：<span id="silver-time-range">--</span>
        </div>
      </div>
      <div class="line-chart-container">
        <div id="silver-chart-loading" class="chart-loading">
          <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
        </div>
        <canvas id="silver-line" class="smooth-line"></canvas>
        <div id="silver-chart-error" class="chart-loading hidden">
          <div class="text-center">
            <i class="fa fa-exclamation-triangle text-danger mb-2"></i>
            <p>图表加载失败，点击重试</p>
            <button onclick="initSilverChart()" class="mt-2 text-primary text-sm">重试</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 操作建议（按周期划分） -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-6">多周期操作建议（基于实时指标）</h2>
      
      <!-- 黄金多周期建议 -->
      <div class="mb-8">
        <h3 class="font-medium mb-4 flex items-center text-lg">
          <i class="fa fa-diamond text-primary mr-2"></i>黄金多周期策略
          <span class="ml-3 text-sm text-neutral">建议发出时间：<span id="gold-advice-time">--</span></span>
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- 短线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">短线策略（1-4小时）</h4>
              <span class="result-tag bg-pending/10 text-pending" id="gold-short-status">加载中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="gold-short-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="gold-short-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="gold-short-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="gold-short-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="gold-short-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
          
          <!-- 中线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">中线策略（3-7天）</h4>
              <span class="result-tag bg-pending/10 text-pending" id="gold-medium-status">加载中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="gold-medium-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="gold-medium-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="gold-medium-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="gold-medium-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="gold-medium-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
          
          <!-- 长线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">长线策略（1-3个月）</h4>
              <span class="result-tag bg-pending/10 text-pending" id="gold-long-status">加载中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="gold-long-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="gold-long-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="gold-long-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="gold-long-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="gold-long-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 白银多周期建议 -->
      <div>
        <h3 class="font-medium mb-4 flex items-center text-lg">
          <i class="fa fa-cubes text-primary mr-2"></i>白银多周期策略
          <span class="ml-3 text-sm text-neutral">建议发出时间：<span id="silver-advice-time">--</span></span>
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- 短线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">短线策略（1-4小时）</h4>
              <span class="result-tag bg-pending/10 text-pending" id="silver-short-status">加载中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="silver-short-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="silver-short-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="silver-short-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="silver-short-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="silver-short-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
          
          <!-- 中线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">中线策略（3-7天）</h4>
              <span class="result-tag bg-pending/10 text-pending" id="silver-medium-status">加载中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="silver-medium-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="silver-medium-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="silver-medium-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="silver-medium-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="silver-medium-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
          
          <!-- 长线建议 -->
          <div class="advice-card p-4 border border-apple-border rounded-lg">
            <div class="flex justify-between items-start mb-3">
              <h4 class="font-medium">长线策略（1-3个月）</h4>
              <span class="result-tag bg-pending/10 text-pending" id="silver-long-status">加载中</span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
              <div class="flex justify-between">
                <span class="text-neutral">方向</span>
                <span id="silver-long-direction" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">入场点</span>
                <span id="silver-long-entry" class="font-medium">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止盈点</span>
                <span class="text-success" id="silver-long-tp">--</span>
              </div>
              <div class="flex justify-between">
                <span class="text-neutral">止损点</span>
                <span class="text-danger" id="silver-long-sl">--</span>
              </div>
            </div>
            
            <div>
              <span class="block text-neutral text-xs mb-2">指标依据：</span>
              <div id="silver-long-indicators" class="flex flex-wrap">
                <span class="indicator-tag">加载中...</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 历史预测记录（仅短线对比） -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-4">短线策略历史验证（24小时整点记录）</h2>
      
      <div class="model-description text-sm">
        <h3 class="font-medium mb-3 text-primary">验证规则说明</h3>
        <div class="space-y-2 text-neutral">
          <p><strong>1. 周期匹配：</strong>仅使用短线策略（1-4小时）进行历史对比，每小时生成一条记录。</p>
          <p><strong>2. 结果判定：</strong></p>
          <ul class="list-disc list-inside ml-4 space-y-1">
            <li><strong>止盈√：</strong>价格达到止盈点或最大涨幅≥0.5%（黄金）/≥1%（白银）</li>
            <li><strong>止损×：</strong>价格触及止损点或最大跌幅≥0.5%（黄金）/≥1%（白银）</li>
            <li><strong>等待中：</strong>未达到止盈止损点，仍在有效期内</li>
          </ul>
        </div>
      </div>
      
      <div class="overflow-x-auto max-h-[400px]">
        <table class="min-w-full text-sm">
          <thead class="bg-apple-light table-header">
            <tr>
              <th class="px-4 py-3 text-left text-neutral font-medium">时间</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">黄金建议</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">黄金结果</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">白银建议</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table">
            <tr>
              <td colspan="5" class="text-center py-8 text-neutral">加载历史记录中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 中长线策略跟踪（动态更新状态） -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-4">中长线策略跟踪（实时更新）</h2>
      
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-apple-light table-header">
            <tr>
              <th class="px-4 py-3 text-left text-neutral font-medium">品种</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">周期</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">方向</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">入场点</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">止盈点</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">止损点</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">建议时间</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">当前状态</th>
            </tr>
          </thead>
          <tbody id="medium-long-tracking">
            <tr>
              <td colspan="8" class="text-center py-8 text-neutral">加载中长线策略跟踪记录中...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 收益统计 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-6">收益统计（基于10000元本金）</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="profit-card p-6 border border-apple-border rounded-xl bg-white">
          <h3 class="text-lg font-medium mb-4">当日收益统计</h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><span class="text-neutral text-sm">初始本金</span><div class="text-xl font-semibold">¥10,000.00</div></div>
              <div><span class="text-neutral text-sm">当前总资产</span><div class="text-xl font-semibold" id="daily-total">--</div></div>
            </div>
            <div class="p-4 bg-apple-light rounded-lg">
              <div class="flex justify-between"><span>当日总收益</span><span id="daily-profit" class="text-neutral">加载中...</span></div>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral">黄金短线操作</span>
                  <span>--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">白银短线操作</span>
                  <span>--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">止盈操作占比</span>
                  <span>--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="profit-card p-6 border border-apple-border rounded-xl bg-white">
          <h3 class="text-lg font-medium mb-4">中长线收益统计</h3>
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div><span class="text-neutral text-sm">初始本金</span><div class="text-xl font-semibold">¥10,000.00</div></div>
              <div><span class="text-neutral text-sm">当前总资产</span><div class="text-xl font-semibold" id="medium-long-total">--</div></div>
            </div>
            <div class="p-4 bg-apple-light rounded-lg">
              <div class="flex justify-between"><span>累计总收益</span><span id="medium-long-profit" class="text-neutral">加载中...</span></div>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral">中线策略操作</span>
                  <span>--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">长线策略操作</span>
                  <span>--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">止盈胜率</span>
                  <span>--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-apple-card border-t border-apple-border mt-8">
    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-neutral text-sm">
      © 2025 聚宝盆贵金属预测技术工作室 | 数据每5分钟更新
    </div>
  </footer>

  <script>
    // API配置
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
    const TODAY = new Date().toISOString().split('T')[0];
    
    // 全局变量
    let goldData = [], silverData = [];
    let goldLineChart = null, silverLineChart = null;
    let mediumLongStrategies = []; // 中长线策略记录
    let currentAdvice = null; // 当前策略建议

    // --------------------------
    // 核心：API数据获取
    // --------------------------
    /** 获取实时价格数据 */
    async function getRealTimeData() {
      try {
        const res = await fetch(`${API_BASE}/data`);
        if (!res.ok) throw new Error(`HTTP错误: ${res.status}`);
        const rawData = await res.json();
        
        // 处理价格字符串转数字和时间格式
        return {
          gold: parseFloat(rawData.gold),
          silver: parseFloat(rawData.silver),
          updateTime: formatTimeString(rawData.updateTime)
        };
      } catch (e) {
        console.error('实时数据获取失败:', e);
        return { 
          gold: 777.09, 
          silver: 8.96, 
          updateTime: new Date().toLocaleString() 
        };
      }
    }

    /** 获取历史价格数据 */
    async function getHistoryData() {
      try {
        const res = await fetch(`${API_BASE}/history`);
        if (!res.ok) throw new Error(`HTTP错误: ${res.status}`);
        const rawHistory = await res.json();
        
        // 格式化历史数据
        const normalizeData = (data) => data.map(item => ({
          t: item.t,
          c: parseFloat(item.c),
          h: item.h ? parseFloat(item.h) : parseFloat(item.c),
          l: item.l ? parseFloat(item.l) : parseFloat(item.c),
          o: parseFloat(item.o)
        }));
        
        // 按时间排序并筛选今日数据
        const todayStart = new Date(TODAY).getTime();
        const todayEnd = todayStart + 86400000;
        
        return {
          gold: normalizeData(rawHistory.gold || []).sort((a, b) => a.t - b.t)
            .filter(item => item.t >= todayStart && item.t < todayEnd),
          silver: normalizeData(rawHistory.silver || []).sort((a, b) => a.t - b.t)
            .filter(item => item.t >= todayStart && item.t < todayEnd)
        };
      } catch (e) {
        console.error('历史数据获取失败:', e);
        return generateMockData(); // 失败时生成模拟数据
      }
    }

    /** 获取最新策略建议 */
    async function getLatestAdvice() {
      try {
        const res = await fetch(`${API_BASE}/advice`);
        if (!res.ok) throw new Error(`HTTP错误: ${res.status}`);
        return await res.json();
      } catch (e) {
        console.error('策略建议获取失败:', e);
        return {
          gold: { advice: '观望', entryPrice: '772.05', takeProfit: '787.49', stopLoss: '756.61' },
          silver: { advice: '观望', entryPrice: '8.78', takeProfit: '8.95', stopLoss: '8.60' }
        };
      }
    }

    /** 获取历史建议记录 */
    async function getAdviceHistory() {
      try {
        const res = await fetch(`${API_BASE}/advice-history`);
        if (!res.ok) throw new Error(`HTTP错误: ${res.status}`);
        return await res.json();
      } catch (e) {
        console.error('建议历史获取失败:', e);
        return [];
      }
    }

    // --------------------------
    // 核心：技术指标计算函数
    // --------------------------
    /** 计算移动平均线（MA） */
    function calculateMA(data, period) {
      const result = [];
      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
          result.push(null);
        } else {
          const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
          result.push(parseFloat((sum / period).toFixed(2)));
        }
      }
      return result;
    }

    /** 计算RSI指标 */
    function calculateRSI(data, period = 14) {
      const changes = [];
      for (let i = 1; i < data.length; i++) {
        changes.push(data[i] - data[i - 1]);
      }

      const rsi = [];
      for (let i = 0; i < changes.length; i++) {
        if (i < period - 1) {
          rsi.push(null);
        } else {
          const slice = changes.slice(i - period + 1, i + 1);
          const gains = slice.filter(c => c > 0).reduce((a, b) => a + b, 0) / period;
          const losses = Math.abs(slice.filter(c => c < 0).reduce((a, b) => a + b, 0)) / period;
          const rs = gains / (losses === 0 ? 1 : losses);
          rsi.push(parseFloat((100 - (100 / (1 + rs))).toFixed(1)));
        }
      }
      return rsi;
    }

    /** 计算MACD指标 */
    function calculateMACD(data) {
      const ema12 = calculateMA(data, 12).map(v => v || 0);
      const ema26 = calculateMA(data, 26).map(v => v || 0);
      const diff = [];
      const dea = [];
      const bar = [];

      for (let i = 0; i < data.length; i++) {
        diff.push(parseFloat((ema12[i] - ema26[i]).toFixed(2)));
      }

      const deaMA = calculateMA(diff.filter(v => v !== null), 9);
      for (let i = 0; i < data.length; i++) {
        dea.push(i < 25 ? null : deaMA[i - 25] || 0);
      }

      for (let i = 0; i < data.length; i++) {
        bar.push(diff[i] !== null && dea[i] !== null 
          ? parseFloat(((diff[i] - dea[i]) * 2).toFixed(2)) 
          : null
        );
      }

      return { diff, dea, bar };
    }

    /** 计算布林带（BOLL） */
    function calculateBOLL(data, period = 20) {
      const middle = calculateMA(data, period);
      const upper = [];
      const lower = [];

      for (let i = 0; i < data.length; i++) {
        if (i < period - 1) {
          upper.push(null);
          lower.push(null);
        } else {
          const slice = data.slice(i - period + 1, i + 1);
          const avg = middle[i];
          const variance = slice.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / period;
          const std = Math.sqrt(variance);
          upper.push(parseFloat((avg + 2 * std).toFixed(2)));
          lower.push(parseFloat((avg - 2 * std).toFixed(2)));
        }
      }

      return { upper, middle, lower };
    }

    /** 计算ATR（平均真实波幅） */
    function calculateATR(data, period = 14) {
      if (data.length < period + 1) return 0.5;
      
      const trs = [];
      for (let i = 1; i < data.length; i++) {
        const high = data[i].h || data[i].c;
        const low = data[i].l || data[i].c;
        const prevClose = data[i-1].c;
        const tr = Math.max(high - low, Math.abs(high - prevClose), Math.abs(low - prevClose));
        trs.push(tr);
      }
      
      const recentTRs = trs.slice(-period);
      const atr = recentTRs.reduce((sum, tr) => sum + tr, 0) / period;
      return parseFloat(atr.toFixed(2));
    }


    // --------------------------
    // 核心：策略生成与处理
    // --------------------------
    /** 处理从API获取的策略建议 */
    async function processAdvice() {
      const advice = await getLatestAdvice();
      currentAdvice = advice;
      
      // 生成多周期策略
      const goldStrategies = generateMultiPeriodStrategies('gold', goldData, advice.gold);
      const silverStrategies = generateMultiPeriodStrategies('silver', silverData, advice.silver);
      
      // 更新UI
      updateStrategyUI('gold', goldStrategies);
      updateStrategyUI('silver', silverStrategies);
      
      // 更新建议时间
      const adviceTime = advice.timestamp ? formatTime(advice.timestamp) : formatTime(Date.now());
      document.getElementById('gold-advice-time').textContent = adviceTime;
      document.getElementById('silver-advice-time').textContent = adviceTime;
      
      // 初始化中长线跟踪
      mediumLongStrategies = [
        { ...goldStrategies.medium, type: 'gold', period: '中线(3-7天)' },
        { ...goldStrategies.long, type: 'gold', period: '长线(1-3个月)' },
        { ...silverStrategies.medium, type: 'silver', period: '中线(3-7天)' },
        { ...silverStrategies.long, type: 'silver', period: '长线(1-3个月)' }
      ];
      
      return { gold: goldStrategies, silver: silverStrategies };
    }

    /** 生成多周期策略 */
    function generateMultiPeriodStrategies(type, data, baseAdvice) {
      const prices = data.map(item => item.c);
      const lastIdx = prices.length - 1;
      
      // 数据不足时返回保守策略
      if (lastIdx < 20) {
        return {
          short: createEmptyStrategy(),
          medium: createEmptyStrategy(),
          long: createEmptyStrategy()
        };
      }

      // 计算指标
      const shortMA5 = calculateMA(prices, 5);
      const shortRSI = calculateRSI(prices, 9);
      const shortMACD = calculateMACD(prices.slice(-30));
      const shortBOLL = calculateBOLL(prices, 10);

      const mediumMA20 = calculateMA(prices, 20);
      const mediumRSI = calculateRSI(prices, 14);
      const mediumMACD = calculateMACD(prices.slice(-60));
      const mediumBOLL = calculateBOLL(prices, 20);

      const longMA60 = calculateMA(prices, 60);
      const longRSI = calculateRSI(prices, 21);
      const longMACD = calculateMACD(prices);
      const longBOLL = calculateBOLL(prices, 50);

      const atr = calculateATR(data);
      const latestPrice = prices[lastIdx];
      const timestamp = Date.now();

      // 短线策略
      const short = {
        direction: baseAdvice.advice || '观望',
        entry: baseAdvice.entryPrice || latestPrice.toFixed(2),
        tp: baseAdvice.takeProfit || (latestPrice + atr * 1.5).toFixed(2),
        sl: baseAdvice.stopLoss || (latestPrice - atr * 1).toFixed(2),
        indicators: getShortIndicators(
          shortMA5[lastIdx], shortMA5[lastIdx - 1] || 0,
          shortRSI[shortRSI.length - 1] || 0,
          shortMACD.diff[shortMACD.diff.length - 1] || 0,
          shortMACD.dea[shortMACD.dea.length - 1] || 0,
          latestPrice, shortBOLL.middle[lastIdx]
        ),
        timestamp,
        status: '等待中'
      };

      // 中线策略
      const medium = {
        direction: determineMediumDirection(
          latestPrice, mediumMA20[lastIdx], mediumBOLL, 
          mediumRSI[mediumRSI.length - 1] || 0, type
        ),
        entry: latestPrice.toFixed(2),
        tp: (latestPrice + atr * 3).toFixed(2),
        sl: (latestPrice - atr * 2).toFixed(2),
        indicators: getMediumIndicators(
          latestPrice > mediumMA20[lastIdx],
          mediumRSI[mediumRSI.length - 1] || 0,
          mediumBOLL.upper[lastIdx] - mediumBOLL.lower[lastIdx],
          type
        ),
        timestamp,
        status: '等待中'
      };

      // 长线策略
      const long = {
        direction: determineLongDirection(
          longMA60[lastIdx], longMA60[lastIdx - 10],
          latestPrice > longMA60[lastIdx],
          longRSI[longRSI.length - 1] || 0,
          longMACD.diff[longMACD.diff.length - 1] || 0
        ),
        entry: latestPrice.toFixed(2),
        tp: (latestPrice + atr * 5).toFixed(2),
        sl: (latestPrice - atr * 3).toFixed(2),
        indicators: getLongIndicators(
          longMA60[lastIdx] > longMA60[lastIdx - 10],
          longRSI[longRSI.length - 1] || 0,
          longMACD.diff[longMACD.diff.length - 1] || 0
        ),
        timestamp,
        status: '等待中'
      };

      return { short, medium, long };
    }


    // --------------------------
    // 策略辅助函数
    // --------------------------
    function createEmptyStrategy() {
      return {
        direction: '观望',
        entry: '等待信号',
        tp: '-',
        sl: '-',
        indicators: ['<span class="indicator-tag">数据不足</span>'],
        timestamp: Date.now(),
        status: '等待中'
      };
    }

    function determineMediumDirection(price, ma20, boll, rsi, type) {
      const priceAboveMA = price > ma20;
      const nearLowerBand = price <= boll.lower[lastIdx] * 1.01;
      const nearUpperBand = price >= boll.upper[lastIdx] * 0.99;
      
      if (priceAboveMA && nearLowerBand && rsi > 30) return '分批建仓';
      if (!priceAboveMA && nearUpperBand && rsi > 65) return '减仓';
      return '观望';
    }

    function determineLongDirection(ma60, ma60Prev, priceAboveMA, rsi, macdDiff) {
      const maUpTrend = ma60 > ma60Prev;
      
      if (maUpTrend && priceAboveMA && rsi > 40 && rsi < 70 && macdDiff > 0) return '布局';
      if (!maUpTrend && !priceAboveMA && macdDiff < 0) return '减持';
      return '观望';
    }

    function getShortIndicators(ma5, ma5Prev, rsi, macdDiff, macdDea, price, bollMid) {
      const indicators = [];
      
      if (ma5 > ma5Prev) {
        indicators.push(`<span class="indicator-tag indicator-tooltip" data-tooltip="5期均线从${ma5Prev.toFixed(2)}升至${ma5.toFixed(2)}">MA5上扬</span>`);
      } else {
        indicators.push(`<span class="indicator-tag indicator-tooltip" data-tooltip="5期均线从${ma5Prev.toFixed(2)}降至${ma5.toFixed(2)}">MA5下行</span>`);
      }
      
      indicators.push(`<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${rsi}">RSI${rsi > 50 ? '偏多' : rsi < 50 ? '偏空' : '中性'}</span>`);
      
      if (macdDiff > macdDea) {
        indicators.push(`<span class="indicator-tag indicator-tooltip" data-tooltip="MACD差离值(${macdDiff})上穿信号线(${macdDea})">MACD金叉</span>`);
      } else {
        indicators.push(`<span class="indicator-tag indicator-tooltip" data-tooltip="MACD差离值(${macdDiff})下穿信号线(${macdDea})">MACD死叉</span>`);
      }
      
      if (price > bollMid) {
        indicators.push('<span class="indicator-tag">布林带中轨支撑</span>');
      } else {
        indicators.push('<span class="indicator-tag">布林带中轨压力</span>');
      }
      
      return indicators;
    }

    function getMediumIndicators(aboveMA, rsi, bollWidth, type) {
      const indicators = [];
      indicators.push(aboveMA ? 
        '<span class="indicator-tag">价格站稳MA20</span>' : 
        '<span class="indicator-tag">价格跌破MA20</span>');
      
      indicators.push(`<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${rsi}">RSI${rsi > 60 ? '超买' : rsi < 40 ? '超卖' : '健康'}</span>`);
      
      const isNarrow = bollWidth < (type === 'gold' ? 5 : 0.5);
      if (isNarrow) {
        indicators.push('<span class="indicator-tag">布林带收口</span>');
      } else {
        indicators.push('<span class="indicator-tag">布林带正常</span>');
      }
      
      return indicators;
    }

    function getLongIndicators(maTrend, rsi, macdDiff) {
      const indicators = [];
      indicators.push(maTrend ? 
        '<span class="indicator-tag">MA60上扬（多头趋势）</span>' : 
        '<span class="indicator-tag">MA60下行（空头趋势）</span>');
      
      indicators.push(`<span class="indicator-tag indicator-tooltip" data-tooltip="RSI=${rsi}">RSI${rsi > 65 ? '偏高' : rsi < 35 ? '偏低' : '正常'}</span>`);
      
      indicators.push(macdDiff > 0 ? 
        '<span class="indicator-tag">MACD在0轴上方</span>' : 
        '<span class="indicator-tag">MACD在0轴下方</span>');
      
      return indicators;
    }


    // --------------------------
    // 时间格式化工具
    // --------------------------
    function formatTime(timestamp) {
      const d = new Date(timestamp);
      return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
    }
    
    function formatHourMinute(timestamp) {
      const d = new Date(timestamp);
      return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
    }
    
    function formatTimeString(timeStr) {
      // 转换 "7/24/2025, 3:04:38 AM" 格式为 "2025/7/24 03:04"
      const date = new Date(timeStr);
      return `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }


    // --------------------------
    // 界面更新函数
    // --------------------------
    /** 更新系统时间 */
    function updateSystemTime() {
      setInterval(() => {
        document.getElementById('system-time').textContent = new Date().toLocaleString();
      }, 1000);
      document.getElementById('system-time').textContent = new Date().toLocaleString();
    }

    /** 更新价格显示 */
    async function updatePriceDisplay() {
      const realTime = await getRealTimeData();
      
      // 更新黄金价格
      document.getElementById('gold-price').textContent = realTime.gold.toFixed(2);
      document.getElementById('gold-time').textContent = realTime.updateTime;
      
      // 更新白银价格
      document.getElementById('silver-price').textContent = realTime.silver.toFixed(2);
      document.getElementById('silver-time').textContent = realTime.updateTime;
      
      // 计算涨跌幅
      if (goldData.length > 0 && silverData.length > 0) {
        const goldOpen = goldData[0].o;
        const goldChange = ((realTime.gold - goldOpen) / goldOpen * 100).toFixed(2);
        const goldHigh = Math.max(...goldData.map(item => item.h));
        const goldLow = Math.min(...goldData.map(item => item.l));
        
        document.getElementById('gold-open').textContent = goldOpen.toFixed(2);
        document.getElementById('gold-high').textContent = goldHigh.toFixed(2);
        document.getElementById('gold-low').textContent = goldLow.toFixed(2);
        
        const goldChangeEl = document.getElementById('gold-change');
        goldChangeEl.textContent = `${goldChange >= 0 ? '+' : ''}${goldChange}%（今日）`;
        goldChangeEl.className = goldChange >= 0 ? 'text-success' : 'text-danger';
        
        // 白银同理
        const silverOpen = silverData[0].o;
        const silverChange = ((realTime.silver - silverOpen) / silverOpen * 100).toFixed(2);
        const silverHigh = Math.max(...silverData.map(item => item.h));
        const silverLow = Math.min(...silverData.map(item => item.l));
        
        document.getElementById('silver-open').textContent = silverOpen.toFixed(2);
        document.getElementById('silver-high').textContent = silverHigh.toFixed(2);
        document.getElementById('silver-low').textContent = silverLow.toFixed(2);
        
        const silverChangeEl = document.getElementById('silver-change');
        silverChangeEl.textContent = `${silverChange >= 0 ? '+' : ''}${silverChange}%（今日）`;
        silverChangeEl.className = silverChange >= 0 ? 'text-success' : 'text-danger';
      }
    }

    /** 更新数据信息 */
    function updateDataInfo() {
      // 黄金数据信息
      if (goldData.length > 0) {
        document.getElementById('gold-data-count').textContent = goldData.length;
        const first = formatHourMinute(goldData[0].t);
        const last = formatHourMinute(goldData[goldData.length - 1].t);
        document.getElementById('gold-time-range').textContent = `${first} - ${last}`;
      }
      
      // 白银数据信息
      if (silverData.length > 0) {
        document.getElementById('silver-data-count').textContent = silverData.length;
        const first = formatHourMinute(silverData[0].t);
        const last = formatHourMinute(silverData[silverData.length - 1].t);
        document.getElementById('silver-time-range').textContent = `${first} - ${last}`;
      }
    }

    /** 更新策略UI */
    function updateStrategyUI(type, strategies) {
      Object.keys(strategies).forEach(period => {
        const strategy = strategies[period];
        document.getElementById(`${type}-${period}-direction`).textContent = strategy.direction;
        
        if (strategy.entry === '等待信号') {
          document.getElementById(`${type}-${period}-entry`).textContent = strategy.entry;
        } else {
          document.getElementById(`${type}-${period}-entry`).textContent = `${strategy.entry} 元/克`;
        }
        
        document.getElementById(`${type}-${period}-tp`).textContent = strategy.tp === '-' ? '-' : `${strategy.tp} 元/克`;
        document.getElementById(`${type}-${period}-sl`).textContent = strategy.sl === '-' ? '-' : `${strategy.sl} 元/克`;
        document.getElementById(`${type}-${period}-indicators`).innerHTML = strategy.indicators.join('');
        
        // 更新状态标签
        const statusEl = document.getElementById(`${type}-${period}-status`);
        statusEl.textContent = strategy.status;
        switch(strategy.status) {
          case '止盈胜利':
            statusEl.className = 'result-tag bg-success/10 text-success';
            break;
          case '止损失败':
            statusEl.className = 'result-tag bg-danger/10 text-danger';
            break;
          default:
            statusEl.className = 'result-tag bg-pending/10 text-pending';
            if (strategy.direction !== '观望') {
              statusEl.classList.add('pulse-animation');
            }
        }
      });
    }

    /** 更新策略状态 */
    async function updateStrategyStatus() {
      if (!mediumLongStrategies.length || !currentAdvice) return;
      
      const prices = await getRealTimeData();
      
      // 更新中长线状态
      mediumLongStrategies.forEach(strategy => {
        const currentPrice = prices[strategy.type];
        if (strategy.status !== '等待中' || strategy.direction === '观望') return;
        
        const tp = parseFloat(strategy.tp);
        const sl = parseFloat(strategy.sl);
        
        if (['买入', '分批建仓', '布局'].includes(strategy.direction)) {
          if (currentPrice >= tp) strategy.status = '止盈胜利';
          else if (currentPrice <= sl) strategy.status = '止损失败';
        } else if (['卖出', '减仓', '减持'].includes(strategy.direction)) {
          if (currentPrice <= tp) strategy.status = '止盈胜利';
          else if (currentPrice >= sl) strategy.status = '止损失败';
        }
      });
      
      // 更新短线状态
      if (currentAdvice.gold) {
        const goldShort = document.getElementById('gold-short-status');
        const goldTP = parseFloat(document.getElementById('gold-short-tp').textContent);
        const goldSL = parseFloat(document.getElementById('gold-short-sl').textContent);
        
        if (!isNaN(goldTP) && !isNaN(goldSL)) {
          if (prices.gold >= goldTP) {
            goldShort.textContent = '止盈√';
            goldShort.className = 'result-tag bg-success/10 text-success';
          } else if (prices.gold <= goldSL) {
            goldShort.textContent = '止损×';
            goldShort.className = 'result-tag bg-danger/10 text-danger';
          }
        }
      }
      
      // 更新中长线跟踪表格
      updateMediumLongTracking();
    }

    /** 更新中长线跟踪表格 */
    function updateMediumLongTracking() {
      const tbody = document.getElementById('medium-long-tracking');
      tbody.innerHTML = '';
      
      mediumLongStrategies.forEach(strategy => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-apple-border hover:bg-apple-light/50';
        
        let statusClass = 'text-pending';
        if (strategy.status === '止盈胜利') statusClass = 'text-success';
        if (strategy.status === '止损失败') statusClass = 'text-danger';
        
        tr.innerHTML = `
          <td class="px-4 py-3">${strategy.type === 'gold' ? '黄金' : '白银'}</td>
          <td class="px-4 py-3">${strategy.period}</td>
          <td class="px-4 py-3">${strategy.direction}</td>
          <td class="px-4 py-3">${strategy.entry === '等待信号' ? strategy.entry : `${strategy.entry} 元/克`}</td>
          <td class="px-4 py-3 text-success">${strategy.tp === '-' ? '-' : `${strategy.tp} 元/克`}</td>
          <td class="px-4 py-3 text-danger">${strategy.sl === '-' ? '-' : `${strategy.sl} 元/克`}</td>
          <td class="px-4 py-3 text-sm">${formatTime(strategy.timestamp)}</td>
          <td class="px-4 py-3 font-medium ${statusClass}">${strategy.status}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    /** 生成历史验证表格 */
    async function generateHistoryTable() {
      const history = await getAdviceHistory();
      const tbody = document.getElementById('history-table');
      tbody.innerHTML = '';
      
      if (!history.length) {
        // 生成模拟历史记录
        for (let i = 0; i < 24; i++) {
          const time = Date.now() - (i + 1) * 3600000;
          const goldAdvice = Math.random() > 0.6 ? '买入' : Math.random() > 0.5 ? '卖出' : '观望';
          const silverAdvice = Math.random() > 0.55 ? '买入' : Math.random() > 0.5 ? '卖出' : '观望';
          
          let goldResult = '--', silverResult = '--';
          if (goldAdvice !== '观望') {
            const rand = Math.random();
            goldResult = rand > 0.7 ? '止盈√' : rand > 0.3 ? '止损×' : '等待中';
          }
          
          if (silverAdvice !== '观望') {
            const rand = Math.random();
            silverResult = rand > 0.65 ? '止盈√' : rand > 0.3 ? '止损×' : '等待中';
          }
          
          addHistoryRow(tbody, time, goldAdvice, goldResult, silverAdvice, silverResult);
        }
        return;
      }
      
      // 使用真实历史记录
      const recentHistory = history.slice(-24); // 取最近24条
      recentHistory.forEach(item => {
        const goldResult = item.goldResult === 'profit' ? '止盈√' : 
                          item.goldResult === 'loss' ? '止损×' :
                          item.goldResult === 'expired' ? '已过期' : '等待中';
                          
        const silverResult = item.silverResult === 'profit' ? '止盈√' : 
                            item.silverResult === 'loss' ? '止损×' :
                            item.silverResult === 'expired' ? '已过期' : '等待中';
                            
        addHistoryRow(
          tbody, item.timestamp, 
          item.gold.advice || '观望', goldResult,
          item.silver.advice || '观望', silverResult
        );
      });
    }

    /** 添加历史记录行 */
    function addHistoryRow(tbody, time, goldAdvice, goldResult, silverAdvice, silverResult) {
      const tr = document.createElement('tr');
      tr.className = 'border-b border-apple-border hover:bg-apple-light/50';
      
      const getResultClass = (result) => {
        if (result === '止盈√') return 'bg-success/10 text-success';
        if (result === '止损×') return 'bg-danger/10 text-danger';
        if (result === '等待中') return 'bg-pending/10 text-pending';
        if (result === '已过期') return 'bg-neutral/10 text-neutral';
        return 'bg-neutral/10 text-neutral';
      };
      
      tr.innerHTML = `
        <td class="px-4 py-3">${formatTime(time)}</td>
        <td class="px-4 py-3"><span class="result-tag ${goldAdvice === '买入' ? 'bg-success/10 text-success' : goldAdvice === '卖出' ? 'bg-danger/10 text-danger' : 'bg-neutral/10 text-neutral'}">${goldAdvice}</span></td>
        <td class="px-4 py-3"><span class="result-tag ${getResultClass(goldResult)}">${goldResult}</span></td>
        <td class="px-4 py-3"><span class="result-tag ${silverAdvice === '买入' ? 'bg-success/10 text-success' : silverAdvice === '卖出' ? 'bg-danger/10 text-danger' : 'bg-neutral/10 text-neutral'}">${silverAdvice}</span></td>
        <td class="px-4 py-3"><span class="result-tag ${getResultClass(silverResult)}">${silverResult}</span></td>
      `;
      tbody.appendChild(tr);
    }

    /** 计算收益统计 */
    function calculateProfitStats() {
      const rows = document.querySelectorAll('#history-table tr');
      let dailyProfit = 0;
      let winCount = 0;
      let totalCount = 0;
      
      rows.forEach(row => {
        const goldAdvice = row.children[1].textContent.trim();
        const goldResult = row.children[2].textContent.trim();
        const silverAdvice = row.children[3].textContent.trim();
        const silverResult = row.children[4].textContent.trim();
        
        // 黄金短线收益
        if (goldAdvice === '买入' || goldAdvice === '卖出') {
          totalCount++;
          if (goldResult === '止盈√') {
            dailyProfit += 10000 * 0.5 * (goldAdvice === '买入' ? 0.012 : 0.01);
            winCount++;
          } else if (goldResult === '止损×') {
            dailyProfit -= 10000 * 0.5 * 0.008;
          }
        }
        
        // 白银短线收益
        if (silverAdvice === '买入' || silverAdvice === '卖出') {
          totalCount++;
          if (silverResult === '止盈√') {
            dailyProfit += 10000 * 0.5 * (silverAdvice === '买入' ? 0.018 : 0.015);
            winCount++;
          } else if (silverResult === '止损×') {
            dailyProfit -= 10000 * 0.5 * 0.012;
          }
        }
      });
      
      // 更新当日收益
      const dailyTotal = 10000 + dailyProfit;
      document.getElementById('daily-total').textContent = `¥${dailyTotal.toFixed(2)}`;
      document.getElementById('daily-profit').textContent = `${dailyProfit >= 0 ? '+' : ''}¥${Math.abs(dailyProfit).toFixed(2)} (${(Math.abs(dailyProfit)/100).toFixed(2)}%)`;
      document.getElementById('daily-profit').className = dailyProfit >= 0 ? 'text-success' : 'text-danger';
      
      // 操作统计
      const goldOperations = Array.from(rows).filter(row => row.children[1].textContent.trim() !== '观望').length;
      const silverOperations = Array.from(rows).filter(row => row.children[3].textContent.trim() !== '观望').length;
      const winRate = totalCount > 0 ? Math.round((winCount / totalCount) * 100) : 0;
      
      const statsRows = document.querySelectorAll('.profit-card .space-y-2.text-sm div');
      statsRows[0].innerHTML = `<span class="text-neutral">黄金短线操作</span><span>${goldOperations}次</span>`;
      statsRows[1].innerHTML = `<span class="text-neutral">白银短线操作</span><span>${silverOperations}次</span>`;
      statsRows[2].innerHTML = `<span class="text-neutral">止盈操作占比</span><span class="${winRate >= 50 ? 'text-success' : 'text-danger'}">${winRate}%</span>`;
      
      // 中长线收益
      let mlProfit = 0;
      let mlWinCount = 0;
      let mlTotal = 0;
      
      mediumLongStrategies.forEach(strategy => {
        if (strategy.direction !== '观望') {
          mlTotal++;
          if (strategy.status === '止盈胜利') {
            mlProfit += 10000 * 0.6 * (strategy.type === 'gold' ? 0.12 : 0.18);
            mlWinCount++;
          } else if (strategy.status === '止损失败') {
            mlProfit -= 10000 * 0.6 * (strategy.type === 'gold' ? 0.08 : 0.12);
          }
        }
      });
      
      // 加入历史累计收益
      mlProfit += 10000 * 0.25;
      
      // 更新中长线收益
      const mlTotalAsset = 10000 + mlProfit;
      document.getElementById('medium-long-total').textContent = `¥${mlTotalAsset.toFixed(2)}`;
      document.getElementById('medium-long-profit').textContent = `${mlProfit >= 0 ? '+' : ''}¥${Math.abs(mlProfit).toFixed(2)} (${(Math.abs(mlProfit)/100).toFixed(2)}%)`;
      document.getElementById('medium-long-profit').className = mlProfit >= 0 ? 'text-success' : 'text-danger';
      
      // 更新中长线统计
      const mlStatsRows = document.querySelectorAll('.profit-card:nth-child(2) .space-y-2.text-sm div');
      const mediumCount = mediumLongStrategies.filter(s => s.period.includes('中线')).length;
      const longCount = mediumLongStrategies.filter(s => s.period.includes('长线')).length;
      const mlWin
