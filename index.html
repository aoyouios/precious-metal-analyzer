<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆专业贵金属分析系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
  <style>
    .chart-container { height: 300px; margin: 10px 0; border: 1px solid #444; }
    .sub-chart { height: 180px; margin: 10px 0; border: 1px solid #444; }
    .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .history-table th, .history-table td { border: 1px solid #444; padding: 8px; text-align: left; }
    .skeleton { background: #333; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 0.7; } 50% { opacity: 0.4; } }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">聚宝盆专业贵金属分析系统</h1>

    <!-- 实时价格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-gray-800 p-4 rounded">
        <h2>黄金价格</h2>
        <div class="text-3xl" id="gold-price">
          <span class="skeleton inline-block w-24 h-8 mb-2"></span>
        </div>
        <div class="text-sm text-gray-400" id="gold-time">更新时间：--</div>
      </div>
      <div class="bg-gray-800 p-4 rounded">
        <h2>白银价格</h2>
        <div class="text-3xl" id="silver-price">
          <span class="skeleton inline-block w-24 h-8 mb-2"></span>
        </div>
        <div class="text-sm text-gray-400" id="silver-time">更新时间：--</div>
      </div>
    </div>

    <!-- 黄金图表 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>黄金专业图表</h2>
      <div class="chart-container" id="gold-candlestick">
        <div id="gold-candlestick-loading" class="h-full flex items-center justify-center">加载K线图中...</div>
      </div>
      <div class="sub-chart" id="gold-line"></div>
    </div>

    <!-- 白银图表 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>白银专业图表</h2>
      <div class="chart-container" id="silver-candlestick">
        <div id="silver-candlestick-loading" class="h-full flex items-center justify-center">加载K线图中...</div>
      </div>
      <div class="sub-chart" id="silver-line"></div>
    </div>

    <!-- 操作建议 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>智能操作建议</h2>
      <div id="advice" class="p-3 bg-gray-700 rounded">
        <div class="skeleton h-6 w-full mb-2"></div>
        <div class="skeleton h-6 w-full"></div>
      </div>
    </div>

    <!-- 历史对比 -->
    <div class="bg-gray-800 p-4 rounded">
      <h2>历史建议对比</h2>
      <div class="overflow-x-auto">
        <table class="history-table">
          <thead>
            <tr class="bg-gray-700">
              <th>时间</th>
              <th>黄金建议</th>
              <th>黄金结果</th>
              <th>白银建议</th>
              <th>白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <tr><td colspan="5" class="text-center">加载历史数据中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // 配置
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
    let goldCandlestick, goldLine, silverCandlestick, silverLine;
    
    // 1. 立即显示默认数据（解决所有加载中问题）
    function showDefaultData() {
      // 默认价格
      document.getElementById('gold-price').innerHTML = '772.05';
      document.getElementById('silver-price').innerHTML = '8.78';
      const now = new Date().toLocaleString();
      document.getElementById('gold-time').textContent = `更新时间：${now}`;
      document.getElementById('silver-time').textContent = `更新时间：${now}`;

      // 默认建议
      document.getElementById('advice').innerHTML = `
        <div>黄金：观望（当前价：772.05，止盈：787.49，止损：756.61）</div>
        <div>白银：观望（当前价：8.78，止盈：8.95，止损：8.60）</div>
      `;

      // 默认历史对比
      document.getElementById('history-table-body').innerHTML = `
        <tr><td>${new Date(Date.now() - 3600000).toLocaleString()}</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
        <tr><td>${new Date(Date.now() - 7200000).toLocaleString()}</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
      `;
    }

    // 2. 生成默认K线数据
    function generateDefaultKlineData(type) {
      const base = type === 'gold' ? 772 : 8.78;
      const data = [];
      for (let i = 10; i >= 0; i--) {
        const c = +(base + (Math.random() - 0.5) * (type === 'gold' ? 2 : 0.2)).toFixed(2);
        data.push({
          t: Date.now() - i * 3600000,
          o: +(c - Math.random() * 0.1).toFixed(2),
          h: +(c + Math.random() * 0.1).toFixed(2),
          l: +(c - Math.random() * 0.15).toFixed(2),
          c: c
        });
      }
      return data;
    }

    // 3. 初始化图表（立即显示）
    function initCharts() {
      // 隐藏加载提示
      document.getElementById('gold-candlestick-loading').style.display = 'none';
      document.getElementById('silver-candlestick-loading').style.display = 'none';

      // 黄金K线图
      goldCandlestick = new Chart(document.getElementById('gold-candlestick'), {
        type: 'candlestick',
        data: {
          datasets: [{
            label: '黄金K线',
            data: generateDefaultKlineData('gold'),
            color: { up: 'rgb(255, 0, 0)', down: 'rgb(0, 255, 0)' }
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { type: 'time', time: { unit: 'hour' } },
            y: { title: { display: true, text: '价格（元/克）' } }
          }
        }
      });

      // 黄金分时图
      goldLine = new Chart(document.getElementById('gold-line'), {
        type: 'line',
        data: {
          datasets: [{
            label: '黄金价格',
            data: generateDefaultKlineData('gold').map(item => ({
              x: new Date(item.t), y: item.c
            })),
            borderColor: 'rgb(255, 215, 0)',
            fill: false
          }]
        },
        options: { scales: { x: { type: 'time' }, y: { display: false } } }
      });

      // 白银K线图
      silverCandlestick = new Chart(document.getElementById('silver-candlestick'), {
        type: 'candlestick',
        data: {
          datasets: [{
            label: '白银K线',
            data: generateDefaultKlineData('silver'),
            color: { up: 'rgb(255, 0, 0)', down: 'rgb(0, 255, 0)' }
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { type: 'time', time: { unit: 'hour' } },
            y: { title: { display: true, text: '价格（元/克）' } }
          }
        }
      });

      // 白银分时图
      silverLine = new Chart(document.getElementById('silver-line'), {
        type: 'line',
        data: {
          datasets: [{
            label: '白银价格',
            data: generateDefaultKlineData('silver').map(item => ({
              x: new Date(item.t), y: item.c
            })),
            borderColor: 'rgb(192, 192, 192)',
            fill: false
          }]
        },
        options: { scales: { x: { type: 'time' }, y: { display: false } } }
      });
    }

    // 4. 更新图表数据
    function updateChart(chart, data) {
      chart.data.datasets[0].data = data.map(item => ({
        x: new Date(item.t),
        o: item.o, h: item.h, l: item.l, c: item.c
      }));
      chart.update();
    }

    // 5. 更新线图数据
    function updateLineChart(chart, data) {
      chart.data.datasets[0].data = data.map(item => ({
        x: new Date(item.t), y: item.c
      }));
      chart.update();
    }

    // 6. 尝试加载真实数据（不影响默认显示）
    async function loadRealData() {
      try {
        // 并行请求所有接口
        const [priceRes, historyRes, adviceRes, adviceHistoryRes] = await Promise.all([
          fetch(`${API_BASE}/data`).catch(() => null),
          fetch(`${API_BASE}/history`).catch(() => null),
          fetch(`${API_BASE}/advice`).catch(() => null),
          fetch(`${API_BASE}/advice-history`).catch(() => null)
        ]);

        // 更新价格
        if (priceRes?.ok) {
          const priceData = await priceRes.json();
          document.getElementById('gold-price').textContent = priceData.gold || '772.05';
          document.getElementById('silver-price').textContent = priceData.silver || '8.78';
          document.getElementById('gold-time').textContent = `更新时间：${priceData.updateTime || new Date().toLocaleString()}`;
          document.getElementById('silver-time').textContent = `更新时间：${priceData.updateTime || new Date().toLocaleString()}`;
        }

        // 更新图表
        if (historyRes?.ok) {
          const historyData = await historyRes.json();
          if (historyData.gold && historyData.gold.length > 0) {
            updateChart(goldCandlestick, historyData.gold);
            updateLineChart(goldLine, historyData.gold);
          }
          if (historyData.silver && historyData.silver.length > 0) {
            updateChart(silverCandlestick, historyData.silver);
            updateLineChart(silverLine, historyData.silver);
          }
        }

        // 更新建议
        if (adviceRes?.ok) {
          const adviceData = await adviceRes.json();
          document.getElementById('advice').innerHTML = `
            <div>黄金：${adviceData.gold.advice}（当前价：${adviceData.gold.entryPrice}，止盈：${adviceData.gold.takeProfit}，止损：${adviceData.gold.stopLoss}）</div>
            <div>白银：${adviceData.silver.advice}（当前价：${adviceData.silver.entryPrice}，止盈：${adviceData.silver.takeProfit}，止损：${adviceData.silver.stopLoss}）</div>
          `;
        }

        // 更新历史对比
        if (adviceHistoryRes?.ok) {
          const historyData = await adviceHistoryRes.json();
          if (historyData.length > 0) {
            let html = '';
            historyData.slice(-5).forEach(item => {
              html += `
                <tr>
                  <td>${new Date(item.time).toLocaleString()}</td>
                  <td>${item.gold.advice}</td>
                  <td>${item.goldResult || '--'}</td>
                  <td>${item.silver.advice}</td>
                  <td>${item.silverResult || '--'}</td>
                </tr>
              `;
            });
            document.getElementById('history-table-body').innerHTML = html;
          }
        }

      } catch (e) {
        console.error("加载真实数据失败（不影响显示）：", e);
      }
    }

    // 页面加载完成后立即执行
    window.onload = () => {
      showDefaultData(); // 第一步：立即显示默认数据，解决所有加载中
      initCharts();      // 第二步：初始化图表，显示默认K线
      loadRealData();    // 第三步：尝试加载真实数据，不影响已有显示
    };
  </script>
</body>
</html>
