<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>聚宝盆贵金属预测技术工作室自研系统</title>
  <!-- 依赖库 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
  <!-- Tailwind CSS（专业样式） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 分时图容器强化 */
    .chart-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      padding: 24px;
      margin: 20px 0;
    }
    .chart-canvas {
      height: 350px !important;
    }
    /* 系统名称样式 */
    .system-title {
      font-size: 24px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 20px;
      border-left: 6px solid #4299e1;
      padding-left: 10px;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- 系统名称模块 -->
  <div class="container mx-auto px-4">
    <h1 class="system-title">聚宝盆贵金属预测技术工作室自研系统</h1>

    <!-- 实时价格模块 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
      <div class="chart-card p-6">
        <h2 class="text-xl font-semibold mb-4">黄金实时行情</h2>
        <div class="text-3xl font-bold mb-2" id="gold-price">-- 元/克</div>
        <div class="text-gray-500" id="gold-update-time">加载中...</div>
        <div class="mt-4 grid grid-cols-3 gap-2 text-sm">
          <div class="bg-gray-50 p-2 rounded">
            <p class="text-gray-600">开盘</p>
            <p class="font-medium" id="gold-open">--</p>
          </div>
          <div class="bg-gray-50 p-2 rounded">
            <p class="text-gray-600">最高</p>
            <p class="font-medium text-green-600" id="gold-high">--</p>
          </div>
          <div class="bg-gray-50 p-2 rounded">
            <p class="text-gray-600">最低</p>
            <p class="font-medium text-red-600" id="gold-low">--</p>
          </div>
        </div>
      </div>
      <div class="chart-card p-6">
        <h2 class="text-xl font-semibold mb-4">白银实时行情</h2>
        <div class="text-3xl font-bold mb-2" id="silver-price">-- 元/克</div>
        <div class="text-gray-500" id="silver-update-time">加载中...</div>
        <div class="mt-4 grid grid-cols-3 gap-2 text-sm">
          <div class="bg-gray-50 p-2 rounded">
            <p class="text-gray-600">开盘</p>
            <p class="font-medium" id="silver-open">--</p>
          </div>
          <div class="bg-gray-50 p-2 rounded">
            <p class="text-gray-600">最高</p>
            <p class="font-medium text-green-600" id="silver-high">--</p>
          </div>
          <div class="bg-gray-50 p-2 rounded">
            <p class="text-gray-600">最低</p>
            <p class="font-medium text-red-600" id="silver-low">--</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 分时图模块（含时间范围切换） -->
    <div class="chart-card">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold">价格分时图</h2>
        <div class="flex space-x-2">
          <button class="px-4 py-2 rounded-lg bg-blue-500 text-white active:bg-blue-600" 
                  id="range-today">今日</button>
          <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300" 
                  id="range-3day">3日</button>
          <button class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300" 
                  id="range-1week">1周</button>
        </div>
      </div>
      <div class="bg-white rounded-lg p-4">
        <canvas id="goldChart" class="chart-canvas"></canvas>
      </div>
      <div class="bg-white rounded-lg p-4 mt-4">
        <canvas id="silverChart" class="chart-canvas"></canvas>
      </div>
    </div>

    <!-- 投资建议模块 -->
    <div class="chart-card p-6">
      <h2 class="text-xl font-semibold mb-4">投资操作建议</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-gray-50 p-4 rounded">
          <h3 class="text-lg font-semibold mb-2">黄金</h3>
          <p class="text-gray-700" id="gold-advice">加载中...</p>
          <div class="mt-3 text-sm text-gray-500">
            <p>止盈：<span id="gold-take-profit" class="text-green-600">--</span></p>
            <p>止损：<span id="gold-stop-loss" class="text-red-600">--</span></p>
          </div>
        </div>
        <div class="bg-gray-50 p-4 rounded">
          <h3 class="text-lg font-semibold mb-2">白银</h3>
          <p class="text-gray-700" id="silver-advice">加载中...</p>
          <div class="mt-3 text-sm text-gray-500">
            <p>止盈：<span id="silver-take-profit" class="text-green-600">--</span></p>
            <p>止损：<span id="silver-stop-loss" class="text-red-600">--</span></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 后端接口配置（根据实际修改）
    const API = {
      HISTORY: '/history',   // 历史数据接口
      REAL_TIME: '/data',    // 实时价格接口
      ADVICE: '/advice'      // 投资建议接口
    };

    // 全局状态
    let goldHistory = [];    // 黄金历史数据（原始）
    let silverHistory = [];  // 白银历史数据（原始）
    let goldChart = null;    // Chart.js实例
    let silverChart = null;  // Chart.js实例

    // 初始化图表（核心模块）
    function initChartInstance(canvasId, label, color) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      return new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: label,
            data: [],
            borderColor: color,
            backgroundColor: color + '20', // 带透明度的背景
            fill: true,
            tension: 0.2,
            pointRadius: 0,
            lineWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: (ctx) => `${label}: ${ctx.raw.y.toFixed(2)} 元/克`
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'minute',
                displayFormats: { minute: 'HH:mm' },
                tooltipFormat: 'MMM D, HH:mm'
              },
              grid: { display: false }
            },
            y: {
              title: { text: '价格 (元/克)' },
              grid: { color: '#eee' }
            }
          }
        }
      });
    }

    // 更新图表数据（根据时间范围过滤）
    function updateChart(chart, data, range) {
      const now = new Date();
      let filterTime;

      switch (range) {
        case 'today':
          filterTime = now.setHours(0, 0, 0, 0); // 今日0点
          break;
        case '3day':
          filterTime = now.getTime() - 3 * 24 * 60 * 60 * 1000;
          break;
        case '1week':
          filterTime = now.getTime() - 7 * 24 * 60 * 60 * 1000;
          break;
        default:
          filterTime = 0;
      }

      const filtered = data.filter(item => item.t >= filterTime);
      const chartData = filtered.map(item => ({
        x: new Date(item.t),
        y: parseFloat(item.c)
      }));

      chart.data.datasets[0].data = chartData;
      chart.update();
    }

    // 获取并渲染实时数据
    async function fetchRealTimeData() {
      try {
        const res = await fetch(API.REAL_TIME);
        const data = await res.json();
        
        // 更新黄金实时信息
        document.getElementById('gold-price').textContent = data.gold;
        document.getElementById('gold-update-time').textContent = `更新时间：${new Date().toLocaleString()}`;
        document.getElementById('gold-open').textContent = data.goldOpen;
        document.getElementById('gold-high').textContent = data.goldHigh;
        document.getElementById('gold-low').textContent = data.goldLow;

        // 更新白银实时信息
        document.getElementById('silver-price').textContent = data.silver;
        document.getElementById('silver-update-time').textContent = `更新时间：${new Date().toLocaleString()}`;
        document.getElementById('silver-open').textContent = data.silverOpen;
        document.getElementById('silver-high').textContent = data.silverHigh;
        document.getElementById('silver-low').textContent = data.silverLow;
      } catch (error) {
        console.error('实时数据获取失败:', error);
      }
    }

    // 获取并渲染历史数据
    async function fetchHistoryData() {
      try {
        const res = await fetch(API.HISTORY);
        const data = await res.json();
        
        goldHistory = data.gold;
        silverHistory = data.silver;

        // 初始化图表实例（仅首次）
        if (!goldChart) {
          goldChart = initChartInstance('goldChart', '黄金价格', '#ffd700');
          silverChart = initChartInstance('silverChart', '白银价格', '#c0c0c0');
        }

        // 默认显示今日数据
        updateChart(goldChart, goldHistory, 'today');
        updateChart(silverChart, silverHistory, 'today');
      } catch (error) {
        console.error('历史数据获取失败:', error);
      }
    }

    // 获取并渲染投资建议
    async function fetchAdvice() {
      try {
        const res = await fetch(API.ADVICE);
        const data = await res.json();
        
        document.getElementById('gold-advice').textContent = data.goldAdvice;
        document.getElementById('gold-take-profit').textContent = data.goldTakeProfit;
        document.getElementById('gold-stop-loss').textContent = data.goldStopLoss;

        document.getElementById('silver-advice').textContent = data.silverAdvice;
        document.getElementById('silver-take-profit').textContent = data.silverTakeProfit;
        document.getElementById('silver-stop-loss').textContent = data.silverStopLoss;
      } catch (error) {
        console.error('投资建议获取失败:', error);
      }
    }

    // 时间范围切换事件
    function initRangeButtons() {
      document.getElementById('range-today').addEventListener('click', () => {
        updateChart(goldChart, goldHistory, 'today');
        updateChart(silverChart, silverHistory, 'today');
      });
      document.getElementById('range-3day').addEventListener('click', () => {
        updateChart(goldChart, goldHistory, '3day');
        updateChart(silverChart, silverHistory, '3day');
      });
      document.getElementById('range-1week').addEventListener('click', () => {
        updateChart(goldChart, goldHistory, '1week');
        updateChart(silverChart, silverHistory, '1week');
      });
    }

    // 初始化系统
    async function initSystem() {
      await fetchRealTimeData();
      await fetchHistoryData();
      await fetchAdvice();
      initRangeButtons();
      
      // 定时刷新（5分钟）
      setInterval(() => {
        fetchRealTimeData();
        fetchAdvice();
      }, 5 * 60 * 1000);
    }

    // 启动系统
    window.onload = initSystem;
  </script>
</body>
</html>
