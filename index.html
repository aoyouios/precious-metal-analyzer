<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>贵金属分析系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
  <style>
    .chart-container { height: 300px; }
    .sub-chart { height: 180px; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <!-- 实时价格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-gray-800 rounded-lg p-4">
        <h2 class="font-bold mb-2">黄金价格</h2>
        <div class="text-3xl font-bold" id="gold-price">--</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4">
        <h2 class="font-bold mb-2">白银价格</h2>
        <div class="text-3xl font-bold" id="silver-price">--</div>
      </div>
    </div>

    <!-- 黄金图表（K线+分时） -->
    <div class="bg-gray-800 rounded-lg p-4 mb-6">
      <h2 class="font-bold mb-4">黄金图表</h2>
      <div class="chart-container mb-4" id="gold-candlestick"></div>
      <div class="sub-chart" id="gold-line"></div>
    </div>

    <!-- 白银图表（K线+分时） -->
    <div class="bg-gray-800 rounded-lg p-4 mb-6">
      <h2 class="font-bold mb-4">白银图表</h2>
      <div class="chart-container mb-4" id="silver-candlestick"></div>
      <div class="sub-chart" id="silver-line"></div>
    </div>

    <!-- 操作建议 -->
    <div class="bg-gray-800 rounded-lg p-4">
      <h2 class="font-bold mb-4">操作建议</h2>
      <div id="advice" class="text-sm space-y-4">加载中...</div>
    </div>
  </div>

  <script>
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
    let goldCandlestick, goldLine, silverCandlestick, silverLine;

    // 1. 初始化图表（确保一打开就有框架）
    function initCharts() {
      // 黄金K线图
      goldCandlestick = new Chart(document.getElementById('gold-candlestick'), {
        type: 'candlestick',
        data: { datasets: [{ label: '黄金K线', data: [] }] },
        options: { scales: { x: { type: 'time' }, y: { title: { display: true, text: '价格（元/克）' } } }
      });

      // 黄金分时图
      goldLine = new Chart(document.getElementById('gold-line'), {
        type: 'line',
        data: { datasets: [{ label: '黄金价格', data: [], borderColor: 'rgb(255, 215, 0)' }] },
        options: { scales: { x: { type: 'time' }, y: { display: false } } }
      });

      // 白银K线图
      silverCandlestick = new Chart(document.getElementById('silver-candlestick'), {
        type: 'candlestick',
        data: { datasets: [{ label: '白银K线', data: [] }] },
        options: { scales: { x: { type: 'time' }, y: { title: { display: true, text: '价格（元/克）' } } }
      });

      // 白银分时图
      silverLine = new Chart(document.getElementById('silver-line'), {
        type: 'line',
        data: { datasets: [{ label: '白银价格', data: [], borderColor: 'rgb(192, 192, 192)' }] },
        options: { scales: { x: { type: 'time' }, y: { display: false } } }
      });
    }

    // 2. 生成模拟数据（初期过渡用）
    function generateMockData(type) {
      const base = type === 'gold' ? 772 : 8.78;
      const data = [];
      for (let i = 10; i >= 0; i--) {
        const price = base + (Math.random() - 0.5) * (type === 'gold' ? 2 : 0.2);
        data.push({
          t: Date.now() - i * 3600000,
          o: price - Math.random() * 0.1,
          h: price + Math.random() * 0.1,
          l: price - Math.random() * 0.15,
          c: price
        });
      }
      return data;
    }

    // 3. 加载数据并强制显示（核心：永不空白）
    async function loadAndRender() {
      try {
        // 尝试获取真实数据
        const [priceRes, historyRes, adviceRes] = await Promise.allSettled([
          fetch(`${API_BASE}/data`),
          fetch(`${API_BASE}/history`),
          fetch(`${API_BASE}/advice`)
        ]);

        // 处理实时价格
        let priceData = {};
        if (priceRes.status === 200) {
          priceData = await priceRes.json();
          document.getElementById('gold-price').textContent = priceData.gold || '--';
          document.getElementById('silver-price').textContent = priceData.silver || '--';
        } else {
          priceData = { gold: '772.05', silver: '8.78' };
        }

        // 处理历史数据
        let historyData = { gold: [], silver: [] };
        if (historyRes.status === 200) {
          historyData = await historyRes.json();
        }

        // 处理建议
        let advice = { gold: { advice: '观望' }, silver: { advice: '观望' } };
        if (adviceRes.status === 200) {
          advice = await adviceRes.json();
        }

        // 合并真实数据与模拟数据
        const goldData = historyData.gold.length > 0 ? historyData.gold : generateMockData('gold');
        const silverData = historyData.silver.length > 0 ? historyData.silver : generateMockData('silver');

        // 更新图表
        updateChart(goldCandlestick, goldLine, goldData);
        updateChart(silverCandlestick, silverLine, silverData);

        // 更新建议
        document.getElementById('advice').innerHTML = `
          <div>黄金：${advice.gold.advice}（当前价：${priceData.gold || '772.05'}）</div>
          <div>白银：${advice.silver.advice}（当前价：${priceData.silver || '8.78'}）</div>
        `;

      } catch (e) {
        console.error("加载失败，使用纯模拟数据：", e);
        const goldMock = generateMockData('gold');
        const silverMock = generateMockData('silver');
        updateChart(goldCandlestick, goldLine, goldMock);
        updateChart(silverCandlestick, silverLine, silverMock);
        document.getElementById('advice').innerHTML = `
          <div>黄金：模拟数据（当前价：772.05）</div>
          <div>白银：模拟数据（当前价：8.78）</div>
        `;
      }
    }

    // 4. 更新图表的通用函数
    function updateChart(candlestickChart, lineChart, data) {
      candlestickChart.data.datasets[0].data = data.map(item => ({
        x: new Date(item.t),
        o: item.o, h: item.h, l: item.l, c: item.c
      }));
      lineChart.data.datasets[0].data = data.map(item => ({ x: new Date(item.t), y: item.c }));
      [candlestickChart, lineChart].forEach(chart => chart.update());
    }

    // 5. 初始化并强制渲染
    window.onload = () => {
      initCharts();
      loadAndRender();
      setInterval(loadAndRender, 300000); // 每5分钟刷新
    };
  </script>
</body>
</html>
