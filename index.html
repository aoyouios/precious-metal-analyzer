<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆专业贵金属分析系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <style>
    .chart-container { height: 300px; margin: 10px 0; }
    .sub-chart { height: 180px; margin: 10px 0; }
    .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .history-table th, .history-table td { border: 1px solid #444; padding: 8px; text-align: left; }
    .result-success { color: #4CAF50; }
    .result-fail { color: #F44336; }
    .result-expired { color: #FFC107; }
    .result-pending { color: #9E9E9E; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">聚宝盆专业贵金属分析系统</h1>

    <!-- 实时价格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-gray-800 p-4 rounded">
        <h2>黄金价格</h2>
        <div class="text-3xl" id="gold-price">772.05</div>
        <div class="text-sm text-gray-400" id="gold-time">更新时间：2025/7/22 03:34:21</div>
      </div>
      <div class="bg-gray-800 p-4 rounded">
        <h2>白银价格</h2>
        <div class="text-3xl" id="silver-price">8.78</div>
        <div class="text-sm text-gray-400" id="silver-time">更新时间：2025/7/22 03:34:21</div>
      </div>
    </div>

    <!-- 黄金图表 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>黄金专业图表</h2>
      <div class="chart-container">
        <canvas id="gold-chart"></canvas>
      </div>
      <div class="sub-chart">
        <canvas id="gold-line"></canvas>
      </div>
    </div>

    <!-- 白银图表 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>白银专业图表</h2>
      <div class="chart-container">
        <canvas id="silver-chart"></canvas>
      </div>
      <div class="sub-chart">
        <canvas id="silver-line"></canvas>
      </div>
    </div>

    <!-- 操作建议 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>智能操作建议</h2>
      <div id="advice" class="p-3 bg-gray-700 rounded">
        <div>黄金：观望（当前价：772.05，止盈：787.49，止损：756.61）</div>
        <div>白银：观望（当前价：8.78，止盈：8.95，止损：8.60）</div>
      </div>
    </div>

    <!-- 历史建议对比 -->
    <div class="bg-gray-800 p-4 rounded">
      <h2>历史建议对比</h2>
      <div class="overflow-x-auto">
        <table class="history-table">
          <thead>
            <tr class="bg-gray-700">
              <th>时间</th>
              <th>黄金建议</th>
              <th>黄金结果</th>
              <th>白银建议</th>
              <th>白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <tr><td colspan="5" class="text-center">加载历史数据中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
    let goldBarChart, goldLineChart, silverBarChart, silverLineChart;

    // 1. 生成默认数据
    function generateData(type) {
      const base = type === 'gold' ? 772 : 8.78;
      const data = [];
      for (let i = 10; i >= 0; i--) {
        const c = +(base + (Math.random() - 0.5) * (type === 'gold' ? 1 : 0.1)).toFixed(2);
        data.push({
          time: new Date(Date.now() - i * 3600000).toLocaleTimeString(),
          value: c
        });
      }
      return data;
    }

    // 2. 初始化黄金图表
    function initGoldCharts() {
      const data = generateData('gold');
      
      // 主图表（柱状图）
      goldBarChart = new Chart(document.getElementById('gold-chart'), {
        type: 'bar',
        data: {
          labels: data.map(item => item.time),
          datasets: [{
            label: '黄金价格（元/克）',
            data: data.map(item => item.value),
            backgroundColor: 'rgba(255, 215, 0, 0.7)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { title: { display: true, text: '价格（元/克）' } }
          }
        }
      });

      // 分时图（折线图）
      goldLineChart = new Chart(document.getElementById('gold-line'), {
        type: 'line',
        data: {
          labels: data.map(item => item.time),
          datasets: [{
            label: '黄金走势',
            data: data.map(item => item.value),
            borderColor: 'rgb(255, 215, 0)',
            fill: true,
            backgroundColor: 'rgba(255, 215, 0, 0.1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // 3. 初始化白银图表
    function initSilverCharts() {
      const data = generateData('silver');
      
      // 主图表（柱状图）
      silverBarChart = new Chart(document.getElementById('silver-chart'), {
        type: 'bar',
        data: {
          labels: data.map(item => item.time),
          datasets: [{
            label: '白银价格（元/克）',
            data: data.map(item => item.value),
            backgroundColor: 'rgba(192, 192, 192, 0.7)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { title: { display: true, text: '价格（元/克）' } }
          }
        }
      });

      // 分时图（折线图）
      silverLineChart = new Chart(document.getElementById('silver-line'), {
        type: 'line',
        data: {
          labels: data.map(item => item.time),
          datasets: [{
            label: '白银走势',
            data: data.map(item => item.value),
            borderColor: 'rgb(192, 192, 192)',
            fill: true,
            backgroundColor: 'rgba(192, 192, 192, 0.1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // 4. 格式化结果显示
    function formatResult(result) {
      if (!result) return '-';
      switch(result) {
        case 'profit': return '<span class="result-success"><i class="fa fa-check-circle"></i> 盈利</span>';
        case 'loss': return '<span class="result-fail"><i class="fa fa-times-circle"></i> 亏损</span>';
        case 'expired': return '<span class="result-expired"><i class="fa fa-exclamation-triangle"></i> 失效</span>';
        case 'pending': return '<span class="result-pending"><i class="fa fa-clock-o"></i> 未完成</span>';
        default: return '-';
      }
    }

    // 5. 加载并显示历史建议
    async function loadHistoryAdvice() {
      try {
        const res = await fetch(`${API_BASE}/advice-history`);
        if (res.ok) {
          const history = await res.json();
          const tbody = document.getElementById('history-table-body');
          
          if (history.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">暂无历史数据</td></tr>';
            return;
          }
          
          // 按时间戳倒序排列（最新的在前）
          history.sort((a, b) => b.timestamp - a.timestamp);
          
          let html = '';
          // 只显示最近10条
          history.slice(0, 10).forEach(item => {
            const time = new Date(item.timestamp).toLocaleString();
            html += `
              <tr>
                <td>${time}</td>
                <td>${item.gold.advice}</td>
                <td>${formatResult(item.goldResult)}</td>
                <td>${item.silver.advice}</td>
                <td>${formatResult(item.silverResult)}</td>
              </tr>
            `;
          });
          tbody.innerHTML = html;
        }
      } catch (e) {
        console.error("加载历史建议失败：", e);
        document.getElementById('history-table-body').innerHTML = 
          '<tr><td colspan="5" class="text-center">加载历史数据失败</td></tr>';
      }
    }

    // 6. 加载实时价格
    async function loadRealTimePrice() {
      try {
        const res = await fetch(`${API_BASE}/data`);
        if (res.ok) {
          const data = await res.json();
          document.getElementById('gold-price').textContent = data.gold || '772.05';
          document.getElementById('silver-price').textContent = data.silver || '8.78';
          document.getElementById('gold-time').textContent = `更新时间：${data.updateTime || new Date().toLocaleString()}`;
          document.getElementById('silver-time').textContent = `更新时间：${data.updateTime || new Date().toLocaleString()}`;
        }
      } catch (e) {
        console.error("加载实时价格失败：", e);
      }
    }

    // 7. 加载操作建议
    async function loadAdvice() {
      try {
        const res = await fetch(`${API_BASE}/advice`);
        if (res.ok) {
          const advice = await res.json();
          document.getElementById('advice').innerHTML = `
            <div>黄金：${advice.gold.advice}（当前价：${advice.gold.entryPrice}，止盈：${advice.gold.takeProfit}，止损：${advice.gold.stopLoss}）</div>
            <div>白银：${advice.silver.advice}（当前价：${advice.silver.entryPrice}，止盈：${advice.silver.takeProfit}，止损：${advice.silver.stopLoss}）</div>
          `;
        }
      } catch (e) {
        console.error("加载操作建议失败：", e);
      }
    }

    // 8. 加载历史数据更新图表
    async function loadHistoryData() {
      try {
        const res = await fetch(`${API_BASE}/history`);
        if (res.ok) {
          const history = await res.json();
          
          // 更新黄金图表
          if (history.gold && history.gold.length > 0) {
            const labels = history.gold.map(item => new Date(item.t).toLocaleTimeString());
            const values = history.gold.map(item => item.c);
            
            goldBarChart.data.labels = labels;
            goldBarChart.data.datasets[0].data = values;
            goldBarChart.update();
            
            goldLineChart.data.labels = labels;
            goldLineChart.data.datasets[0].data = values;
            goldLineChart.update();
          }
          
          // 更新白银图表
          if (history.silver && history.silver.length > 0) {
            const labels = history.silver.map(item => new Date(item.t).toLocaleTimeString());
            const values = history.silver.map(item => item.c);
            
            silverBarChart.data.labels = labels;
            silverBarChart.data.datasets[0].data = values;
            silverBarChart.update();
            
            silverLineChart.data.labels = labels;
            silverLineChart.data.datasets[0].data = values;
            silverLineChart.update();
          }
        }
      } catch (e) {
        console.error("加载历史数据失败：", e);
      }
    }

    // 页面加载后初始化
    window.onload = () => {
      // 初始化图表（必显）
      initGoldCharts();
      initSilverCharts();
      
      // 加载其他数据
      loadRealTimePrice();
      loadAdvice();
      loadHistoryAdvice();
      loadHistoryData();
      
      // 定时刷新（每5分钟）
      setInterval(() => {
        loadRealTimePrice();
        loadAdvice();
        loadHistoryAdvice();
        loadHistoryData();
      }, 300000);
    };
  </script>
</body>
</html>
    
