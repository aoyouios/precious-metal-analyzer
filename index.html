<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆专业贵金属分析系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 仅保留必要的图表依赖，避免冲突 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
  
  <style>
    .chart-container { 
      height: 300px; 
      margin: 10px 0; 
    }
    .sub-chart { 
      height: 180px; 
      margin: 10px 0; 
    }
    .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .history-table th, .history-table td { border: 1px solid #444; padding: 8px; text-align: left; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">聚宝盆专业贵金属分析系统</h1>

    <!-- 实时价格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-gray-800 p-4 rounded">
        <h2>黄金价格</h2>
        <div class="text-3xl" id="gold-price">772.05</div>
        <div class="text-sm text-gray-400" id="gold-time">更新时间：2025/7/22 03:34:21</div>
      </div>
      <div class="bg-gray-800 p-4 rounded">
        <h2>白银价格</h2>
        <div class="text-3xl" id="silver-price">8.78</div>
        <div class="text-sm text-gray-400" id="silver-time">更新时间：2025/7/22 03:34:21</div>
      </div>
    </div>

    <!-- 黄金图表 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>黄金专业图表</h2>
      <div class="chart-container">
        <canvas id="gold-candlestick"></canvas>
      </div>
      <div class="sub-chart">
        <canvas id="gold-line"></canvas>
      </div>
    </div>

    <!-- 白银图表 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>白银专业图表</h2>
      <div class="chart-container">
        <canvas id="silver-candlestick"></canvas>
      </div>
      <div class="sub-chart">
        <canvas id="silver-line"></canvas>
      </div>
    </div>

    <!-- 操作建议和历史对比模块保持不变 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>智能操作建议</h2>
      <div id="advice" class="p-3 bg-gray-700 rounded">
        <div>黄金：观望（当前价：772.05，止盈：787.49，止损：756.61）</div>
        <div>白银：观望（当前价：8.78，止盈：8.95，止损：8.60）</div>
      </div>
    </div>

    <div class="bg-gray-800 p-4 rounded">
      <h2>历史建议对比</h2>
      <div class="overflow-x-auto">
        <table class="history-table">
          <thead>
            <tr class="bg-gray-700">
              <th>时间</th>
              <th>黄金建议</th>
              <th>黄金结果</th>
              <th>白银建议</th>
              <th>白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <tr><td>2025/7/22 10:34:20</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
            <tr><td>2025/7/22 09:34:20</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // 关键修复：移除时间适配器依赖，使用时间戳直接处理
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
    
    // 1. 生成简单的K线数据（使用数字时间戳）
    function generateSimpleData(type) {
      const base = type === 'gold' ? 772 : 8.78;
      const data = [];
      for (let i = 9; i >= 0; i--) {
        const c = +(base + (Math.random() - 0.5) * (type === 'gold' ? 1 : 0.1)).toFixed(2);
        data.push({
          t: i, // 使用简单数字代替时间戳（0-9）
          o: +(c - Math.random() * 0.05).toFixed(2),
          h: +(c + Math.random() * 0.05).toFixed(2),
          l: +(c - Math.random() * 0.08).toFixed(2),
          c: c
        });
      }
      return data;
    }

    // 2. 初始化黄金K线图（极简配置）
    function initGoldChart() {
      const ctx = document.getElementById('gold-candlestick').getContext('2d');
      const data = generateSimpleData('gold');
      
      new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: '黄金K线',
            data: data.map(item => ({
              x: item.t, // 使用简单数字X轴
              o: item.o,
              h: item.h,
              l: item.l,
              c: item.c
            })),
            color: { up: 'red', down: 'green' }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: '时段' } },
            y: { title: { display: true, text: '价格' } }
          }
        }
      });

      // 黄金分时图
      const lineCtx = document.getElementById('gold-line').getContext('2d');
      new Chart(lineCtx, {
        type: 'line',
        data: {
          datasets: [{
            label: '黄金价格',
            data: data.map(item => ({ x: item.t, y: item.c })),
            borderColor: 'yellow'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // 3. 初始化白银K线图（极简配置）
    function initSilverChart() {
      const ctx = document.getElementById('silver-candlestick').getContext('2d');
      const data = generateSimpleData('silver');
      
      new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: '白银K线',
            data: data.map(item => ({
              x: item.t, // 使用简单数字X轴
              o: item.o,
              h: item.h,
              l: item.l,
              c: item.c
            })),
            color: { up: 'red', down: 'green' }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: '时段' } },
            y: { title: { display: true, text: '价格' } }
          }
        }
      });

      // 白银分时图
      const lineCtx = document.getElementById('silver-line').getContext('2d');
      new Chart(lineCtx, {
        type: 'line',
        data: {
          datasets: [{
            label: '白银价格',
            data: data.map(item => ({ x: item.t, y: item.c })),
            borderColor: 'gray'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // 页面加载后立即执行图表初始化（不依赖任何数据加载）
    window.onload = () => {
      // 直接初始化图表，不等待任何数据
      initGoldChart();
      initSilverChart();
      
      // 后台加载真实数据（不影响图表显示）
      fetch(`${API_BASE}/history`).then(res => res.json()).then(data => {
        console.log("真实数据已加载，可用于更新图表", data);
      }).catch(err => console.log("加载真实数据失败，不影响显示", err));
    };
  </script>
</body>
</html>
