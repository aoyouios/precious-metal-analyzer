<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>聚宝盆贵金属预测系统</title>
  <!-- 引入依赖库 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.tailwindcss.com?v=3.3.2"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />

  <style>
    /* 基础样式重置 */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      background: #f5f5f7; 
      color: #1d1d1f; 
      min-height: 100vh; 
    }

    /* 图表容器 */
    .chart-container { 
      height: 400px; 
      width: 100%; 
      position: relative; 
    }
    .chart-loading { 
      position: absolute; 
      inset: 0; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: rgba(255,255,255,0.8); 
      z-index: 10; 
    }
    .chart-error { 
      position: absolute; 
      inset: 0; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      background: #fff; 
      color: #ff3b30; 
      z-index: 10; 
      padding: 2rem; 
      text-align: center; 
    }

    /* 响应式表格滚动 */
    .table-scroll { 
      overflow-x: auto; 
      max-width: 100%; 
    }

    /* 动画效果 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.5s ease-out; }
  </style>
</head>

<body class="p-4 md:p-8">
  <!-- 顶部标题栏 -->
  <header class="flex justify-between items-center mb-8">
    <h1 class="text-2xl font-bold">聚宝盆贵金属预测技术工作室自研系统</h1>
    <div class="text-sm text-neutral" id="system-time">加载中...</div>
  </header>

  <!-- 实时价格卡片 -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-4 rounded-lg shadow fade-in" id="gold-card">
      <h2 class="text-lg font-semibold mb-2">黄金价格（元/克）</h2>
      <div class="text-3xl font-bold mb-2" id="gold-price">加载中...</div>
      <div class="text-sm mb-4" id="gold-change">涨跌幅：加载中...</div>
      <div class="text-xs text-neutral">
        更新时间：<span id="gold-update-time">--</span> 
        <button id="refresh-gold" class="ml-2 text-blue-600 hover:underline">
          <i class="fa fa-refresh mr-1"></i>刷新
        </button>
      </div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow fade-in" id="silver-card">
      <h2 class="text-lg font-semibold mb-2">白银价格（元/克）</h2>
      <div class="text-3xl font-bold mb-2" id="silver-price">加载中...</div>
      <div class="text-sm mb-4" id="silver-change">涨跌幅：加载中...</div>
      <div class="text-xs text-neutral">
        更新时间：<span id="silver-update-time">--</span> 
        <button id="refresh-silver" class="ml-2 text-blue-600 hover:underline">
          <i class="fa fa-refresh mr-1"></i>刷新
        </button>
      </div>
    </div>
  </div>

  <!-- 价格走势图 -->
  <div class="grid grid-cols-1 gap-8 mb-8">
    <!-- 黄金图表 -->
    <div class="bg-white p-4 rounded-lg shadow fade-in">
      <h2 class="text-lg font-semibold mb-4">黄金价格分时图（今日）</h2>
      <div class="chart-container" id="gold-chart-container">
        <div class="chart-loading" id="gold-loading">
          <i class="fa fa-spinner fa-spin text-blue-600 text-2xl"></i>
        </div>
        <div class="chart-error hidden" id="gold-error">
          <p>数据加载失败！</p>
          <button class="mt-2 bg-blue-600 text-white px-4 py-2 rounded" onclick="fetchHistoryData()">重试</button>
        </div>
        <canvas id="gold-chart"></canvas>
      </div>
    </div>

    <!-- 白银图表 -->
    <div class="bg-white p-4 rounded-lg shadow fade-in">
      <h2 class="text-lg font-semibold mb-4">白银价格分时图（今日）</h2>
      <div class="chart-container" id="silver-chart-container">
        <div class="chart-loading" id="silver-loading">
          <i class="fa fa-spinner fa-spin text-blue-600 text-2xl"></i>
        </div>
        <div class="chart-error hidden" id="silver-error">
          <p>数据加载失败！</p>
          <button class="mt-2 bg-blue-600 text-white px-4 py-2 rounded" onclick="fetchHistoryData()">重试</button>
        </div>
        <canvas id="silver-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- 策略建议（示例） -->
  <div class="bg-white p-4 rounded-lg shadow fade-in mb-8">
    <h2 class="text-lg font-semibold mb-4">多周期操作建议</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="p-3 border rounded">
        <h3 class="font-semibold mb-2">短线（1-4小时）</h3>
        <p>方向：<span id="gold-short-direction">加载中...</span></p>
        <p>入场点：<span id="gold-short-entry">--</span></p>
        <p>止盈：<span id="gold-short-tp">--</span></p>
        <p>止损：<span id="gold-short-sl">--</span></p>
      </div>
      <div class="p-3 border rounded">
        <h3 class="font-semibold mb-2">中线（3-7天）</h3>
        <p>方向：<span id="gold-medium-direction">加载中...</span></p>
        <p>入场点：<span id="gold-medium-entry">--</span></p>
        <p>止盈：<span id="gold-medium-tp">--</span></p>
        <p>止损：<span id="gold-medium-sl">--</span></p>
      </div>
      <div class="p-3 border rounded">
        <h3 class="font-semibold mb-2">长线（1-3个月）</h3>
        <p>方向：<span id="gold-long-direction">加载中...</span></p>
        <p>入场点：<span id="gold-long-entry">--</span></p>
        <p>止盈：<span id="gold-long-tp">--</span></p>
        <p>止损：<span id="gold-long-sl">--</span></p>
      </div>
    </div>
  </div>

  <!-- 页脚 -->
  <footer class="text-center text-xs text-neutral mt-8">
    © 2025 聚宝盆贵金属预测技术工作室 | 数据每5分钟更新
  </footer>

  <script>
    // --------------------------
    // 配置项
    // --------------------------
    const API_CURRENT = "https://precious-metal-analyzer.aoyouios.workers.dev/data";
    const API_HISTORY = "https://precious-metal-analyzer.aoyouios.workers.dev/history";
    let goldChart = null, silverChart = null; // 图表实例
    let prevGoldPrice = null, prevSilverPrice = null; // 上一次价格（用于计算涨跌幅）

    // --------------------------
    // 工具函数
    // --------------------------
    /**
     * 安全转换时间戳为Date（兼容秒级/毫秒级）
     * @param {number|string} ts - 时间戳
     * @returns {Date} 转换后的日期
     */
    function safeTimestampToDate(ts) {
      if (typeof ts !== "number") ts = Number(ts);
      // 10位秒级 -> 转毫秒级
      if (ts.toString().length === 10) ts *= 1000;
      return new Date(ts);
    }

    /**
     * 格式化日期为可读字符串
     * @param {Date|string|number} date - 日期/时间戳
     * @returns {string} 格式化后的日期（如：2025/07/28 12:34）
     */
    function formatDateTime(date) {
      if (typeof date === "string" || typeof date === "number") {
        date = safeTimestampToDate(date);
      }
      return date.toLocaleString("zh-CN", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    // --------------------------
    // 数据获取
    // --------------------------
    /**
     * 获取实时价格
     */
    async function fetchCurrentData() {
      try {
        const res = await fetch(API_CURRENT);
        if (!res.ok) throw new Error("网络错误");
        const data = await res.json();
        
        // 更新黄金数据
        const goldPrice = parseFloat(data.gold);
        document.getElementById("gold-price").textContent = goldPrice.toFixed(2);
        document.getElementById("gold-update-time").textContent = formatDateTime(data.updateTime);
        
        // 计算涨跌幅
        if (prevGoldPrice !== null) {
          const change = goldPrice - prevGoldPrice;
          const changePercent = ((change / prevGoldPrice) * 100).toFixed(2);
          const sign = change > 0 ? "+" : "";
          document.getElementById("gold-change").textContent = `涨跌幅：${sign}${change.toFixed(2)} (${sign}${changePercent}%)`;
          document.getElementById("gold-change").className = change > 0 ? "text-green-600" : "text-red-600";
        }
        prevGoldPrice = goldPrice;

        // 更新白银数据
        const silverPrice = parseFloat(data.silver);
        document.getElementById("silver-price").textContent = silverPrice.toFixed(2);
        document.getElementById("silver-update-time").textContent = formatDateTime(data.updateTime);
        
        // 计算涨跌幅
        if (prevSilverPrice !== null) {
          const change = silverPrice - prevSilverPrice;
          const changePercent = ((change / prevSilverPrice) * 100).toFixed(2);
          const sign = change > 0 ? "+" : "";
          document.getElementById("silver-change").textContent = `涨跌幅：${sign}${change.toFixed(2)} (${sign}${changePercent}%)`;
          document.getElementById("silver-change").className = change > 0 ? "text-green-600" : "text-red-600";
        }
        prevSilverPrice = silverPrice;

      } catch (error) {
        console.error("实时价格获取失败：", error);
        alert("价格数据加载失败，请重试");
      }
    }

    /**
     * 获取历史数据并渲染图表
     */
    async function fetchHistoryData() {
      // 显示加载态
      document.getElementById("gold-loading").classList.remove("hidden");
      document.getElementById("silver-loading").classList.remove("hidden");
      document.getElementById("gold-error").classList.add("hidden");
      document.getElementById("silver-error").classList.add("hidden");

      try {
        const res = await fetch(API_HISTORY);
        if (!res.ok) throw new Error("历史数据获取失败");
        const data = await res.json();
        
        // 处理黄金数据
        const goldData = (data.gold || []).map(item => ({
          ...item,
          t: safeTimestampToDate(item.t), // 转换为Date对象
          c: parseFloat(item.c) // 确保收盘价是数字
        })).filter(item => item.t && !isNaN(item.c)); // 过滤无效数据

        // 处理白银数据
        const silverData = (data.silver || []).map(item => ({
          ...item,
          t: safeTimestampToDate(item.t),
          c: parseFloat(item.c)
        })).filter(item => item.t && !isNaN(item.c));

        // 渲染图表
        renderChart("gold", goldData, "gold-chart");
        renderChart("silver", silverData, "silver-chart");

      } catch (error) {
        console.error("历史数据获取失败：", error);
        // 显示错误态
        document.getElementById("gold-loading").classList.add("hidden");
        document.getElementById("gold-error").classList.remove("hidden");
        document.getElementById("silver-loading").classList.add("hidden");
        document.getElementById("silver-error").classList.remove("hidden");
      }
    }

    // --------------------------
    // 图表渲染（核心逻辑）
    // --------------------------
    /**
     * 渲染价格走势图（含MA5均线）
     * @param {string} type - 品种（gold/silver）
     * @param {Array} data - 历史数据 [{t: Date, c: number}]
     * @param {string} canvasId - canvas DOM ID
     */
    function renderChart(type, data, canvasId) {
      // 计算MA5均线
      const ma5 = [];
      for (let i = 0; i < data.length; i++) {
        if (i < 4) {
          ma5.push(null); // 前4个数据不足，显示null
        } else {
          const sum = data.slice(i - 4, i + 1).reduce((acc, item) => acc + item.c, 0);
          ma5.push(sum / 5);
        }
      }

      // 销毁旧图表
      if (type === "gold" && goldChart) goldChart.destroy();
      if (type === "silver" && silverChart) silverChart.destroy();

      // 配置Chart.js
      const ctx = document.getElementById(canvasId).getContext("2d");
      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: data.map(item => item.t), // x轴用Date对象
          datasets: [
            {
              label: `${type === "gold" ? "黄金" : "白银"}价格`,
              data: data.map(item => item.c),
              borderColor: type === "gold" ? "#4299e1" : "#f56565",
              backgroundColor: type === "gold" ? "rgba(66, 153, 225, 0.1)" : "rgba(245, 101, 101, 0.1)",
              borderWidth: 2,
              tension: 0.3,
              pointRadius: 0,
            },
            {
              label: "5期均线",
              data: ma5,
              borderColor: "#48bb78",
              borderWidth: 1.5,
              borderDash: [5, 5],
              tension: 0.4,
              pointRadius: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: "time", // 使用时间轴
              time: {
                unit: "minute",
                displayFormats: {
                  minute: "HH:mm", // 分钟级显示格式
                },
              },
              ticks: {
                color: "#6b7280",
              },
              grid: {
                color: "rgba(0,0,0,0.05)",
              },
            },
            y: {
              ticks: {
                color: "#6b7280",
                callback: (value) => `${value.toFixed(2)} 元/克`,
              },
              grid: {
                color: "rgba(0,0,0,0.05)",
              },
            },
          },
          plugins: {
            legend: {
              position: "top",
              labels: {
                color: "#4b5563",
              },
            },
            tooltip: {
              callbacks: {
                title: (context) => formatDateTime(context[0].label), // 格式化日期
                label: (context) => `${context.dataset.label}: ${context.raw.toFixed(2)} 元/克`,
              },
            },
          },
        },
      });

      // 保存图表实例
      if (type === "gold") goldChart = chart;
      if (type === "silver") silverChart = chart;
    }

    // --------------------------
    // 系统时间更新
    // --------------------------
    function updateSystemTime() {
      const now = new Date();
      document.getElementById("system-time").textContent = now.toLocaleString("zh-CN", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    }
    setInterval(updateSystemTime, 1000);
    updateSystemTime();

    // --------------------------
    // 页面初始化
    // --------------------------
    document.addEventListener("DOMContentLoaded", () => {
      // 绑定刷新按钮
      document.getElementById("refresh-gold").addEventListener("click", () => {
        fetchCurrentData();
      });
      document.getElementById("refresh-silver").addEventListener("click", () => {
        fetchCurrentData();
      });

      // 初始加载数据
      fetchCurrentData();
      fetchHistoryData();
    });
  </script>
</body>
</html>
