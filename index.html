<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>聚宝盆贵金属预测系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    .status-red { color: #ff3b30; }
    .status-blue { color: #0071e3; }
    .status-green { color: #34c759; }
    .status-black { color: #86868b; }
    .card { background: #fff; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.05); padding: 24px; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <h1 class="text-3xl font-semibold text-gray-900">聚宝盆贵金属预测系统</h1>

    <!-- 实时行情 -->
    <div class="card flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
      <div>
        <p class="text-sm text-gray-600">黄金 (元/克)</p>
        <p id="gold-price" class="text-2xl font-medium">加载中...</p>
      </div>
      <div>
        <p class="text-sm text-gray-600">白银 (元/克)</p>
        <p id="silver-price" class="text-2xl font-medium">加载中...</p>
      </div>
      <div class="text-sm text-gray-500">更新时间：<span id="update-time">--</span></div>
    </div>

    <!-- 图表 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card">
        <h2 class="text-lg font-medium mb-2">黄金分时图</h2>
        <canvas id="gold-chart" height="200"></canvas>
      </div>
      <div class="card">
        <h2 class="text-lg font-medium mb-2">白银分时图</h2>
        <canvas id="silver-chart" height="200"></canvas>
      </div>
    </div>

    <!-- 操作建议 -->
    <div class="card grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h3 class="text-lg font-medium mb-2">黄金操作建议</h3>
        <p id="gold-suggestion" class="text-gray-700">分析中...</p>
      </div>
      <div>
        <h3 class="text-lg font-medium mb-2">白银操作建议</h3>
        <p id="silver-suggestion" class="text-gray-700">分析中...</p>
      </div>
    </div>

    <!-- 历史建议验证 -->
    <div class="card">
      <h2 class="text-lg font-medium mb-4">历史建议验证（最近24小时）</h2>
      <div class="overflow-y-auto" style="max-height:360px">
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-4 py-2 text-left">时间</th>
              <th class="px-4 py-2 text-left">品种</th>
              <th class="px-4 py-2 text-left">建议</th>
              <th class="px-4 py-2 text-left">结果</th>
            </tr>
          </thead>
          <tbody id="history-list">
            <!-- JS 填充 -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const CURRENT_API = "https://precious-metal-analyzer.aoyouios.workers.dev/data";
    const HISTORY_API = "https://precious-metal-analyzer.aoyouios.workers.dev/history";

    async function init() {
      try {
        const [curRes, hisRes] = await Promise.all([fetch(CURRENT_API), fetch(HISTORY_API)]);
        const current = await curRes.json();
        const history = await hisRes.json();
        updateRealtime(current);
        renderChart("gold-chart", history.gold, "#0071e3");
        renderChart("silver-chart", history.silver, "#34c759");
        const goldSug = genSug(current.gold, history.gold);
        const silverSug = genSug(current.silver, history.silver);
        document.getElementById("gold-suggestion").innerText = goldSug.text;
        document.getElementById("silver-suggestion").innerText = silverSug.text;
        renderHistoryList(history, current);
      } catch (e) {
        console.error(e);
      }
    }

    function updateRealtime(d) {
      document.getElementById("gold-price").innerText = parseFloat(d.gold).toFixed(2);
      document.getElementById("silver-price").innerText = parseFloat(d.silver).toFixed(2);
      document.getElementById("update-time").innerText = d.updateTime;
    }

    function renderChart(id, arr, color) {
      const ctx = document.getElementById(id).getContext("2d");
      const ds = arr.map(i => ({ x: i.t, y: i.c }));
      new Chart(ctx, {
        type: "line",
        data: { datasets: [{ data: ds, borderColor: color, backgroundColor: color + "33", tension:0.3, pointRadius:0 }] },
        options: {
          parsing:false,
          scales:{ x:{ type:"time", time:{ unit:"hour", tooltipFormat:"MM-dd HH:mm" } }, y:{ beginAtZero:false } },
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label: ctx=>ctx.raw.y.toFixed(2)+" 元/克" } } }
        }
      });
    }

    function genSug(cur, arr) {
      const open = arr[0]?.c || cur;
      const change = (cur - open)/open*100;
      let advice="观望", text="";
      if (change>1) advice="卖出";
      else if (change<-1) advice="买入";
      text = `开盘 ${open.toFixed(2)}，当前 ${parseFloat(cur).toFixed(2)} (${change.toFixed(2)}%) → ${advice}`;
      return { advice, text };
    }

    function renderHistoryList(his, cur) {
      const tbody = document.getElementById("history-list");
      tbody.innerHTML="";
      const now = Date.now();
      const ONEH = 3600000;
      const all = [...his.gold.map(i=>({...i, type:"黄金"})),
                   ...his.silver.map(i=>({...i, type:"白银"}))]
        .filter(i=>now - i.t <= 24*ONEH)
        .sort((a,b)=>b.t-a.t)
        .slice(0,24);
      const curGold = parseFloat(cur.gold), curSilver = parseFloat(cur.silver);
      for (const i of all) {
        const isGold = i.type==="黄金";
        const curPrice = isGold?curGold:curSilver;
        const entry=i.c;
        const tp=entry*1.02, sl=entry*0.98;
        let result="", cls="status-black";
        if (curPrice>=tp) { result="止盈√"; cls="status-red"; }
        else if (curPrice<=sl) { result="止损×"; cls="status-green"; }
        else if ((curPrice-entry)*(isGold?1:1) > 0) { result="方向正确"; cls="status-blue"; }
        else { result="等待中"; }
        const tr=document.createElement("tr");
        tr.innerHTML = `<td class="px-4 py-2">${new Date(i.t).toLocaleString()}</td>
                        <td class="px-4 py-2">${i.type}</td>
                        <td class="px-4 py-2">${result}</td>`;
        tr.querySelector("td:nth-child(3)").classList.add(cls);
        tbody.appendChild(tr);
      }
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
