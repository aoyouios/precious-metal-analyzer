<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>聚宝盆贵金属预测系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
  <style>
    .status-green { color: green; font-weight: bold; }
    .status-blue { color: blue; font-weight: bold; }
    .status-red { color: red; font-weight: bold; }
    .status-black { color: black; font-weight: bold; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-4">聚宝盆贵金属预测系统</h1>

    <!-- 实时价格 -->
    <div class="bg-white rounded shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-2">实时价格</h2>
      <p>黄金：<span id="gold-price">加载中...</span> 元/克</p>
      <p>白银：<span id="silver-price">加载中...</span> 元/克</p>
      <p>更新时间：<span id="update-time">加载中...</span></p>
    </div>

    <!-- 黄金图表 -->
    <div class="bg-white rounded shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-2">黄金图表</h2>
      <canvas id="gold-chart" height="400"></canvas>
    </div>

    <!-- 白银图表 -->
    <div class="bg-white rounded shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-2">白银图表</h2>
      <canvas id="silver-chart" height="400"></canvas>
    </div>

    <!-- 操作建议 -->
    <div class="bg-white rounded shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-2">操作建议</h2>
      <div id="suggestion">正在分析...</div>
    </div>

    <!-- 历史记录 -->
    <div class="bg-white rounded shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-2">历史建议验证</h2>
      <ul id="history-list" class="text-sm"></ul>
    </div>

    <!-- 收益估算 -->
    <div class="bg-white rounded shadow p-4 mb-6">
      <h2 class="text-xl font-semibold mb-2">黄金收益估算</h2>
      <div id="profit">计算中...</div>
    </div>
  </div>

  <script>
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
    const CURRENT_API = `${API_BASE}/data`;
    const HISTORY_API = `${API_BASE}/history`;

    async function fetchData() {
      try {
        const [currentRes, historyRes] = await Promise.all([
          fetch(CURRENT_API),
          fetch(HISTORY_API)
        ]);
        const current = await currentRes.json();
        const history = await historyRes.json();
        return { current, history };
      } catch (e) {
        console.error("获取数据失败：", e);
        return null;
      }
    }

    function updateRealtime(data) {
      document.getElementById("gold-price").innerText = parseFloat(data.gold).toFixed(2);
      document.getElementById("silver-price").innerText = parseFloat(data.silver).toFixed(2);
      document.getElementById("update-time").innerText = data.updateTime || "未知时间";
    }

    function renderChart(canvasId, label, color, rawData) {
      const ctx = document.getElementById(canvasId).getContext("2d");
      const dataPoints = rawData.map(d => ({ x: d.t, y: d.c }));
      const ohlc = rawData.map(d => ({ o: d.o, h: d.h, l: d.l, c: d.c }));

      new Chart(ctx, {
        type: "line",
        data: {
          datasets: [{
            label,
            data: dataPoints,
            borderColor: color,
            backgroundColor: color + "33",
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          parsing: false,
          scales: {
            x: {
              type: "time",
              time: {
                unit: "minute",
                tooltipFormat: "HH:mm"
              }
            },
            y: {
              beginAtZero: false
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `价格: ${ctx.raw.y.toFixed(2)} 元/克`
              }
            }
          }
        }
      });
    }

    function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
      const ema = (arr, period) => {
        const k = 2 / (period + 1);
        let emaArr = [arr[0]];
        for (let i = 1; i < arr.length; i++) {
          emaArr.push(arr[i] * k + emaArr[i - 1] * (1 - k));
        }
        return emaArr;
      };
      const closes = data.map(d => d.c);
      const fastEMA = ema(closes, fast);
      const slowEMA = ema(closes, slow);
      const macd = fastEMA.map((v, i) => v - slowEMA[i]);
      const signalLine = ema(macd.slice(slow), signal);
      return macd[macd.length - 1] - signalLine[signalLine.length - 1];
    }

    function calculateRSI(data, period = 14) {
      const closes = data.map(d => d.c);
      let gains = 0, losses = 0;
      for (let i = 1; i <= period; i++) {
        const diff = closes[i] - closes[i - 1];
        if (diff >= 0) gains += diff; else losses -= diff;
      }
      const avgGain = gains / period;
      const avgLoss = losses / period;
      const rs = avgGain / avgLoss;
      return 100 - (100 / (1 + rs));
    }

    function generateSuggestion(current, history) {
      const macd = calculateMACD(history);
      const rsi = calculateRSI(history);
      let text = "";

      if (macd > 0 && rsi < 70) {
        text = "建议：黄金短期买入，MACD转正，RSI较低";
      } else if (rsi > 75) {
        text = "建议：RSI过高，谨慎追高";
      } else {
        text = "建议：观望";
      }
      document.getElementById("suggestion").innerText = text;
    }

    function updateHistoryVerify(history, currentPrice) {
      const list = document.getElementById("history-list");
      list.innerHTML = "";
      const entry = {
        time: new Date().toLocaleTimeString(),
        action: "买入",
        entry: history[history.length - 2]?.c || 0,
        current: currentPrice,
        takeProfit: (history[history.length - 2]?.c || 0) + 3,
        stopLoss: (history[history.length - 2]?.c || 0) - 2
      };

      let status = "status-black";
      if (currentPrice >= entry.takeProfit) status = "status-red";
      else if (currentPrice <= entry.stopLoss) status = "status-green";
      else if (currentPrice > entry.entry) status = "status-blue";

      const li = document.createElement("li");
      li.innerHTML = `【${entry.time}】入场: ${entry.entry.toFixed(2)} → 当前: ${currentPrice.toFixed(2)} <span class="${status}">状态</span>`;
      list.appendChild(li);
    }

    async function init() {
      const data = await fetchData();
      if (!data) return;
      updateRealtime(data.current);
      renderChart("gold-chart", "黄金价格", "#f59e0b", data.history.gold);
      renderChart("silver-chart", "白银价格", "#60a5fa", data.history.silver);
      generateSuggestion(data.current.gold, data.history.gold);
      updateHistoryVerify(data.history.gold, parseFloat(data.current.gold));
      const profit = parseFloat(data.current.gold) - data.history.gold[0].o;
      document.getElementById("profit").innerText = `从开盘至今涨跌：${profit.toFixed(2)} 元/克`;
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
