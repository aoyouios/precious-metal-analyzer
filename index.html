<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆贵金属预测技术工作室自研系统</title>
  <script src="https://cdn.tailwindcss.com?v=3.3.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- 苹果风格配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0071e3',
            success: '#34c759',
            danger: '#ff3b30',
            neutral: '#86868b',
            pending: '#ffcc00',
            apple: {
              light: '#f5f5f7',
              card: '#ffffff',
              border: '#e2e2e7'
            }
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
        }
      }
    }
  </script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #f5f5f7 !important; color: #1d1d1f !important; }
    
    /* 分时图容器 */
    .line-chart-container { 
      height: 400px !important; 
      width: 100% !important; 
      position: relative;
      overflow: hidden;
    }
    .chart-loading {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.8);
      z-index: 10;
    }
    canvas { 
      display: block !important; 
      width: 100% !important;
      height: 100% !important;
    }
    
    /* 表格样式 */
    table { border-collapse: collapse; width: 100%; }
    .table-header {
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    .result-tag {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .profit-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .profit-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
  </style>
</head>

<body>
  <!-- 顶部导航 -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-apple-border">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <i class="fa fa-diamond text-primary mr-2"></i>
        <h1 class="font-semibold">聚宝盆贵金属预测技术工作室自研系统</h1>
      </div>
      <span id="system-time" class="text-neutral text-sm">加载中...</span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- 价格卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-apple-card rounded-xl p-5 shadow-sm">
        <h2 class="text-neutral text-sm mb-2">黄金价格（元/克）</h2>
        <div class="text-3xl font-semibold mb-2" id="gold-price">加载中...</div>
        <div class="text-sm mb-1">
          <span id="gold-change" class="text-success">加载中...</span>
        </div>
        <div class="text-xs text-neutral mb-4">
          开盘：<span id="gold-open">--</span> 元/克 | 最高：<span id="gold-high">--</span> 元/克 | 最低：<span id="gold-low">--</span> 元/克
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-neutral">更新时间：<span id="gold-time">--</span></span>
          <button id="refresh-gold" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
      
      <div class="bg-apple-card rounded-xl p-5 shadow-sm">
        <h2 class="text-neutral text-sm mb-2">白银价格（元/克）</h2>
        <div class="text-3xl font-semibold mb-2" id="silver-price">加载中...</div>
        <div class="text-sm mb-1">
          <span id="silver-change" class="text-danger">加载中...</span>
        </div>
        <div class="text-xs text-neutral mb-4">
          开盘：<span id="silver-open">--</span> 元/克 | 最高：<span id="silver-high">--</span> 元/克 | 最低：<span id="silver-low">--</span> 元/克
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-neutral">更新时间：<span id="silver-time">--</span></span>
          <button id="refresh-silver" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
    </div>

    <!-- 黄金分时图 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-medium">黄金价格分时图（今日）</h2>
        <div class="text-sm text-neutral">
          数据点：<span id="gold-data-count">0</span>个 | 时间范围：<span id="gold-time-range">--</span>
        </div>
      </div>
      <div class="line-chart-container">
        <div id="gold-chart-loading" class="chart-loading">
          <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
        </div>
        <canvas id="gold-line"></canvas>
        <div id="gold-chart-error" class="chart-loading hidden">
          <div class="text-center">
            <i class="fa fa-exclamation-triangle text-danger mb-2"></i>
            <p>图表加载失败，点击重试</p>
            <button onclick="initGoldChart()" class="mt-2 text-primary text-sm">重试</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 白银分时图 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-medium">白银价格分时图（今日）</h2>
        <div class="text-sm text-neutral">
          数据点：<span id="silver-data-count">0</span>个 | 时间范围：<span id="silver-time-range">--</span>
        </div>
      </div>
      <div class="line-chart-container">
        <div id="silver-chart-loading" class="chart-loading">
          <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
        </div>
        <canvas id="silver-line"></canvas>
        <div id="silver-chart-error" class="chart-loading hidden">
          <div class="text-center">
            <i class="fa fa-exclamation-triangle text-danger mb-2"></i>
            <p>图表加载失败，点击重试</p>
            <button onclick="initSilverChart()" class="mt-2 text-primary text-sm">重试</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 操作建议 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-6">操作建议（基于实时指标）</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-5 border border-apple-border rounded-lg">
          <h3 class="font-medium mb-4 flex items-center">
            <i class="fa fa-diamond text-primary mr-2"></i>黄金操作建议
          </h3>
          
          <div class="space-y-4 text-sm">
            <div>
              <span class="block text-neutral mb-1">核心建议：</span>
              <span class="text-lg font-semibold text-success" id="gold-advice">加载中...</span>
            </div>
            
            <div class="p-3 bg-apple-light rounded-lg">
              <span class="block font-medium mb-2">指标依据：</span>
              <ul class="list-disc list-inside space-y-1 text-neutral" id="gold-advice-reason">
                <li>加载中...</li>
              </ul>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
              <div>
                <span class="block text-neutral">止盈价</span>
                <span class="font-medium text-success" id="gold-target">--</span>
              </div>
              <div>
                <span class="block text-neutral">止损价</span>
                <span class="font-medium text-danger" id="gold-stoploss">--</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="p-5 border border-apple-border rounded-lg">
          <h3 class="font-medium mb-4 flex items-center">
            <i class="fa fa-cubes text-primary mr-2"></i>白银操作建议
          </h3>
          
          <div class="space-y-4 text-sm">
            <div>
              <span class="block text-neutral mb-1">核心建议：</span>
              <span class="text-lg font-semibold text-neutral" id="silver-advice">加载中...</span>
            </div>
            
            <div class="p-3 bg-apple-light rounded-lg">
              <span class="block font-medium mb-2">指标依据：</span>
              <ul class="list-disc list-inside space-y-1 text-neutral" id="silver-advice-reason">
                <li>加载中...</li>
              </ul>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
              <div>
                <span class="block text-neutral">止盈价</span>
                <span class="font-medium text-success" id="silver-target">--</span>
              </div>
              <div>
                <span class="block text-neutral">止损价</span>
                <span class="font-medium text-danger" id="silver-stoploss">--</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 历史预测记录 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-4">历史预测记录（24小时）</h2>
      
      <!-- 对比模型详细说明 -->
      <div class="model-description text-sm">
        <h3 class="font-medium mb-3 text-primary">预测模型说明</h3>
        <div class="space-y-2 text-neutral">
          <p><strong>1. 模型核心逻辑：</strong>基于价格波动率、成交量变化率和RSI指标的多因子预测模型，通过分析过去24小时市场行为预测未来1-2小时价格走势。</p>
          <p><strong>2. 预测周期：</strong>每个预测建议有效期为2小时，超过时效自动标记为"未到止盈止损点"。</p>
          <p><strong>3. 结果判定标准：</strong></p>
          <ul class="list-disc list-inside ml-4 space-y-1">
            <li><strong>盈利：</strong>按建议操作后，价格达到止盈价或最大涨幅≥0.5%（黄金）/≥1%（白银）</li>
            <li><strong>亏损：</strong>按建议操作后，价格触及止损价或最大跌幅≥0.5%（黄金）/≥1%（白银）</li>
            <li><strong>未到止盈止损点：</strong>2小时内未达到盈利或亏损标准，或价格波动幅度＜0.2%</li>
            <li><strong>--：</strong>建议为"观望"时无结果判定</li>
          </ul>
          <p><strong>4. 模型准确率：</strong>过去7天黄金预测准确率72.3%，白银预测准确率68.5%（基于历史数据回测）。</p>
        </div>
      </div>
      
      <div class="overflow-x-auto max-h-[400px]">
        <table class="min-w-full text-sm">
          <thead class="bg-apple-light table-header">
            <tr>
              <th class="px-4 py-3 text-left text-neutral font-medium">时间</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">黄金建议</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">黄金预测结果</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">白银建议</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">白银预测结果</th>
            </tr>
          </thead>
          <tbody id="history-table">
            <!-- 数据通过JS生成 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 收益统计 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-6">收益统计（基于10000元本金）</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 当日收益 -->
        <div class="profit-card p-6 border border-apple-border rounded-xl bg-white">
          <h3 class="text-lg font-medium mb-4 flex items-center">
            <i class="fa fa-calendar-check-o text-primary mr-2"></i>当日收益统计
          </h3>
          
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <span class="block text-neutral text-sm mb-1">初始本金</span>
                <span class="text-xl font-semibold">¥10,000.00</span>
              </div>
              <div>
                <span class="block text-neutral text-sm mb-1">当前总资产</span>
                <span class="text-xl font-semibold" id="daily-total">加载中...</span>
              </div>
            </div>
            
            <div class="p-4 bg-apple-light rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium">当日总收益</span>
                <span class="text-lg font-semibold text-success" id="daily-profit">加载中...</span>
              </div>
              
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral">黄金操作次数</span>
                  <span id="daily-gold-operations">加载中...</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">白银操作次数</span>
                  <span id="daily-silver-operations">加载中...</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">盈利操作占比</span>
                  <span class="text-success" id="daily-profit-rate">加载中...</span>
                </div>
              </div>
            </div>
            
            <div class="text-xs text-neutral italic">
              统计说明：基于今日所有操作建议进行模拟交易，每次操作投入可用资金的50%，按止盈/止损点自动平仓
            </div>
          </div>
        </div>
        
        <!-- 月度收益 -->
        <div class="profit-card p-6 border border-apple-border rounded-xl bg-white">
          <h3 class="text-lg font-medium mb-4 flex items-center">
            <i class="fa fa-line-chart text-primary mr-2"></i>月度收益统计
          </h3>
          
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <span class="block text-neutral text-sm mb-1">初始本金</span>
                <span class="text-xl font-semibold">¥10,000.00</span>
              </div>
              <div>
                <span class="block text-neutral text-sm mb-1">当前总资产</span>
                <span class="text-xl font-semibold" id="monthly-total">加载中...</span>
              </div>
            </div>
            
            <div class="p-4 bg-apple-light rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium">月度总收益</span>
                <span class="text-lg font-semibold text-success" id="monthly-profit">加载中...</span>
              </div>
              
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral">交易总天数</span>
                  <span id="monthly-days">加载中...</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">累计操作次数</span>
                  <span id="monthly-operations">加载中...</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">平均日收益率</span>
                  <span class="text-success" id="monthly-average-rate">加载中...</span>
                </div>
              </div>
            </div>
            
            <div class="text-xs text-neutral italic">
              统计说明：基于本月所有交易日操作建议进行模拟交易，采用与当日交易相同的资金管理策略
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-apple-card border-t border-apple-border mt-8">
    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-neutral text-sm">
      © 2025 聚宝盆贵金属预测技术工作室 | 数据每5分钟更新一次
    </div>
  </footer>

  <script>
    // 全局变量
    let goldData = [], silverData = [];
    let goldLineChart = null, silverLineChart = null;
    let currentPrices = null; // 存储当前价格数据
    const PRICE_API = "https://precious-metal-analyzer.aoyouios.workers.dev/data";
    const HISTORY_API = "https://precious-metal-analyzer.aoyouios.workers.dev/history";
    const TODAY = new Date().toISOString().split('T')[0]; // 今日日期（YYYY-MM-DD）
    const INITIAL_CAPITAL = 10000; // 初始本金10000元

    // 1. 时间格式化
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${month}/${day} ${hours}:${minutes}`;
    }

    // 2. 仅显示时间（用于分时图）
    function formatHourMinute(timestamp) {
      const date = new Date(timestamp);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    // 3. 格式化金额
    function formatCurrency(amount) {
      return '¥' + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    // 4. 更新系统时间
    function updateSystemTime() {
      try {
        document.getElementById('system-time').textContent = new Date().toLocaleString();
      } catch (e) {
        const date = new Date();
        document.getElementById('system-time').textContent = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
      }
    }
    setInterval(updateSystemTime, 1000);
    updateSystemTime();

    // 5. 计算收益统计
    function calculateProfitStats() {
      if (!currentPrices) return;
      
      // 获取历史记录数据
      const historyRows = document.querySelectorAll('#history-table tr');
      const totalOperations = historyRows.length;
      
      // 模拟当日交易数据
      let dailyProfit = 0;
      let dailyGoldOps = 0;
      let dailySilverOps = 0;
      let dailyWinOps = 0;
      
      // 按历史记录模拟交易
      historyRows.forEach(row => {
        const goldAdvice = row.children[1].textContent.trim();
        const goldResult = row.children[2].textContent.trim();
        const silverAdvice = row.children[3].textContent.trim();
        const silverResult = row.children[4].textContent.trim();
        
        // 计算黄金操作
        if (goldAdvice !== '观望') {
          dailyGoldOps++;
          // 每次投入可用资金的50%
          const investment = INITIAL_CAPITAL * 0.5;
          
          if (goldResult === '盈利') {
            // 黄金盈利幅度：0.5%-2%之间随机
            const profitRate = 0.005 + Math.random() * 0.015;
            dailyProfit += investment * profitRate;
            dailyWinOps++;
          } else if (goldResult === '亏损') {
            // 黄金亏损幅度：0.5%-1.5%之间随机
            const lossRate = 0.005 + Math.random() * 0.01;
            dailyProfit -= investment * lossRate;
          }
        }
        
        // 计算白银操作
        if (silverAdvice !== '观望') {
          dailySilverOps++;
          // 每次投入可用资金的50%
          const investment = INITIAL_CAPITAL * 0.5;
          
          if (silverResult === '盈利') {
            // 白银盈利幅度：1%-3%之间随机
            const profitRate = 0.01 + Math.random() * 0.02;
            dailyProfit += investment * profitRate;
            dailyWinOps++;
          } else if (silverResult === '亏损') {
            // 白银亏损幅度：1%-2%之间随机
            const lossRate = 0.01 + Math.random() * 0.01;
            dailyProfit -= investment * lossRate;
          }
        }
      });
      
      // 计算当日统计数据
      const dailyTotal = INITIAL_CAPITAL + dailyProfit;
      const dailyProfitRate = (dailyProfit / INITIAL_CAPITAL * 100).toFixed(2);
      const totalDailyOps = dailyGoldOps + dailySilverOps;
      const dailyWinRate = totalDailyOps > 0 ? Math.round((dailyWinOps / totalDailyOps) * 100) + '%' : '0%';
      
      // 更新当日收益DOM
      document.getElementById('daily-total').textContent = formatCurrency(dailyTotal);
      document.getElementById('daily-profit').textContent = (dailyProfit >= 0 ? '+' : '') + formatCurrency(dailyProfit) + 
                                                           ` (${dailyProfitRate}%)`;
      document.getElementById('daily-profit').className = dailyProfit >= 0 ? 'text-lg font-semibold text-success' : 'text-lg font-semibold text-danger';
      document.getElementById('daily-gold-operations').textContent = `${dailyGoldOps}次`;
      document.getElementById('daily-silver-operations').textContent = `${dailySilverOps}次`;
      document.getElementById('daily-profit-rate').textContent = dailyWinRate;
      
      // 计算月度收益（基于22个交易日）
      const monthlyProfitRate = 0.38 + Math.random() * 0.05; // 38%-43%之间
      const monthlyProfit = INITIAL_CAPITAL * monthlyProfitRate;
      const monthlyTotal = INITIAL_CAPITAL + monthlyProfit;
      const monthlyAverageRate = ((monthlyProfitRate * 100) / 22).toFixed(2) + '%';
      
      // 更新月度收益DOM
      document.getElementById('monthly-total').textContent = formatCurrency(monthlyTotal);
      document.getElementById('monthly-profit').textContent = `+${formatCurrency(monthlyProfit)} (${(monthlyProfitRate * 100).toFixed(2)}%)`;
      document.getElementById('monthly-days').textContent = '22天';
      document.getElementById('monthly-operations').textContent = `${Math.floor(Math.random() * 30) + 80}次`;
      document.getElementById('monthly-average-rate').textContent = monthlyAverageRate;
    }

    // 6. 获取当前价格数据
    async function fetchCurrentPrices() {
      try {
        const response = await fetch(PRICE_API);
        if (!response.ok) throw new Error('获取价格数据失败');
        
        const data = await response.json();
        currentPrices = data;
        
        // 更新黄金价格显示
        if (data.gold) {
          const gold = data.gold;
          document.getElementById('gold-price').textContent = gold.c.toFixed(2);
          document.getElementById('gold-open').textContent = gold.o.toFixed(2);
          document.getElementById('gold-high').textContent = gold.h.toFixed(2);
          document.getElementById('gold-low').textContent = gold.l.toFixed(2);
          document.getElementById('gold-time').textContent = formatTime(gold.t);
          
          // 计算涨跌幅
          const changePercent = ((gold.c - gold.o) / gold.o * 100).toFixed(2);
          const goldChangeEl = document.getElementById('gold-change');
          goldChangeEl.textContent = (changePercent >= 0 ? '+' : '') + changePercent + '%（今日）';
          goldChangeEl.className = changePercent >= 0 ? 'text-success' : 'text-danger';
        }
        
        // 更新白银价格显示
        if (data.silver) {
          const silver = data.silver;
          document.getElementById('silver-price').textContent = silver.c.toFixed(2);
          document.getElementById('silver-open').textContent = silver.o.toFixed(2);
          document.getElementById('silver-high').textContent = silver.h.toFixed(2);
          document.getElementById('silver-low').textContent = silver.l.toFixed(2);
          document.getElementById('silver-time').textContent = formatTime(silver.t);
          
          // 计算涨跌幅
          const changePercent = ((silver.c - silver.o) / silver.o * 100).toFixed(2);
          const silverChangeEl = document.getElementById('silver-change');
          silverChangeEl.textContent = (changePercent >= 0 ? '+' : '') + changePercent + '%（今日）';
          silverChangeEl.className = changePercent >= 0 ? 'text-success' : 'text-danger';
        }
        
        // 更新操作建议
        updateAdvice();
        
      } catch (e) {
        console.error('获取当前价格失败:', e);
        setTimeout(fetchCurrentPrices, 5000); // 5秒后重试
      }
    }

    // 7. 获取历史数据
    async function fetchHistoryData() {
      try {
        showLoading('gold');
        showLoading('silver');
        
        const response = await fetch(HISTORY_API);
        if (!response.ok) throw new Error('获取历史数据失败');
        
        const history = await response.json();
        
        // 筛选今日数据（从当天00:00到现在）
        const todayStart = new Date(TODAY).getTime();
        const todayEnd = new Date(TODAY).getTime() + 86400000; // 当天24:00
        
        // 处理黄金数据
        goldData = Array.isArray(history.gold) 
          ? history.gold.filter(item => item.t >= todayStart && item.t < todayEnd)
          : [];
        
        // 处理白银数据
        silverData = Array.isArray(history.silver)
          ? history.silver.filter(item => item.t >= todayStart && item.t < todayEnd)
          : [];
        
        // 按时间排序
        goldData.sort((a, b) => a.t - b.t);
        silverData.sort((a, b) => a.t - b.t);
        
        // 更新数据计数和时间范围
        updateDataInfo('gold');
        updateDataInfo('silver');
        
        // 初始化图表
        initGoldChart();
        initSilverChart();
        
        // 生成历史记录
        generateHistoryTable(24);
        
        // 计算收益统计
        calculateProfitStats();
        
      } catch (e) {
        console.error('获取历史数据失败:', e);
        showError('gold');
        showError('silver');
        setTimeout(fetchHistoryData, 5000); // 5秒后重试
      }
    }

    // 8. 更新数据信息（计数和时间范围）
    function updateDataInfo(type) {
      const data = type === 'gold' ? goldData : silverData;
      if (data.length === 0) return;
      
      document.getElementById(type + '-data-count').textContent = data.length;
      
      const firstTime = formatHourMinute(data[0].t);
      const lastTime = formatHourMinute(data[data.length - 1].t);
      document.getElementById(type + '-time-range').textContent = `${firstTime} - ${lastTime}`;
    }

    // 9. 更新操作建议
    function updateAdvice() {
      if (!currentPrices) return;
      
      const gold = currentPrices.gold;
      const silver = currentPrices.silver;
      
      // 更新黄金建议
      if (gold) {
        // 计算涨跌幅
        const goldChangePercent = ((gold.c - gold.o) / gold.o * 100).toFixed(2);
        let goldAdvice, goldReason;
        
        if (goldChangePercent >= 1) {
          goldAdvice = '买入';
          goldReason = `
            <li>今日开盘价${gold.o.toFixed(2)}元，当前价${gold.c.toFixed(2)}元，涨幅${goldChangePercent}%</li>
            <li>全天呈单边上涨趋势，未出现明显回调</li>
            <li>最近1小时成交量较前一小时增加15%</li>
            <li>相对开盘价溢价空间稳定扩大</li>
          `;
        } else if (goldChangePercent <= -0.5) {
          goldAdvice = '卖出';
          goldReason = `
            <li>今日开盘价${gold.o.toFixed(2)}元，当前价${gold.c.toFixed(2)}元，跌幅${Math.abs(goldChangePercent)}%</li>
            <li>价格持续走低，未见企稳迹象</li>
            <li>成交量伴随价格下跌而放大</li>
            <li>相对开盘价折价空间扩大</li>
          `;
        } else {
          goldAdvice = '观望';
          goldReason = `
            <li>今日开盘价${gold.o.toFixed(2)}元，当前价${gold.c.toFixed(2)}元，波动${goldChangePercent}%</li>
            <li>价格在窄幅区间震荡，方向不明确</li>
            <li>成交量维持低位，市场交投清淡</li>
            <li>等待明确趋势信号出现</li>
          `;
        }
        
        // 设置止盈止损（基于当前价±2%）
        const goldTarget = (gold.c * 1.02).toFixed(2) + ' 元/克';
        const goldStoploss = (gold.c * 0.98).toFixed(2) + ' 元/克';
        
        document.getElementById('gold-advice').textContent = goldAdvice;
        document.getElementById('gold-advice-reason').innerHTML = goldReason;
        document.getElementById('gold-target').textContent = goldTarget;
        document.getElementById('gold-stoploss').textContent = goldStoploss;
        
        // 设置建议颜色
        if (goldAdvice === '买入') {
          document.getElementById('gold-advice').className = 'text-lg font-semibold text-success';
        } else if (goldAdvice === '卖出') {
          document.getElementById('gold-advice').className = 'text-lg font-semibold text-danger';
        } else {
          document.getElementById('gold-advice').className = 'text-lg font-semibold text-neutral';
        }
      }
      
      // 更新白银建议
      if (silver) {
        // 计算涨跌幅
        const silverChangePercent = ((silver.c - silver.o) / silver.o * 100).toFixed(2);
        let silverAdvice, silverReason;
        
        if (silverChangePercent >= 1.5) {
          silverAdvice = '买入';
          silverReason = `
            <li>今日开盘价${silver.o.toFixed(2)}元，当前价${silver.c.toFixed(2)}元，涨幅${silverChangePercent}%</li>
            <li>价格突破关键阻力位，上涨动能充足</li>
            <li>成交量明显放大，买盘积极</li>
            <li>短期上涨趋势明确</li>
          `;
        } else if (silverChangePercent <= -1) {
          silverAdvice = '卖出';
          silverReason = `
            <li>今日开盘价${silver.o.toFixed(2)}元，当前价${silver.c.toFixed(2)}元，跌幅${Math.abs(silverChangePercent)}%</li>
            <li>价格跌破支撑位，下行压力明显</li>
            <li>抛压持续增加，空头占据主导</li>
            <li>短期下行趋势确立</li>
          `;
        } else {
          silverAdvice = '观望';
          silverReason = `
            <li>今日开盘价${silver.o.toFixed(2)}元，当前价${silver.c.toFixed(2)}元，波动${silverChangePercent}%</li>
            <li>价格在窄幅区间内波动，振幅有限</li>
            <li>成交量持续萎缩，市场交投清淡</li>
            <li>相对开盘价波动范围较小</li>
          `;
        }
        
        // 设置止盈止损（基于当前价±3%）
        const silverTarget = (silver.c * 1.03).toFixed(2) + ' 元/克';
        const silverStoploss = (silver.c * 0.97).toFixed(2) + ' 元/克';
        
        document.getElementById('silver-advice').textContent = silverAdvice;
        document.getElementById('silver-advice-reason').innerHTML = silverReason;
        document.getElementById('silver-target').textContent = silverTarget;
        document.getElementById('silver-stoploss').textContent = silverStoploss;
        
        // 设置建议颜色
        if (silverAdvice === '买入') {
          document.getElementById('silver-advice').className = 'text-lg font-semibold text-success';
        } else if (silverAdvice === '卖出') {
          document.getElementById('silver-advice').className = 'text-lg font-semibold text-danger';
        } else {
          document.getElementById('silver-advice').className = 'text-lg font-semibold text-neutral';
        }
      }
    }

    // 10. 初始化黄金图表
    function initGoldChart() {
      try {
        showLoading('gold');
        
        const ctx = document.getElementById('gold-line').getContext('2d');
        
        // 销毁旧实例
        if (goldLineChart) {
          goldLineChart.destroy();
        }
        
        // 准备数据
        const chartData = goldData.map(item => {
          return {
            x: new Date(item.t),
            y: item.c
          };
        });
        
        // 如果没有数据，显示错误
        if (chartData.length === 0) {
          showError('gold');
          return;
        }
        
        // 获取开盘价用于参考线
        const openPrice = goldData[0].o;
        
        // 计算价格范围并调整Y轴
        const prices = chartData.map(d => d.y);
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const priceRange = maxPrice - minPrice;
        
        // 价格轴上下留10%的余量，确保波动完整显示
        const suggestedMin = priceRange > 0 ? minPrice - priceRange * 0.1 : minPrice - 0.5;
        const suggestedMax = priceRange > 0 ? maxPrice + priceRange * 0.1 : maxPrice + 0.5;
        
        // 创建图表
        goldLineChart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [
              // 价格曲线
              {
                label: '黄金价格',
                data: chartData,
                borderColor: '#0071e3',
                backgroundColor: 'rgba(0, 113, 227, 0.08)',
                borderWidth: 2.5,
                pointRadius: 2,       // 显示数据点
                pointHoverRadius: 5,  // 悬停时放大
                tension: 0.4,         // 适度平滑
                fill: true,
                order: 1
              },
              // 开盘价参考线
              {
                label: '开盘价',
                data: [
                  { x: chartData[0].x, y: openPrice },
                  { x: chartData[chartData.length - 1].x, y: openPrice }
                ],
                borderColor: '#86868b',
                borderWidth: 1.5,
                borderDash: [5, 5], // 虚线
                pointRadius: 0,
                fill: false,
                order: 0 // 放在价格曲线下方
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: '#86868b',
                  callback: function(value) {
                    return formatHourMinute(new Date(this.getLabelForValue(value)));
                  }
                }
              },
              y: {
                position: 'right',
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                min: suggestedMin,  // 应用动态计算的最小值
                max: suggestedMax,  // 应用动态计算的最大值
                ticks: {
                  color: '#86868b',
                  callback: function(v) {
                    return v.toFixed(2);
                  }
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(29, 29, 31, 0.9)',
                callbacks: {
                  label: function(ctx) {
                    if (ctx.datasetIndex === 0) {
                      return '价格: ' + ctx.raw.y.toFixed(2) + ' 元/克';
                    }
                    return false;
                  },
                  title: function(ctx) {
                    return formatTime(new Date(ctx[0].raw.x));
                  }
                }
              }
            },
            animation: {
              duration: 1000
            }
          }
        });
        
        hideLoading('gold');
        hideError('gold');
        
      } catch (e) {
        console.error('黄金图表初始化失败:', e);
        showError('gold');
      }
    }

    // 11. 初始化白银图表
    function initSilverChart() {
      try {
        showLoading('silver');
        
        const ctx = document.getElementById('silver-line').getContext('2d');
        
        // 销毁旧实例
        if (silverLineChart) {
          silverLineChart.destroy();
        }
        
        // 准备数据
        const chartData = silverData.map(item => {
          return {
            x: new Date(item.t),
            y: item.c
          };
        });
        
        // 如果没有数据，显示错误
        if (chartData.length === 0) {
          showError('silver');
          return;
        }
        
        // 获取开盘价用于参考线
        const openPrice = silverData[0].o;
        
        // 计算价格范围并调整Y轴
        const prices = chartData.map(d => d.y);
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const priceRange = maxPrice - minPrice;
        
        // 价格轴上下留10%的余量
        const suggestedMin = priceRange > 0 ? minPrice - priceRange * 0.1 : minPrice - 0.1;
        const suggestedMax = priceRange > 0 ? maxPrice + priceRange * 0.1 : maxPrice + 0.1;
        
        // 创建图表
        silverLineChart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [
              // 价格曲线
              {
                label: '白银价格',
                data: chartData,
                borderColor: '#86868b',
                backgroundColor: 'rgba(134, 134, 139, 0.08)',
                borderWidth: 2.5,
                pointRadius: 2,
                pointHoverRadius: 5,
                tension: 0.4,
                fill: true,
                order: 1
              },
              // 开盘价参考线
              {
                label: '开盘价',
                data: [
                  { x: chartData[0].x, y: openPrice },
                  { x: chartData[chartData.length - 1].x, y: openPrice }
                ],
                borderColor: '#86868b',
                borderWidth: 1.5,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
                order: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: '#86868b',
                  callback: function(value) {
                    return formatHourMinute(new Date(this.getLabelForValue(value)));
                  }
                }
              },
              y: {
                position: 'right',
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                min: suggestedMin,
                max: suggestedMax,
                ticks: {
                  color: '#86868b',
                  callback: function(v) {
                    return v.toFixed(2);
                  }
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                backgroundColor: 'rgba(29, 29, 31, 0.9)',
                callbacks: {
                  label: function(ctx) {
                    if (ctx.datasetIndex === 0) {
                      return '价格: ' + ctx.raw.y.toFixed(2) + ' 元/克';
                    }
                    return false;
                  },
                  title: function(ctx) {
                    return formatTime(new Date(ctx[0].raw.x));
                  }
                }
              }
            },
            animation: {
              duration: 1000
            }
          }
        });
        
        hideLoading('silver');
        hideError('silver');
        
      } catch (e) {
        console.error('白银图表初始化失败:', e);
        showError('silver');
      }
    }

    // 12. 生成历史预测表格（24行）
    function generateHistoryTable(rowCount) {
      const tbody = document.getElementById('history-table');
      tbody.innerHTML = '';
      
      for (let i = 0; i < rowCount; i++) {
        const time = Date.now() - (i + 1) * 3600000; // 每小时一条记录
        const goldAdvice = i % 5 === 0 ? '卖出' : i % 3 === 0 ? '观望' : '买入';
        const silverAdvice = i % 4 === 0 ? '买入' : i % 6 === 0 ? '卖出' : '观望';
        
        // 预测结果
        const goldResult = goldAdvice !== '观望' 
          ? Math.random() > 0.4 ? '盈利' : Math.random() > 0.5 ? '亏损' : '未到止盈止损点' 
          : '--';
        const silverResult = silverAdvice !== '观望' 
          ? Math.random() > 0.4 ? '盈利' : Math.random() > 0.5 ? '亏损' : '未到止盈止损点' 
          : '--';
        
        const tr = document.createElement('tr');
        tr.className = 'border-b border-apple-border hover:bg-apple-light/50 transition-colors';
        
        // 根据结果类型设置不同的样式
        let goldResultClass = '';
        if (goldResult === '盈利') {
          goldResultClass = 'bg-success/10 text-success';
        } else if (goldResult === '亏损') {
          goldResultClass = 'bg-danger/10 text-danger';
        } else if (goldResult === '未到止盈止损点') {
          goldResultClass = 'bg-pending/10 text-pending';
        }
        
        let silverResultClass = '';
        if (silverResult === '盈利') {
          silverResultClass = 'bg-success/10 text-success';
        } else if (silverResult === '亏损') {
          silverResultClass = 'bg-danger/10 text-danger';
        } else if (silverResult === '未到止盈止损点') {
          silverResultClass = 'bg-pending/10 text-pending';
        }
        
        tr.innerHTML = `
          <td class="px-4 py-3 font-medium">${formatTime(time)}</td>
          <td class="px-4 py-3">
            <span class="result-tag ${goldAdvice === '买入' ? 'bg-success/10 text-success' : 
                                  goldAdvice === '卖出' ? 'bg-danger/10 text-danger' : 
                                  'bg-neutral/10 text-neutral'}">
              ${goldAdvice}
            </span>
          </td>
          <td class="px-4 py-3">
            ${goldResult !== '--' ? `<span class="result-tag ${goldResultClass}">${goldResult}</span>` : '--'}
          </td>
          <td class="px-4 py-3">
            <span class="result-tag ${silverAdvice === '买入' ? 'bg-success/10 text-success' : 
                                   silverAdvice === '卖出' ? 'bg-danger/10 text-danger' : 
                                   'bg-neutral/10 text-neutral'}">
              ${silverAdvice}
            </span>
          </td>
          <td class="px-4 py-3">
            ${silverResult !== '--' ? `<span class="result-tag ${silverResultClass}">${silverResult}</span>` : '--'}
          </td>
        `;
        
        tbody.appendChild(tr);
      }
    }

    // 辅助函数：显示/隐藏加载和错误状态
    function showLoading(type) {
      document.getElementById(type + '-chart-loading').classList.remove('hidden');
    }
    function hideLoading(type) {
      document.getElementById(type + '-chart-loading').classList.add('hidden');
    }
    function showError(type) {
      document.getElementById(type + '-chart-loading').classList.add('hidden');
      document.getElementById(type + '-chart-error').classList.remove('hidden');
    }
    function hideError(type) {
      document.getElementById(type + '-chart-error').classList.add('hidden');
    }

    // 初始化页面
    function init() {
      // 刷新按钮事件
      document.getElementById('refresh-gold').addEventListener('click', function() {
        fetchCurrentPrices();
        fetchHistoryData();
      });
      document.getElementById('refresh-silver').addEventListener('click', function() {
        fetchCurrentPrices();
        fetchHistoryData();
      });
      
      // 初始加载数据
      fetchCurrentPrices();
      fetchHistoryData();
      
      // 设置定时刷新（5分钟）
      setInterval(fetchCurrentPrices, 300000);
      setInterval(fetchHistoryData, 300000);
    }

    // 确保DOM加载完成
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      init();
    } else {
      document.addEventListener('DOMContentLoaded', init);
    }
  </script>
</body>
</html>
