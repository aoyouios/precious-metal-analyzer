<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贵金属分析系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
</head>
<body class="p-4 max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">贵金属分析系统</h1>

    <!-- 价格区域 -->
    <div class="bg-white p-4 rounded shadow mb-6">
        <h2 class="font-bold mb-2">当前价格</h2>
        <div id="price-display" class="text-gray-700">加载中...</div>
    </div>

    <!-- 建议区域 -->
    <div class="bg-white p-4 rounded shadow mb-6">
        <h2 class="font-bold mb-2">操作建议</h2>
        <div id="advice-display" class="text-gray-700">加载中...</div>
    </div>

    <!-- 图表区域 -->
    <div class="bg-white p-4 rounded shadow mb-6">
        <h2 class="font-bold mb-2">价格走势</h2>
        <div class="h-64">
            <canvas id="price-chart"></canvas>
        </div>
    </div>

    <script>
        // 配置接口地址
        const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
        let priceChart;

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('price-chart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '黄金价格',
                        data: [],
                        borderColor: '#FFD700',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { title: { display: true, text: '价格（元/克）' } } }
                }
            });
        }

        // 加载价格并更新显示
        async function loadPrice() {
            try {
                const res = await fetch(`${API_BASE}/data`);
                const data = await res.json();
                document.getElementById('price-display').innerHTML = `
                    黄金：${data.gold} 元/克<br>
                    白银：${data.silver} 元/克<br>
                    更新时间：${data.updateTime}
                `;
                return data; // 返回价格供其他函数使用
            } catch (e) {
                document.getElementById('price-display').innerHTML = "价格加载失败（使用默认值）<br>黄金：772.05 元/克<br>白银：8.78 元/克";
                return { gold: "772.05", silver: "8.78" };
            }
        }

        // 加载建议并更新显示
        async function loadAdvice() {
            try {
                const res = await fetch(`${API_BASE}/advice`);
                const advice = await res.json();
                document.getElementById('advice-display').innerHTML = `
                    黄金策略：${advice.gold?.advice || '持有'}<br>
                    进场价：${advice.gold?.entryPrice || '--'} 元/克<br>
                    止盈：${advice.gold?.takeProfit || '--'} 元/克<br>
                    止损：${advice.gold?.stopLoss || '--'} 元/克<br>
                    <br>
                    白银策略：${advice.silver?.advice || '持有'}<br>
                    进场价：${advice.silver?.entryPrice || '--'} 元/克<br>
                    止盈：${advice.silver?.takeProfit || '--'} 元/克<br>
                    止损：${advice.silver?.stopLoss || '--'} 元/克
                `;
            } catch (e) {
                document.getElementById('advice-display').innerHTML = "建议加载失败<br>黄金：持有，白银：持有";
            }
        }

        // 加载历史数据并更新图表
        async function loadHistory() {
            try {
                const res = await fetch(`${API_BASE}/history`);
                const history = await res.json();
                // 提取最近10条黄金数据
                const goldData = history.gold.slice(-10);
                if (goldData.length > 0) {
                    priceChart.data.labels = goldData.map(item => {
                        const d = new Date(item.time);
                        return `${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
                    });
                    priceChart.data.datasets[0].data = goldData.map(item => parseFloat(item.price));
                    priceChart.update();
                } else {
                    priceChart.data.labels = ['暂无数据'];
                    priceChart.data.datasets[0].data = [0];
                    priceChart.update();
                }
            } catch (e) {
                console.log("历史数据加载失败:", e);
                priceChart.data.labels = ['数据加载失败'];
                priceChart.data.datasets[0].data = [0];
                priceChart.update();
            }
        }

        // 页面加载完成后执行
        async function init() {
            initChart(); // 先初始化图表
            await loadPrice(); // 加载价格
            await loadAdvice(); // 加载建议
            await loadHistory(); // 加载历史数据（图表）
        }

        // 启动初始化
        window.onload = init;
    </script>
</body>
</html>
