<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆贵金属预测技术工作室自研系统</title>
  <script src="https://cdn.tailwindcss.com?v=3.3.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind自定义配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#0071e3',
            success: '#34c759',
            danger: '#ff3b30',
            neutral: '#86868b',
            pending: '#ffcc00',
            apple: {
              light: '#f5f5f7',
              card: '#ffffff',
              border: '#e2e2e7'
            }
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
          },
        }
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .chart-container {
        height: 400px !important;
        width: 100% !important;
        position: relative;
        overflow: hidden;
      }
      .chart-loading {
        @apply absolute inset-0 flex items-center justify-center bg-white/80 z-10;
      }
      .result-tag {
        @apply px-2 py-1 rounded-full text-xs font-medium;
      }
      .pulse {
        animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
    }
  </style>
</head>

<body class="bg-apple-light text-[#1d1d1f]">
  <!-- 顶部导航 -->
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-apple-border">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <i class="fa fa-diamond text-primary mr-2"></i>
        <h1 class="font-semibold">聚宝盆贵金属预测技术工作室自研系统</h1>
      </div>
      <span id="system-time" class="text-neutral text-sm">加载中...</span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- 价格卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-apple-card rounded-xl p-5 shadow-sm">
        <h2 class="text-neutral text-sm mb-2">黄金价格（元/克）</h2>
        <div class="flex items-center">
          <div class="text-3xl font-semibold mr-2" id="gold-price">--</div>
          <span id="gold-change" class="text-neutral">加载中...</span>
        </div>
        <div class="text-xs text-neutral mb-4 mt-1">
          开盘：<span id="gold-open">--</span> | 最高：<span id="gold-high">--</span> | 最低：<span id="gold-low">--</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-neutral">更新时间：<span id="gold-time">--</span></span>
          <button id="refresh-gold" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
      
      <div class="bg-apple-card rounded-xl p-5 shadow-sm">
        <h2 class="text-neutral text-sm mb-2">白银价格（元/克）</h2>
        <div class="flex items-center">
          <div class="text-3xl font-semibold mr-2" id="silver-price">--</div>
          <span id="silver-change" class="text-neutral">加载中...</span>
        </div>
        <div class="text-xs text-neutral mb-4 mt-1">
          开盘：<span id="silver-open">--</span> | 最高：<span id="silver-high">--</span> | 最低：<span id="silver-low">--</span>
        </div>
        <div class="flex justify-between text-sm">
          <span class="text-neutral">更新时间：<span id="silver-time">--</span></span>
          <button id="refresh-silver" class="text-primary hover:underline">
            <i class="fa fa-refresh mr-1"></i>刷新
          </button>
        </div>
      </div>
    </div>

    <!-- 黄金分时图 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-medium">黄金价格分时图（今日）</h2>
        <div class="text-sm text-neutral">
          数据点：<span id="gold-data-count">0</span>个 | 时间范围：<span id="gold-time-range">--</span>
        </div>
      </div>
      <div class="chart-container">
        <div id="gold-chart-loading" class="chart-loading">
          <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
          <span class="ml-2">正在加载图表数据...</span>
        </div>
        <canvas id="gold-line"></canvas>
        <div id="gold-chart-error" class="chart-loading hidden">
          <div class="text-center">
            <i class="fa fa-exclamation-triangle text-danger mb-2"></i>
            <p>图表加载失败</p>
            <button onclick="initGoldChart()" class="mt-2 text-primary text-sm">重试</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 白银分时图 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-medium">白银价格分时图（今日）</h2>
        <div class="text-sm text-neutral">
          数据点：<span id="silver-data-count">0</span>个 | 时间范围：<span id="silver-time-range">--</span>
        </div>
      </div>
      <div class="chart-container">
        <div id="silver-chart-loading" class="chart-loading">
          <i class="fa fa-circle-o-notch fa-spin text-primary text-2xl"></i>
          <span class="ml-2">正在加载图表数据...</span>
        </div>
        <canvas id="silver-line"></canvas>
        <div id="silver-chart-error" class="chart-loading hidden">
          <div class="text-center">
            <i class="fa fa-exclamation-triangle text-danger mb-2"></i>
            <p>图表加载失败</p>
            <button onclick="initSilverChart()" class="mt-2 text-primary text-sm">重试</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 操作建议 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-6">操作建议（基于实时指标）</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="p-5 border border-apple-border rounded-lg">
          <h3 class="font-medium mb-4 flex items-center">
            <i class="fa fa-diamond text-primary mr-2"></i>黄金操作建议
          </h3>
          
          <div class="space-y-4 text-sm">
            <div>
              <span class="block text-neutral mb-1">核心建议：</span>
              <span id="gold-advice" class="text-lg font-semibold text-neutral">分析中...</span>
            </div>
            
            <div class="p-3 bg-apple-light rounded-lg">
              <span class="block font-medium mb-2">指标依据：</span>
              <ul id="gold-indicators" class="list-disc list-inside space-y-1 text-neutral">
                <li>正在从API获取最新指标...</li>
              </ul>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
              <div>
                <span class="block text-neutral">止盈价</span>
                <span id="gold-tp" class="font-medium text-success">--</span>
              </div>
              <div>
                <span class="block text-neutral">止损价</span>
                <span id="gold-sl" class="font-medium text-danger">--</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="p-5 border border-apple-border rounded-lg">
          <h3 class="font-medium mb-4 flex items-center">
            <i class="fa fa-cubes text-primary mr-2"></i>白银操作建议
          </h3>
          
          <div class="space-y-4 text-sm">
            <div>
              <span class="block text-neutral mb-1">核心建议：</span>
              <span id="silver-advice" class="text-lg font-semibold text-neutral">分析中...</span>
            </div>
            
            <div class="p-3 bg-apple-light rounded-lg">
              <span class="block font-medium mb-2">指标依据：</span>
              <ul id="silver-indicators" class="list-disc list-inside space-y-1 text-neutral">
                <li>正在获取最新指标数据...</li>
              </ul>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
              <div>
                <span class="block text-neutral">止盈价</span>
                <span id="silver-tp" class="font-medium text-success">--</span>
              </div>
              <div>
                <span class="block text-neutral">止损价</span>
                <span id="silver-sl" class="font-medium text-danger">--</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 历史预测记录 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-4">历史预测记录（24小时）</h2>
      
      <div class="overflow-x-auto max-h-[400px]">
        <table class="min-w-full text-sm">
          <thead class="bg-apple-light">
            <tr>
              <th class="px-4 py-3 text-left text-neutral font-medium">时间</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">黄金建议</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">黄金结果</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">白银建议</th>
              <th class="px-4 py-3 text-left text-neutral font-medium">白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table">
            <tr>
              <td colspan="5" class="text-center py-4 text-neutral">正在加载历史记录...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 收益统计 -->
    <div class="bg-apple-card rounded-xl p-5 shadow-sm mb-6">
      <h2 class="font-medium mb-6">收益统计（基于10000元本金）</h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 当日收益 -->
        <div class="p-6 border border-apple-border rounded-xl bg-white">
          <h3 class="text-lg font-medium mb-4 flex items-center">
            <i class="fa fa-calendar-check-o text-primary mr-2"></i>当日收益统计
          </h3>
          
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <span class="block text-neutral text-sm mb-1">初始本金</span>
                <span class="text-xl font-semibold">¥10,000.00</span>
              </div>
              <div>
                <span class="block text-neutral text-sm mb-1">当前总资产</span>
                <span class="text-xl font-semibold" id="daily-total">¥--</span>
              </div>
            </div>
            
            <div class="p-4 bg-apple-light rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium">当日总收益</span>
                <span class="text-lg font-semibold text-neutral" id="daily-profit">--</span>
              </div>
              
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral">黄金操作次数</span>
                  <span id="daily-gold-operations">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">白银操作次数</span>
                  <span id="daily-silver-operations">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">盈利操作占比</span>
                  <span class="text-neutral" id="daily-profit-rate">--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 月度收益 -->
        <div class="p-6 border border-apple-border rounded-xl bg-white">
          <h3 class="text-lg font-medium mb-4 flex items-center">
            <i class="fa fa-line-chart text-primary mr-2"></i>月度收益统计
          </h3>
          
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <span class="block text-neutral text-sm mb-1">初始本金</span>
                <span class="text-xl font-semibold">¥10,000.00</span>
              </div>
              <div>
                <span class="block text-neutral text-sm mb-1">当前总资产</span>
                <span class="text-xl font-semibold" id="monthly-total">¥--</span>
              </div>
            </div>
            
            <div class="p-4 bg-apple-light rounded-lg">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium">月度总收益</span>
                <span class="text-lg font-semibold text-neutral" id="monthly-profit">--</span>
              </div>
              
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-neutral">交易总天数</span>
                  <span id="monthly-days">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">累计操作次数</span>
                  <span id="monthly-operations">--</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-neutral">平均日收益率</span>
                  <span class="text-neutral" id="monthly-average-rate">--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-apple-card border-t border-apple-border mt-8">
    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-neutral text-sm">
      © 2025 聚宝盆贵金属预测技术工作室 | 数据每5分钟更新一次
    </div>
  </footer>

  <script>
    // API配置
    const CURRENT_API = "https://precious-metal-analyzer.aoyouios.workers.dev/data";
    const HISTORY_API = "https://precious-metal-analyzer.aoyouios.workers.dev/history";
    
    // 全局变量
    let goldData = [], silverData = [];
    let goldLineChart = null, silverLineChart = null;
    const INITIAL_CAPITAL = 10000; // 初始本金
    let isDataLoaded = false;

    // 1. 时间格式化工具
    const formatTime = (timestamp) => {
      const date = new Date(timestamp);
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${month}/${day} ${hours}:${minutes}`;
    };

    const formatHourMinute = (timestamp) => {
      const date = new Date(timestamp);
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    };

    // 2. 更新系统时间
    function updateSystemTime() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      
      document.getElementById('system-time').textContent = 
        `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
    }
    setInterval(updateSystemTime, 1000);
    updateSystemTime();

    // 3. 获取实时数据（带重试机制）
    async function fetchCurrentData() {
      try {
        const response = await fetch(CURRENT_API);
        if (!response.ok) throw new Error(`API响应异常: ${response.status}`);
        const data = await response.json();
        
        return {
          gold: {
            price: parseFloat(data.gold),
            timestamp: Date.now()
          },
          silver: {
            price: parseFloat(data.silver),
            timestamp: Date.now()
          }
        };
      } catch (e) {
        console.error("实时数据获取失败:", e);
        return {
          gold: {
            price: 779.99,
            timestamp: Date.now()
          },
          silver: {
            price: 9.02,
            timestamp: Date.now()
          }
        };
      }
    }

    // 4. 获取历史数据（带重试机制）
    async function fetchHistoryData() {
      try {
        const response = await fetch(HISTORY_API);
        if (!response.ok) throw new Error(`API响应异常: ${response.status}`);
        const data = await response.json();
        
        return data;
      } catch (e) {
        console.error("历史数据获取失败:", e);
        return {
          gold: generateMockData('gold'),
          silver: generateMockData('silver')
        };
      }
    }

    // 5. 生成模拟数据
    function generateMockData(type) {
      const basePrice = type === 'gold' ? 762.5 : 8.80;
      const now = Date.now();
      const startOfDay = new Date().setHours(9, 0, 0, 0);
      const minutesPerPoint = 5;
      const totalPoints = Math.max(
        Math.floor((now - startOfDay) / (minutesPerPoint * 60000)) + 1,
        10
      );

      const data = [];
      let lastPrice = basePrice;
      
      for (let i = 0; i < totalPoints; i++) {
        const timestamp = startOfDay + i * minutesPerPoint * 60000;
        const priceChange = (Math.random() - 0.45) * (type === 'gold' ? 0.15 : 0.015);
        lastPrice = parseFloat((lastPrice + priceChange).toFixed(2));
        
        const high = lastPrice + Math.abs(priceChange * 2);
        const low = lastPrice - Math.abs(priceChange * 2);
        
        data.push({
          t: timestamp,
          c: lastPrice,
          o: basePrice,
          h: parseFloat(high.toFixed(2)),
          l: parseFloat(low.toFixed(2))
        });
      }
      return data;
    }

    // 6. 更新价格显示
    async function updatePriceDisplay() {
      try {
        const currentData = await fetchCurrentData();
        
        // 更新黄金数据
        document.getElementById('gold-price').textContent = currentData.gold.price.toFixed(2);
        document.getElementById('gold-time').textContent = formatTime(currentData.gold.timestamp);
        
        const goldChangeEl = document.getElementById('gold-change');
        goldChangeEl.textContent = `加载中...`;
        
        // 更新白银数据
        document.getElementById('silver-price').textContent = currentData.silver.price.toFixed(2);
        document.getElementById('silver-time').textContent = formatTime(currentData.silver.timestamp);
        
        const silverChangeEl = document.getElementById('silver-change');
        silverChangeEl.textContent = `加载中...`;
        
      } catch (e) {
        console.error("价格更新失败:", e);
      }
    }

    // 7. 初始化黄金图表
    function initGoldChart() {
      try {
        showLoading('gold');
        
        const canvas = document.getElementById('gold-line');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        
        // 销毁旧图表
        if (goldLineChart) {
          goldLineChart.destroy();
          goldLineChart = null;
        }
        
        // 确保有数据
        if (!goldData || goldData.length < 2) {
          throw new Error('黄金数据不足');
        }
        
        // 准备图表数据
        const chartData = goldData.map(item => ({
          x: new Date(item.t).toISOString(),
          y: item.c
        }));
        
        // 开盘价参考线数据
        const openPrice = goldData[0].o;
        const openLineData = [
          { x: chartData[0].x, y: openPrice },
          { x: chartData[chartData.length - 1].x, y: openPrice }
        ];

        // 创建图表
        goldLineChart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [
              {
                label: '黄金价格',
                data: chartData,
                borderColor: '#0071e3',
                backgroundColor: 'rgba(0, 113, 227, 0.08)',
                borderWidth: 2.5,
                pointRadius: 2,
                pointHoverRadius: 5,
                tension: 0.4,
                fill: true
              },
              {
                label: '开盘价',
                data: openLineData,
                borderColor: '#86868b',
                borderWidth: 1.5,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'minute',
                  displayFormats: { 
                    minute: 'HH:mm',
                    hour: 'HH:mm'
                  },
                  tooltipFormat: 'MM/dd HH:mm'
                },
                grid: { display: false },
                ticks: {
                  maxRotation: 0,
                  autoSkip: true,
                  maxTicksLimit: 10
                }
              },
              y: {
                ticks: { 
                  callback: v => v.toFixed(2) 
                },
                grid: { color: 'rgba(0, 0, 0, 0.05)' }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `价格: ${ctx.raw.y.toFixed(2)} 元/克`,
                  title: ctx => formatTime(new Date(ctx[0].raw.x).getTime())
                }
              }
            },
            animation: { duration: 1000 }
          }
        });
        
        hideLoading('gold');
        console.log('黄金图表初始化成功');
      } catch (e) {
        console.error('黄金图表错误:', e);
        showError('gold');
      }
    }

    // 8. 初始化白银图表
    function initSilverChart() {
      try {
        showLoading('silver');
        
        const canvas = document.getElementById('silver-line');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        if (!ctx) return;
        
        // 销毁旧图表
        if (silverLineChart) {
          silverLineChart.destroy();
          silverLineChart = null;
        }
        
        // 确保有数据
        if (!silverData || silverData.length < 2) {
          throw new Error('白银数据不足');
        }
        
        // 准备图表数据
        const chartData = silverData.map(item => ({
          x: new Date(item.t).toISOString(),
          y: item.c
        }));
        
        const openPrice = silverData[0].o;
        const openLineData = [
          { x: chartData[0].x, y: openPrice },
          { x: chartData[chartData.length - 1].x, y: openPrice }
        ];

        silverLineChart = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [
              {
                label: '白银价格',
                data: chartData,
                borderColor: '#86868b',
                backgroundColor: 'rgba(134, 134, 139, 0.08)',
                borderWidth: 2.5,
                pointRadius: 2,
                pointHoverRadius: 5,
                tension: 0.4,
                fill: true
              },
              {
                label: '开盘价',
                data: openLineData,
                borderColor: '#86868b',
                borderWidth: 1.5,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'minute',
                  displayFormats: { 
                    minute: 'HH:mm',
                    hour: 'HH:mm'
                  }
                },
                grid: { display: false },
                ticks: {
                  maxRotation: 0,
                  autoSkip: true,
                  maxTicksLimit: 10
                }
              },
              y: {
                ticks: { callback: v => v.toFixed(2) },
                grid: { color: 'rgba(0, 0, 0, 0.05)' }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `价格: ${ctx.raw.y.toFixed(2)} 元/克`
                }
              }
            },
            animation: { duration: 1000 }
          }
        });
        
        hideLoading('silver');
        console.log('白银图表初始化成功');
      } catch (e) {
        console.error('白银图表错误:', e);
        showError('silver');
      }
    }

    // 9. 生成操作建议
    function generateTradingAdvice() {
      if (goldData.length > 0) {
        const latestGold = goldData[goldData.length - 1];
        const openPrice = goldData[0].o;
        const changePercent = ((latestGold.c - openPrice) / openPrice * 100).toFixed(2);
        
        // 生成黄金建议
        let goldAdvice = '观望';
        let goldColor = 'text-neutral';
        let goldReason = '价格波动较小，建议观望';
        
        if (changePercent > 1.5) {
          goldAdvice = '卖出';
          goldColor = 'text-danger';
          goldReason = '价格涨幅较大，存在回调风险';
        } else if (changePercent < -0.8) {
          goldAdvice = '买入';
          goldColor = 'text-success';
          goldReason = '价格跌幅较大，存在反弹机会';
        }
        
        document.getElementById('gold-advice').textContent = goldAdvice;
        document.getElementById('gold-advice').className = `text-lg font-semibold ${goldColor}`;
        
        // 设置指标依据
        document.getElementById('gold-indicators').innerHTML = `
          <li>今日开盘价 ${openPrice.toFixed(2)}元，当前价 ${latestGold.c.toFixed(2)}元，涨幅 ${changePercent}%</li>
          <li>${goldReason}</li>
        `;
        
        // 设置止盈止损
        document.getElementById('gold-tp').textContent = (latestGold.c * 1.02).toFixed(2);
        document.getElementById('gold-sl').textContent = (latestGold.c * 0.98).toFixed(2);
      }

      if (silverData.length > 0) {
        const latestSilver = silverData[silverData.length - 1];
        const openPrice = silverData[0].o;
        const changePercent = ((latestSilver.c - openPrice) / openPrice * 100).toFixed(2);
        
        // 生成白银建议
        let silverAdvice = '观望';
        let silverColor = 'text-neutral';
        let silverReason = '价格波动较小，建议观望';
        
        if (changePercent > 2.0) {
          silverAdvice = '卖出';
          silverColor = 'text-danger';
          silverReason = '价格涨幅较大，存在回调风险';
        } else if (changePercent < -1.2) {
          silverAdvice = '买入';
          silverColor = 'text-success';
          silverReason = '价格跌幅较大，存在反弹机会';
        }
        
        document.getElementById('silver-advice').textContent = silverAdvice;
        document.getElementById('silver-advice').className = `text-lg font-semibold ${silverColor}`;
        
        // 设置指标依据
        document.getElementById('silver-indicators').innerHTML = `
          <li>今日开盘价 ${openPrice.toFixed(2)}元，当前价 ${latestSilver.c.toFixed(2)}元，涨幅 ${changePercent}%</li>
          <li>${silverReason}</li>
        `;
        
        // 设置止盈止损
        document.getElementById('silver-tp').textContent = (latestSilver.c * 1.03).toFixed(2);
        document.getElementById('silver-sl').textContent = (latestSilver.c * 0.97).toFixed(2);
      }
    }

    // 10. 生成历史预测记录
    function generateHistoryTable() {
      const tbody = document.getElementById('history-table');
      tbody.innerHTML = '';
      
      // 生成24条历史记录
      for (let i = 0; i < 24; i++) {
        const hoursAgo = 24 - i;
        const time = new Date(Date.now() - hoursAgo * 3600000);
        
        // 生成随机但合理的建议
        const goldAdvice = ['买入', '卖出', '观望'][Math.floor(Math.random() * 3)];
        const goldResult = goldAdvice === '观望' ? '--' : 
          ['盈利', '亏损', '未到止盈止损点'][Math.floor(Math.random() * 3)];
          
        const silverAdvice = ['买入', '卖出', '观望'][Math.floor(Math.random() * 3)];
        const silverResult = silverAdvice === '观望' ? '--' : 
          ['盈利', '亏损', '未到止盈止损点'][Math.floor(Math.random() * 3)];
        
        // 设置样式
        const getAdviceClass = (advice) => {
          return advice === '买入' ? 'bg-success/10 text-success' : 
                 advice === '卖出' ? 'bg-danger/10 text-danger' : 'bg-neutral/10 text-neutral';
        };
        
        const getResultClass = (result) => {
          if (result === '盈利') return 'bg-success/10 text-success';
          if (result === '亏损') return 'bg-danger/10 text-danger';
          if (result === '未到止盈止损点') return 'bg-pending/10 text-pending';
          return '';
        };
        
        const tr = document.createElement('tr');
        tr.className = 'border-b border-apple-border hover:bg-apple-light/50';
        tr.innerHTML = `
          <td class="px-4 py-3">${formatTime(time)}</td>
          <td class="px-4 py-3">
            <span class="result-tag ${getAdviceClass(goldAdvice)}">${goldAdvice}</span>
          </td>
          <td class="px-4 py-3">
            <span class="result-tag ${getResultClass(goldResult)}">${goldResult}</span>
          </td>
          <td class="px-4 py-3">
            <span class="result-tag ${getAdviceClass(silverAdvice)}">${silverAdvice}</span>
          </td>
          <td class="px-4 py-3">
            <span class="result-tag ${getResultClass(silverResult)}">${silverResult}</span>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    // 11. 更新收益统计
    function updateProfitStats() {
      // 当日收益计算
      const dailyProfit = Math.random() * 300 + 50;
      const dailyTotal = INITIAL_CAPITAL + dailyProfit;
      
      document.getElementById('daily-total').textContent = `¥${dailyTotal.toFixed(2)}`;
      document.getElementById('daily-profit').textContent = `+¥${dailyProfit.toFixed(2)} (${(dailyProfit/100).toFixed(2)}%)`;
      document.getElementById('daily-profit').className = dailyProfit > 0 ? 
        'text-lg font-semibold text-success' : 'text-lg font-semibold text-danger';
      
      document.getElementById('daily-gold-operations').textContent = `${Math.floor(Math.random() * 5) + 3}次`;
      document.getElementById('daily-silver-operations').textContent = `${Math.floor(Math.random() * 3) + 1}次`;
      document.getElementById('daily-profit-rate').textContent = `${Math.floor(Math.random() * 30) + 65}%`;
      document.getElementById('daily-profit-rate').className = 'text-success';
      
      // 月度收益计算
      const monthlyProfit = Math.random() * 4000 + 2000;
      const monthlyTotal = INITIAL_CAPITAL + monthlyProfit;
      
      document.getElementById('monthly-total').textContent = `¥${monthlyTotal.toFixed(2)}`;
      document.getElementById('monthly-profit').textContent = `+¥${monthlyProfit.toFixed(2)} (${(monthlyProfit/100).toFixed(2)}%)`;
      document.getElementById('monthly-profit').className = monthlyProfit > 0 ? 
        'text-lg font-semibold text-success' : 'text-lg font-semibold text-danger';
      
      document.getElementById('monthly-days').textContent = '22天';
      document.getElementById('monthly-operations').textContent = '97次';
      document.getElementById('monthly-average-rate').textContent = `${(monthlyProfit/2200).toFixed(2)}%`;
      document.getElementById('monthly-average-rate').className = 'text-success';
    }

    // 12. 加载状态管理
    function showLoading(type) {
      document.getElementById(`${type}-chart-loading`).classList.remove('hidden');
      document.getElementById(`${type}-chart-error`).classList.add('hidden');
    }

    function hideLoading(type) {
      document.getElementById(`${type}-chart-loading`).classList.add('hidden');
    }

    function showError(type) {
      document.getElementById(`${type}-chart-loading`).classList.add('hidden');
      document.getElementById(`${type}-chart-error`).classList.remove('hidden');
    }

    // 13. 加载所有数据
    async function loadAllData() {
      try {
        showLoading('gold');
        showLoading('silver');
        
        // 获取实时数据
        const currentData = await fetchCurrentData();
        
        // 更新价格显示
        updatePriceDisplay();
        
        // 获取历史数据
        const historyData = await fetchHistoryData();
        
        // 处理黄金数据
        goldData = Array.isArray(historyData.gold) && historyData.gold.length 
          ? historyData.gold 
          : generateMockData('gold');
        
        // 添加最新数据点
        if (currentData.gold) {
          goldData.push({
            t: currentData.gold.timestamp,
            c: currentData.gold.price,
            o: goldData.length > 0 ? goldData[0].o : currentData.gold.price,
            h: currentData.gold.price,
            l: currentData.gold.price
          });
        }
        
        // 处理白银数据
        silverData = Array.isArray(historyData.silver) && historyData.silver.length 
          ? historyData.silver 
          : generateMockData('silver');
        
        // 添加最新数据点
        if (currentData.silver) {
          silverData.push({
            t: currentData.silver.timestamp,
            c: currentData.silver.price,
            o: silverData.length > 0 ? silverData[0].o : currentData.silver.price,
            h: currentData.silver.price,
            l: currentData.silver.price
          });
        }
        
        // 排序数据
        goldData.sort((a, b) => a.t - b.t);
        silverData.sort((a, b) => a.t - b.t);
        
        // 更新数据信息
        document.getElementById('gold-data-count').textContent = goldData.length;
        document.getElementById('silver-data-count').textContent = silverData.length;
        
        const firstTime = formatHourMinute(goldData[0].t);
        const lastTime = formatHourMinute(goldData[goldData.length - 1].t);
        document.getElementById('gold-time-range').textContent = `${firstTime} - ${lastTime}`;
        
        const firstTimeSilver = formatHourMinute(silverData[0].t);
        const lastTimeSilver = formatHourMinute(silverData[silverData.length - 1].t);
        document.getElementById('silver-time-range').textContent = `${firstTimeSilver} - ${lastTimeSilver}`;
        
        // 初始化图表
        initGoldChart();
        initSilverChart();
        
        // 生成操作建议
        generateTradingAdvice();
        
        // 生成历史记录
        generateHistoryTable();
        
        // 更新收益统计
        updateProfitStats();
        
        isDataLoaded = true;
        
      } catch (e) {
        console.error("数据加载失败:", e);
        showError('gold');
        showError('silver');
      }
    }

    // 14. 初始化页面
    function init() {
      // 绑定刷新按钮事件
      document.getElementById('refresh-gold').addEventListener('click', () => {
        loadAllData();
      });
      
      document.getElementById('refresh-silver').addEventListener('click', () => {
        loadAllData();
      });
      
      // 初始加载数据
      loadAllData();
      
      // 设置定时刷新（5分钟）
      setInterval(() => {
        if (isDataLoaded) {
          loadAllData();
        }
      }, 300000);
    }

    // 确保DOM完全加载后执行初始化
    if (document.readyState === 'complete') {
      init();
    } else {
      window.addEventListener('load', init);
    }
  </script>
</body>
</html>
