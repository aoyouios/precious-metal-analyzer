<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆专业贵金属分析系统</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <style>
    .chart-container { height: 300px; margin: 10px 0; }
    .sub-chart { height: 180px; margin: 10px 0; }
    .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .history-table th, .history-table td { border: 1px solid #444; padding: 8px; text-align: left; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">聚宝盆专业贵金属分析系统</h1>

    <!-- 实时价格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-gray-800 p-4 rounded">
        <h2>黄金价格</h2>
        <div class="text-3xl" id="gold-price">772.05</div>
        <div class="text-sm text-gray-400" id="gold-time">更新时间：2025/7/22 03:34:21</div>
      </div>
      <div class="bg-gray-800 p-4 rounded">
        <h2>白银价格</h2>
        <div class="text-3xl" id="silver-price">8.78</div>
        <div class="text-sm text-gray-400" id="silver-time">更新时间：2025/7/22 03:34:21</div>
      </div>
    </div>

    <!-- 黄金图表（用柱状图替代K线，折线图替代分时） -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>黄金专业图表</h2>
      <div class="chart-container">
        <canvas id="gold-chart"></canvas>
      </div>
      <div class="sub-chart">
        <canvas id="gold-line"></canvas>
      </div>
    </div>

    <!-- 白银图表 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>白银专业图表</h2>
      <div class="chart-container">
        <canvas id="silver-chart"></canvas>
      </div>
      <div class="sub-chart">
        <canvas id="silver-line"></canvas>
      </div>
    </div>

    <!-- 操作建议 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>智能操作建议</h2>
      <div id="advice" class="p-3 bg-gray-700 rounded">
        <div>黄金：观望（当前价：772.05，止盈：787.49，止损：756.61）</div>
        <div>白银：观望（当前价：8.78，止盈：8.95，止损：8.60）</div>
      </div>
    </div>

    <!-- 历史对比 -->
    <div class="bg-gray-800 p-4 rounded">
      <h2>历史建议对比</h2>
      <div class="overflow-x-auto">
        <table class="history-table">
          <thead>
            <tr class="bg-gray-700">
              <th>时间</th>
              <th>黄金建议</th>
              <th>黄金结果</th>
              <th>白银建议</th>
              <th>白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <tr><td>2025/7/22 10:34:20</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
            <tr><td>2025/7/22 09:34:20</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";

    // 1. 生成默认数据
    function generateData(type) {
      const base = type === 'gold' ? 772 : 8.78;
      const data = [];
      for (let i = 10; i >= 0; i--) {
        const c = +(base + (Math.random() - 0.5) * (type === 'gold' ? 1 : 0.1)).toFixed(2);
        data.push({
          time: `T${i}`,
          value: c
        });
      }
      return data;
    }

    // 2. 初始化黄金图表
    function initGoldCharts() {
      const data = generateData('gold');
      
      // 主图表（柱状图）
      new Chart(document.getElementById('gold-chart'), {
        type: 'bar',
        data: {
          labels: data.map(item => item.time),
          datasets: [{
            label: '黄金价格',
            data: data.map(item => item.value),
            backgroundColor: 'rgba(255, 215, 0, 0.7)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { title: { display: true, text: '价格（元/克）' } }
          }
        }
      });

      // 分时图（折线图）
      new Chart(document.getElementById('gold-line'), {
        type: 'line',
        data: {
          labels: data.map(item => item.time),
          datasets: [{
            label: '黄金走势',
            data: data.map(item => item.value),
            borderColor: 'rgb(255, 215, 0)',
            fill: true,
            backgroundColor: 'rgba(255, 215, 0, 0.1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // 3. 初始化白银图表
    function initSilverCharts() {
      const data = generateData('silver');
      
      // 主图表（柱状图）
      new Chart(document.getElementById('silver-chart'), {
        type: 'bar',
        data: {
          labels: data.map(item => item.time),
          datasets: [{
            label: '白银价格',
            data: data.map(item => item.value),
            backgroundColor: 'rgba(192, 192, 192, 0.7)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { title: { display: true, text: '价格（元/克）' } }
          }
        }
      });

      // 分时图（折线图）
      new Chart(document.getElementById('silver-line'), {
        type: 'line',
        data: {
          labels: data.map(item => item.time),
          datasets: [{
            label: '白银走势',
            data: data.map(item => item.value),
            borderColor: 'rgb(192, 192, 192)',
            fill: true,
            backgroundColor: 'rgba(192, 192, 192, 0.1)'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // 4. 加载真实数据更新图表
    async function loadRealData() {
      try {
        const res = await fetch(`${API_BASE}/history`);
        if (res.ok) {
          const history = await res.json();
          // 用真实数据更新图表（如果有）
          if (history.gold && history.gold.length > 0) {
            updateChart('gold-chart', 'gold-line', history.gold);
          }
          if (history.silver && history.silver.length > 0) {
            updateChart('silver-chart', 'silver-line', history.silver);
          }
        }
      } catch (e) {
        console.log("真实数据加载失败，不影响显示");
      }
    }

    // 5. 更新图表数据
    function updateChart(barId, lineId, data) {
      const labels = data.map((_, i) => `T${i}`);
      const values = data.map(item => item.c);
      
      // 更新柱状图
      const barChart = Chart.getChart(barId);
      barChart.data.labels = labels;
      barChart.data.datasets[0].data = values;
      barChart.update();

      // 更新折线图
      const lineChart = Chart.getChart(lineId);
      lineChart.data.labels = labels;
      lineChart.data.datasets[0].data = values;
      lineChart.update();
    }

    // 页面加载后立即执行
    window.onload = () => {
      initGoldCharts();
      initSilverCharts();
      loadRealData(); // 后台更新真实数据
    };
  </script>
</body>
</html>
