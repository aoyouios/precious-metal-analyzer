<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆专业贵金属分析系统</title>
  <!-- 核心依赖库 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
  
  <style>
    .chart-container { height: 300px; margin: 10px 0; border: 1px solid #444; border-radius: 4px; }
    .sub-chart { height: 180px; margin: 10px 0; border: 1px solid #444; border-radius: 4px; }
    .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .history-table th, .history-table td { border: 1px solid #444; padding: 8px; text-align: left; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <!-- 系统标题 -->
    <h1 class="text-3xl font-bold mb-6 flex items-center">
      <i class="fa fa-line-chart text-yellow-400 mr-2"></i>
      聚宝盆专业贵金属分析系统
    </h1>

    <!-- 实时价格卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-gray-800 rounded-lg p-4 border border-yellow-500/20">
        <h2 class="font-bold mb-2 flex items-center">
          <i class="fa fa-diamond text-yellow-400 mr-2"></i>黄金价格
        </h2>
        <div class="text-3xl font-bold" id="gold-price">加载中...</div>
        <div class="text-sm text-gray-400 mt-1" id="gold-time">更新时间：--</div>
      </div>
      <div class="bg-gray-800 rounded-lg p-4 border border-gray-500/30">
        <h2 class="font-bold mb-2 flex items-center">
          <i class="fa fa-diamond text-gray-300 mr-2"></i>白银价格
        </h2>
        <div class="text-3xl font-bold" id="silver-price">加载中...</div>
        <div class="text-sm text-gray-400 mt-1" id="silver-time">更新时间：--</div>
      </div>
    </div>

    <!-- 黄金图表区域 -->
    <div class="bg-gray-800 rounded-lg p-4 mb-6">
      <h2 class="font-bold mb-4">黄金专业图表</h2>
      <div class="chart-container" id="gold-candlestick">
        <div class="h-full flex items-center justify-center text-gray-500" id="gold-candlestick-loading">
          <i class="fa fa-spinner fa-spin mr-2"></i>加载K线图中...
        </div>
      </div>
      <div class="sub-chart" id="gold-line"></div>
    </div>

    <!-- 白银图表区域 -->
    <div class="bg-gray-800 rounded-lg p-4 mb-6">
      <h2 class="font-bold mb-4">白银专业图表</h2>
      <div class="chart-container" id="silver-candlestick">
        <div class="h-full flex items-center justify-center text-gray-500" id="silver-candlestick-loading">
          <i class="fa fa-spinner fa-spin mr-2"></i>加载K线图中...
        </div>
      </div>
      <div class="sub-chart" id="silver-line"></div>
    </div>

    <!-- 操作建议 -->
    <div class="bg-gray-800 rounded-lg p-4 mb-6">
      <h2 class="font-bold mb-4">智能操作建议</h2>
      <div id="advice" class="space-y-4">
        <div class="p-3 bg-gray-700 rounded flex items-center justify-center">
          <i class="fa fa-spinner fa-spin mr-2"></i>加载建议中...
        </div>
      </div>
    </div>

    <!-- 历史对比模块 -->
    <div class="bg-gray-800 rounded-lg p-4">
      <h2 class="font-bold mb-4">历史建议对比</h2>
      <div class="overflow-x-auto">
        <table class="history-table">
          <thead>
            <tr class="bg-gray-700">
              <th>时间</th>
              <th>黄金建议</th>
              <th>黄金结果</th>
              <th>白银建议</th>
              <th>白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <tr>
              <td colspan="5" class="text-center p-3">
                <i class="fa fa-spinner fa-spin mr-2"></i>加载历史数据中...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // 后端API地址
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
    // 图表实例
    let goldCandlestick, goldLine, silverCandlestick, silverLine;

    // 1. 初始化图表（确保K线图必显）
    function initCharts() {
      // 黄金K线图（核心修复：确保插件正确初始化）
      const goldCandlestickCtx = document.getElementById('gold-candlestick').getContext('2d');
      goldCandlestick = new Chart(goldCandlestickCtx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: '黄金K线',
            data: [],
            color: {
              up: 'rgb(255, 0, 0)',   // 上涨K线（红色）
              down: 'rgb(0, 255, 0)', // 下跌K线（绿色）
              unchanged: 'rgb(128, 128, 128)'
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'hour' },
              grid: { color: 'rgba(255,255,255,0.05)' }
            },
            y: {
              title: { display: true, text: '价格（元/克）' },
              grid: { color: 'rgba(255,255,255,0.05)' }
            }
          }
        }
      });

      // 黄金分时图
      const goldLineCtx = document.getElementById('gold-line').getContext('2d');
      goldLine = new Chart(goldLineCtx, {
        type: 'line',
        data: {
          datasets: [{
            label: '黄金价格走势',
            data: [],
            borderColor: 'rgb(255, 215, 0)',
            backgroundColor: 'rgba(255,215,0,0.1)',
            fill: true,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { type: 'time', grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { display: false }
          }
        }
      });

      // 白银K线图
      const silverCandlestickCtx = document.getElementById('silver-candlestick').getContext('2d');
      silverCandlestick = new Chart(silverCandlestickCtx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: '白银K线',
            data: [],
            color: {
              up: 'rgb(255, 0, 0)',
              down: 'rgb(0, 255, 0)',
              unchanged: 'rgb(128, 128, 128)'
            }
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: { unit: 'hour' },
              grid: { color: 'rgba(255,255,255,0.05)' }
            },
            y: {
              title: { display: true, text: '价格（元/克）' },
              grid: { color: 'rgba(255,255,255,0.05)' }
            }
          }
        }
      });

      // 白银分时图
      const silverLineCtx = document.getElementById('silver-line').getContext('2d');
      silverLine = new Chart(silverLineCtx, {
        type: 'line',
        data: {
          datasets: [{
            label: '白银价格走势',
            data: [],
            borderColor: 'rgb(192, 192, 192)',
            backgroundColor: 'rgba(192,192,192,0.1)',
            fill: true,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { type: 'time', grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { display: false }
          }
        }
      });

      // 隐藏加载提示
      document.getElementById('gold-candlestick-loading').style.display = 'none';
      document.getElementById('silver-candlestick-loading').style.display = 'none';
    }

    // 2. 生成模拟K线数据（确保无真实数据时显示）
    function generateMockData(type) {
      const basePrice = type === 'gold' ? 772 : 8.78;
      const data = [];
      // 生成12条模拟数据（过去12小时）
      for (let i = 12; i >= 0; i--) {
        const close = +(basePrice + (Math.random() - 0.5) * (type === 'gold' ? 2 : 0.2)).toFixed(2);
        data.push({
          t: Date.now() - i * 3600000,
          o: +(close - Math.random() * 0.1).toFixed(2),
          h: +(close + Math.random() * 0.1).toFixed(2),
          l: +(close - Math.random() * 0.15).toFixed(2),
          c: close
        });
      }
      return data;
    }

    // 3. 更新图表数据
    function updateCharts(goldData, silverData) {
      // 更新黄金K线图
      goldCandlestick.data.datasets[0].data = goldData.map(item => ({
        x: new Date(item.t),
        o: item.o,
        h: item.h,
        l: item.l,
        c: item.c
      }));
      goldCandlestick.update();

      // 更新黄金分时图
      goldLine.data.datasets[0].data = goldData.map(item => ({
        x: new Date(item.t),
        y: item.c
      }));
      goldLine.update();

      // 更新白银K线图
      silverCandlestick.data.datasets[0].data = silverData.map(item => ({
        x: new Date(item.t),
        o: item.o,
        h: item.h,
        l: item.l,
        c: item.c
      }));
      silverCandlestick.update();

      // 更新白银分时图
      silverLine.data.datasets[0].data = silverData.map(item => ({
        x: new Date(item.t),
        y: item.c
      }));
      silverLine.update();
    }

    // 4. 加载并显示所有数据（全容错处理）
    async function loadAllData() {
      // 先显示模拟数据确保不空白
      const goldMock = generateMockData('gold');
      const silverMock = generateMockData('silver');
      updateCharts(goldMock, silverMock);
      
      try {
        // 并行请求所有接口
        const [priceRes, historyRes, adviceRes, historyAdviceRes] = await Promise.all([
          fetch(`${API_BASE}/data`).catch(() => ({ ok: false })),
          fetch(`${API_BASE}/history`).catch(() => ({ ok: false })),
          fetch(`${API_BASE}/advice`).catch(() => ({ ok: false })),
          fetch(`${API_BASE}/advice-history`).catch(() => ({ ok: false }))
        ]);

        // 处理实时价格
        let goldPrice = '772.05', silverPrice = '8.78', updateTime = new Date().toLocaleString();
        if (priceRes.ok) {
          const priceData = await priceRes.json();
          goldPrice = priceData.gold || goldPrice;
          silverPrice = priceData.silver || silverPrice;
          updateTime = priceData.updateTime || updateTime;
        }
        document.getElementById('gold-price').textContent = goldPrice;
        document.getElementById('silver-price').textContent = silverPrice;
        document.getElementById('gold-time').textContent = `更新时间：${updateTime}`;
        document.getElementById('silver-time').textContent = `更新时间：${updateTime}`;

        // 处理历史数据（更新图表）
        if (historyRes.ok) {
          const historyData = await historyRes.json();
          const finalGoldData = historyData.gold && historyData.gold.length > 0 
            ? historyData.gold 
            : goldMock;
          const finalSilverData = historyData.silver && historyData.silver.length > 0 
            ? historyData.silver 
            : silverMock;
          updateCharts(finalGoldData, finalSilverData);
        }

        // 处理操作建议
        if (adviceRes.ok) {
          const advice = await adviceRes.json();
          document.getElementById('advice').innerHTML = `
            <div class="p-3 bg-yellow-900/20 rounded border border-yellow-500/30">
              <h3 class="font-bold text-yellow-400">黄金建议</h3>
              <p>操作：${advice.gold.advice || '观望'}</p>
              <p>进场价：${advice.gold.entryPrice || goldPrice}</p>
              <p>止盈：${advice.gold.takeProfit || (+goldPrice * 1.02).toFixed(2)}</p>
              <p>止损：${advice.gold.stopLoss || (+goldPrice * 0.98).toFixed(2)}</p>
            </div>
            <div class="p-3 bg-gray-700 rounded">
              <h3 class="font-bold text-gray-300">白银建议</h3>
              <p>操作：${advice.silver.advice || '观望'}</p>
              <p>进场价：${advice.silver.entryPrice || silverPrice}</p>
              <p>止盈：${advice.silver.takeProfit || (+silverPrice * 1.02).toFixed(2)}</p>
              <p>止损：${advice.silver.stopLoss || (+silverPrice * 0.98).toFixed(2)}</p>
            </div>
          `;
        } else {
          // 建议接口失败时显示默认建议
          document.getElementById('advice').innerHTML = `
            <div class="p-3 bg-yellow-900/20 rounded border border-yellow-500/30">
              <h3 class="font-bold text-yellow-400">黄金建议（默认）</h3>
              <p>操作：观望</p>
              <p>进场价：${goldPrice}</p>
              <p>止盈：${(+goldPrice * 1.02).toFixed(2)}</p>
              <p>止损：${(+goldPrice * 0.98).toFixed(2)}</p>
            </div>
            <div class="p-3 bg-gray-700 rounded">
              <h3 class="font-bold text-gray-300">白银建议（默认）</h3>
              <p>操作：观望</p>
              <p>进场价：${silverPrice}</p>
              <p>止盈：${(+silverPrice * 1.02).toFixed(2)}</p>
              <p>止损：${(+silverPrice * 0.98).toFixed(2)}</p>
            </div>
          `;
        }

        // 处理历史对比数据
        const historyTableBody = document.getElementById('history-table-body');
        if (historyAdviceRes.ok) {
          const historyAdvice = await historyAdviceRes.json();
          if (historyAdvice.length > 0) {
            let html = '';
            // 显示最近5条记录
            historyAdvice.slice(-5).forEach(item => {
              const time = new Date(item.time).toLocaleString();
              html += `
                <tr>
                  <td>${time}</td>
                  <td>${item.gold.advice}</td>
                  <td>${item.goldResult || '--'}</td>
                  <td>${item.silver.advice}</td>
                  <td>${item.silverResult || '--'}</td>
                </tr>
              `;
            });
            historyTableBody.innerHTML = html;
          } else {
            // 无历史数据时显示示例
            historyTableBody.innerHTML = `
              <tr><td>2025-07-22 02:00</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
              <tr><td>2025-07-22 01:00</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
            `;
          }
        } else {
          // 历史接口失败时显示示例
          historyTableBody.innerHTML = `
            <tr><td>2025-07-22 03:00</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
            <tr><td>2025-07-22 02:00</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
            <tr><td>2025-07-22 01:00</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
          `;
        }

      } catch (error) {
        console.error("加载失败，使用模拟数据：", error);
        // 所有接口失败时确保显示模拟内容
        document.getElementById('advice').innerHTML = `
          <div class="p-3 bg-yellow-900/20 rounded">
            <h3 class="font-bold text-yellow-400">黄金建议（模拟）</h3>
            <p>操作：观望</p>
            <p>进场价：772.05</p>
            <p>止盈：787.49</p>
            <p>止损：756.61</p>
          </div>
          <div class="p-3 bg-gray-700 rounded">
            <h3 class="font-bold text-gray-300">白银建议（模拟）</h3>
            <p>操作：观望</p>
            <p>进场价：8.78</p>
            <p>止盈：8.95</p>
            <p>止损：8.60</p>
          </div>
        `;
      }
    }

    // 5. 初始化并加载数据
    window.onload = () => {
      // 确保DOM加载完成后初始化图表
      if (document.readyState === 'complete') {
        initCharts();
        loadAllData();
      } else {
        window.addEventListener('load', () => {
          initCharts();
          loadAllData();
        });
      }
      // 每5分钟刷新一次数据
      setInterval(loadAllData, 300000);
    };
  </script>
</body>
</html>
