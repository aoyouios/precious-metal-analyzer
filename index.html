<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆贵金属行情预测系统</title>
  <!-- 外部依赖（CDN引入，无需本地文件） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    .chart-container { height: 300px; }
    .sub-chart { height: 150px; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">聚宝盆贵金属行情预测系统</h1>

    <!-- 黄金图表区域（K线+分时+指标） -->
    <div class="bg-gray-800 rounded-lg p-4 mb-6">
      <h2 class="text-lg font-semibold mb-3">黄金专业图表</h2>
      <div class="chart-container" id="gold-candlestick"></div>
      <div class="flex gap-4 mt-4">
        <div class="flex-1 sub-chart" id="gold-line"></div>
        <div class="w-1/3 sub-chart" id="gold-macd"></div>
      </div>
      <div class="sub-chart mt-4" id="gold-rsi"></div>
    </div>

    <!-- 白银图表区域 -->
    <div class="bg-gray-800 rounded-lg p-4">
      <h2 class="text-lg font-semibold mb-3">白银专业图表</h2>
      <div class="chart-container" id="silver-candlestick"></div>
      <div class="flex gap-4 mt-4">
        <div class="flex-1 sub-chart" id="silver-line"></div>
        <div class="w-1/3 sub-chart" id="silver-macd"></div>
      </div>
      <div class="sub-chart mt-4" id="silver-rsi"></div>
    </div>
  </div>

  <script>
    // 后端API地址（替换为你的Cloudflare Workers地址）
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
    let goldCandlestick, goldLine, goldMACD, goldRSI;
    let silverCandlestick, silverLine, silverMACD, silverRSI;

    // 1. 初始化图表（必含K线图、分时图、指标）
    function initCharts() {
      // 黄金K线图（专业级配置）
      goldCandlestick = new Chart(document.getElementById('gold-candlestick'), {
        type: 'candlestick',
        data: { datasets: [] },
        options: {
          responsive: true,
          scales: {
            x: { type: 'time', time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } } }, // X轴时间
            y: { position: 'right', title: { display: true, text: '价格（元/克）' } } // Y轴价格
          }
        }
      });

      // 黄金分时图（收盘价曲线）
      goldLine = new Chart(document.getElementById('gold-line'), {
        type: 'line',
        data: { datasets: [] },
        options: { responsive: true, scales: { x: { type: 'time' }, y: { display: false } } }
      });

      // 黄金MACD指标
      goldMACD = new Chart(document.getElementById('gold-macd'), {
        type: 'line',
        data: { datasets: [] },
        options: { responsive: true, scales: { x: { display: false }, y: { display: false } } }
      });

      // 黄金RSI指标
      goldRSI = new Chart(document.getElementById('gold-rsi'), {
        type: 'line',
        data: { datasets: [] },
        options: { responsive: true, scales: { x: { display: false }, y: { min: 0, max: 100 } } }
      });

      // 白银图表（同黄金配置，确保对称布局）
      silverCandlestick = new Chart(document.getElementById('silver-candlestick'), { /* 同黄金 */ });
      silverLine = new Chart(document.getElementById('silver-line'), { /* 同黄金 */ });
      silverMACD = new Chart(document.getElementById('silver-macd'), { /* 同黄金 */ });
      silverRSI = new Chart(document.getElementById('silver-rsi'), { /* 同黄金 */ });
    }

    // 2. 加载历史数据并渲染图表（核心功能）
    async function loadCharts() {
      try {
        // 从后端获取历史数据（KV存储的OHLC数据）
        const res = await fetch(`${API_BASE}/history`);
        const history = await res.json();

        // 处理黄金数据（确保X/Y轴有值）
        if (history.gold.length > 0) {
          // K线图数据（OHLC）
          goldCandlestick.data.datasets = [{
            data: history.gold.map(item => ({
              x: new Date(item.t),
              o: item.o, h: item.h, l: item.l, c: item.c
            })),
            backgroundColor: ctx => ctx.raw.c >= ctx.raw.o ? 'rgba(0, 200, 0, 0.7)' : 'rgba(200, 0, 0, 0.7)' // 红绿K线
          }];

          // 分时图数据（收盘价连线）
          goldLine.data.datasets = [{
            data: history.gold.map(item => ({ x: new Date(item.t), y: item.c })),
            borderColor: '#00c8ff',
            fill: true
          }];

          // 计算MACD和RSI（指标数据）
          const closes = history.gold.map(item => item.c);
          if (closes.length >= 26) {
            const macd = calculateMACD(closes);
            goldMACD.data.datasets = [
              { data: macd.macd, borderColor: '#ffc800' },
              { data: macd.signal, borderColor: '#ff6384' },
              { data: macd.histogram, type: 'bar' }
            ];
          }
          if (closes.length >= 14) {
            goldRSI.data.datasets = [{ data: calculateRSI(closes), borderColor: '#c8ff00' }];
          }
        }

        // 白银数据处理（同黄金逻辑，确保功能一致）
        // ...

        // 更新所有图表
        goldCandlestick.update();
        goldLine.update();
        goldMACD.update();
        goldRSI.update();
      } catch (e) { console.error("图表加载失败：", e); }
    }

    // 3. 技术指标计算函数（MACD+RSI）
    function calculateMACD(prices) {
      const ema12 = prices.map((p, i) => i === 0 ? p : p * 2/13 + ema12[i-1] * 11/13);
      const ema26 = prices.map((p, i) => i === 0 ? p : p * 2/27 + ema26[i-1] * 25/27);
      const macd = ema12.map((v, i) => v - ema26[i]);
      const signal = macd.map((v, i) => i < 9 ? 0 : v * 2/10 + signal[i-1] * 8/10);
      return { macd, signal, histogram: macd.map((v, i) => v - signal[i]) };
    }

    function calculateRSI(prices) {
      const changes = prices.slice(1).map((p, i) => p - prices[i]);
      return changes.map((_, i) => {
        if (i < 13) return 50;
        const gains = changes.slice(i-13, i).filter(c => c > 0).reduce((a, b) => a + b, 0);
        const losses = Math.abs(changes.slice(i-13, i).filter(c => c < 0).reduce((a, b) => a + b, 0));
        return 100 - (100 / (1 + gains / (losses || 1)));
      });
    }

    // 4. 初始化并自动刷新
    window.onload = () => {
      initCharts();
      loadCharts();
      setInterval(loadCharts, 300000); // 每5分钟刷新数据
    };
  </script>
</body>
</html>
