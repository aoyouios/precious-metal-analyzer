<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>聚宝盆专业贵金属分析系统</title>
  <!-- 强制指定Chart.js版本，确保兼容性 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <!-- 单独加载金融图表插件和依赖 -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
  
  <style>
    .chart-container { 
      height: 300px; 
      margin: 10px 0; 
      position: relative;
    }
    .sub-chart { 
      height: 180px; 
      margin: 10px 0; 
      position: relative;
    }
    .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .history-table th, .history-table td { border: 1px solid #444; padding: 8px; text-align: left; }
    .chart-loading {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(30, 30, 30, 0.8);
      z-index: 10;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-6">聚宝盆专业贵金属分析系统</h1>

    <!-- 实时价格 -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div class="bg-gray-800 p-4 rounded">
        <h2>黄金价格</h2>
        <div class="text-3xl" id="gold-price">772.05</div>
        <div class="text-sm text-gray-400" id="gold-time">更新时间：2025/7/22 03:34:21</div>
      </div>
      <div class="bg-gray-800 p-4 rounded">
        <h2>白银价格</h2>
        <div class="text-3xl" id="silver-price">8.78</div>
        <div class="text-sm text-gray-400" id="silver-time">更新时间：2025/7/22 03:34:21</div>
      </div>
    </div>

    <!-- 黄金图表 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>黄金专业图表</h2>
      <div class="chart-container">
        <canvas id="gold-candlestick"></canvas>
        <div class="chart-loading" id="gold-candlestick-loading">
          加载K线图中...
        </div>
      </div>
      <div class="sub-chart">
        <canvas id="gold-line"></canvas>
        <div class="chart-loading" id="gold-line-loading">
          加载分时图中...
        </div>
      </div>
    </div>

    <!-- 白银图表 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>白银专业图表</h2>
      <div class="chart-container">
        <canvas id="silver-candlestick"></canvas>
        <div class="chart-loading" id="silver-candlestick-loading">
          加载K线图中...
        </div>
      </div>
      <div class="sub-chart">
        <canvas id="silver-line"></canvas>
        <div class="chart-loading" id="silver-line-loading">
          加载分时图中...
        </div>
      </div>
    </div>

    <!-- 操作建议 -->
    <div class="bg-gray-800 p-4 rounded mb-6">
      <h2>智能操作建议</h2>
      <div id="advice" class="p-3 bg-gray-700 rounded">
        <div>黄金：观望（当前价：772.05，止盈：787.49，止损：756.61）</div>
        <div>白银：观望（当前价：8.78，止盈：8.95，止损：8.60）</div>
      </div>
    </div>

    <!-- 历史对比 -->
    <div class="bg-gray-800 p-4 rounded">
      <h2>历史建议对比</h2>
      <div class="overflow-x-auto">
        <table class="history-table">
          <thead>
            <tr class="bg-gray-700">
              <th>时间</th>
              <th>黄金建议</th>
              <th>黄金结果</th>
              <th>白银建议</th>
              <th>白银结果</th>
            </tr>
          </thead>
          <tbody id="history-table-body">
            <tr><td>2025/7/22 10:34:20</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
            <tr><td>2025/7/22 09:34:20</td><td>观望</td><td>--</td><td>观望</td><td>--</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // 配置
    const API_BASE = "https://precious-metal-analyzer.aoyouios.workers.dev";
    let goldCandlestick, goldLineChart, silverCandlestick, silverLineChart;
    
    // 1. 生成默认K线数据
    function generateDefaultKlineData(type) {
      const base = type === 'gold' ? 772 : 8.78;
      const data = [];
      for (let i = 10; i >= 0; i--) {
        const c = +(base + (Math.random() - 0.5) * (type === 'gold' ? 2 : 0.2)).toFixed(2);
        data.push({
          t: Date.now() - i * 3600000,
          o: +(c - Math.random() * 0.1).toFixed(2),
          h: +(c + Math.random() * 0.1).toFixed(2),
          l: +(c - Math.random() * 0.15).toFixed(2),
          c: c
        });
      }
      return data;
    }

    // 2. 初始化K线图（使用基础Chart.js配置，确保兼容性）
    function initGoldCandlestick(data) {
      const ctx = document.getElementById('gold-candlestick').getContext('2d');
      goldCandlestick = new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: '黄金K线',
            data: data.map(item => ({
              x: new Date(item.t),
              o: item.o,
              h: item.h,
              l: item.l,
              c: item.c
            })),
            color: {
              up: 'rgb(255, 0, 0)',   // 上涨红色
              down: 'rgb(0, 255, 0)', // 下跌绿色
              unchanged: 'rgb(128, 128, 128)'
            },
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'HH:mm'
                }
              },
              title: {
                display: true,
                text: '时间'
              }
            },
            y: {
              title: {
                display: true,
                text: '价格（元/克）'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(2);
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const d = context.raw;
                  return [
                    `开盘: ${d.o.toFixed(2)}`,
                    `最高: ${d.h.toFixed(2)}`,
                    `最低: ${d.l.toFixed(2)}`,
                    `收盘: ${d.c.toFixed(2)}`
                  ];
                }
              }
            }
          }
        }
      });
      // 隐藏加载提示
      document.getElementById('gold-candlestick-loading').style.display = 'none';
    }

    // 3. 初始化黄金分时图
    function initGoldLineChart(data) {
      const ctx = document.getElementById('gold-line').getContext('2d');
      goldLineChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: '黄金价格',
            data: data.map(item => ({
              x: new Date(item.t),
              y: item.c
            })),
            borderColor: 'rgb(255, 215, 0)',
            backgroundColor: 'rgba(255, 215, 0, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'HH:mm'
                }
              }
            },
            y: {
              display: false
            }
          }
        }
      });
      document.getElementById('gold-line-loading').style.display = 'none';
    }

    // 4. 初始化白银K线图
    function initSilverCandlestick(data) {
      const ctx = document.getElementById('silver-candlestick').getContext('2d');
      silverCandlestick = new Chart(ctx, {
        type: 'candlestick',
        data: {
          datasets: [{
            label: '白银K线',
            data: data.map(item => ({
              x: new Date(item.t),
              o: item.o,
              h: item.h,
              l: item.l,
              c: item.c
            })),
            color: {
              up: 'rgb(255, 0, 0)',
              down: 'rgb(0, 255, 0)',
              unchanged: 'rgb(128, 128, 128)'
            },
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'HH:mm'
                }
              },
              title: {
                display: true,
                text: '时间'
              }
            },
            y: {
              title: {
                display: true,
                text: '价格（元/克）'
              },
              ticks: {
                callback: function(value) {
                  return value.toFixed(2);
                }
              }
            }
          }
        }
      });
      document.getElementById('silver-candlestick-loading').style.display = 'none';
    }

    // 5. 初始化白银分时图
    function initSilverLineChart(data) {
      const ctx = document.getElementById('silver-line').getContext('2d');
      silverLineChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: '白银价格',
            data: data.map(item => ({
              x: new Date(item.t),
              y: item.c
            })),
            borderColor: 'rgb(192, 192, 192)',
            backgroundColor: 'rgba(192, 192, 192, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'HH:mm'
                }
              }
            },
            y: {
              display: false
            }
          }
        }
      });
      document.getElementById('silver-line-loading').style.display = 'none';
    }

    // 6. 加载并显示图表
    async function loadCharts() {
      try {
        // 先使用默认数据初始化图表（确保必显）
        const goldDefaultData = generateDefaultKlineData('gold');
        const silverDefaultData = generateDefaultKlineData('silver');
        
        initGoldCandlestick(goldDefaultData);
        initGoldLineChart(goldDefaultData);
        initSilverCandlestick(silverDefaultData);
        initSilverLineChart(silverDefaultData);

        // 再尝试加载真实数据
        const response = await fetch(`${API_BASE}/history`);
        if (response.ok) {
          const historyData = await response.json();
          
          // 更新黄金图表
          if (historyData.gold && historyData.gold.length > 0) {
            goldCandlestick.data.datasets[0].data = historyData.gold.map(item => ({
              x: new Date(item.t),
              o: item.o,
              h: item.h,
              l: item.l,
              c: item.c
            }));
            goldCandlestick.update();
            
            goldLineChart.data.datasets[0].data = historyData.gold.map(item => ({
              x: new Date(item.t),
              y: item.c
            }));
            goldLineChart.update();
          }

          // 更新白银图表
          if (historyData.silver && historyData.silver.length > 0) {
            silverCandlestick.data.datasets[0].data = historyData.silver.map(item => ({
              x: new Date(item.t),
              o: item.o,
              h: item.h,
              l: item.l,
              c: item.c
            }));
            silverCandlestick.update();
            
            silverLineChart.data.datasets[0].data = historyData.silver.map(item => ({
              x: new Date(item.t),
              y: item.c
            }));
            silverLineChart.update();
          }
        }
      } catch (error) {
        console.error("图表加载错误：", error);
        // 即使出错，也已显示默认图表
      }
    }

    // 页面加载完成后立即执行
    window.onload = () => {
      // 优先加载图表
      loadCharts();
    };
  </script>
</body>
</html>
